# PT-10 一种支持多模式撤销的分布式会话令牌吊销系统及传播时间界定方法

**专利编号**: PT-10
**技术领域**: 会话生命周期管理
**创新性评估**: 高
**关联文档**: RQ-0102
**状态**: 草稿
**创建日期**: 2025-12-18

---

## 一、技术领域

本发明涉及分布式系统安全技术领域，具体涉及一种支持多模式撤销的分布式会话令牌吊销系统及传播时间界定方法，适用于需要在分布式环境中实现会话撤销的身份认证系统。

---

## 二、背景技术

### 2.1 现有技术描述

在分布式会话管理系统中，会话撤销（如用户登出、管理员强制下线）是常见操作。现有的撤销方案包括：

1. **中心化撤销**：所有节点向中心服务查询撤销状态
2. **黑名单机制**：维护已撤销令牌的黑名单
3. **短期令牌**：使用短TTL令牌，定期刷新

### 2.2 现有技术的缺陷

1. **中心化撤销的问题**：
   - 中心服务成为性能瓶颈
   - 单点故障风险
   - 网络延迟影响验证速度

2. **黑名单机制的问题**：
   - 黑名单同步延迟不可控
   - 存储开销随时间增长
   - 分布式环境下一致性难保证

3. **缺乏一致性承诺**：
   - 撤销传播时间不确定
   - 安全审计缺乏时间依据
   - 用户无法知道撤销何时生效

4. **一刀切的设计**：
   - 所有场景使用同一撤销策略
   - 无法根据安全等级选择一致性级别
   - 性能与安全难以平衡

---

## 三、发明内容

### 3.1 要解决的技术问题

本发明要解决的技术问题是：如何在分布式环境中提供多种撤销模式供业务选择，并对撤销传播时间提供可观测、可承诺的界定。

### 3.2 技术方案

本发明提供一种支持多模式撤销的分布式会话令牌吊销系统及传播时间界定方法，包括：

#### 3.2.1 双模式设计

**模式A：最终一致性撤销**
```
特点:
- 立即返回，异步传播
- 传播窗口 P99 ≤ 2s
- 适用于普通登出场景

流程:
1. 客户端发起撤销请求
2. 本地节点立即删除会话
3. 发布撤销事件到 Gossip 网络
4. 异步传播到所有节点
5. 立即返回成功响应
```

**模式B：强一致性撤销**
```
特点:
- 等待多数节点确认
- RPO = 0（无数据丢失风险）
- 适用于安全敏感场景

流程:
1. 客户端发起撤销请求
2. 本地节点记录撤销意图
3. 通过 Raft 共识复制到多数节点
4. 多数节点确认后提交
5. 返回成功响应
```

#### 3.2.2 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端请求                              │
│  POST /sessions/{id}/revoke                                 │
│  Header: X-Revoke-Mode: eventual | strong                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    撤销模式路由器                            │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  根据 X-Revoke-Mode 头选择撤销模式                   │   │
│  │  默认: eventual (最终一致性)                         │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
┌─────────────────────────┐     ┌─────────────────────────┐
│   模式A: 最终一致性      │     │   模式B: 强一致性        │
│                         │     │                         │
│  1. 本地删除会话         │     │  1. 记录撤销意图         │
│  2. 发布 Gossip 事件    │     │  2. Raft 提议           │
│  3. 立即返回成功         │     │  3. 等待多数确认         │
│                         │     │  4. 提交后返回           │
│  传播窗口: P99 ≤ 2s     │     │  延迟: ~RTT × 2         │
└─────────────────────────┘     └─────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    传播时间监控                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - 记录撤销事件发起时间                               │   │
│  │  - 收集各节点收到事件的时间                           │   │
│  │  - 计算传播延迟分布                                   │   │
│  │  - 暴露 P50/P90/P99 指标                             │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.3 最终一致性撤销（模式A）详细流程

```
┌─────────────────────────────────────────────────────────────┐
│                      发起节点                                │
└─────────────────────────────────────────────────────────────┘
       │
       │ 1. 接收撤销请求
       ▼
┌─────────────────────────────────────────────────────────────┐
│  本地处理:                                                   │
│  - 删除本地会话数据                                          │
│  - 删除令牌哈希索引                                          │
│  - 记录撤销时间戳                                            │
└─────────────────────────────────────────────────────────────┘
       │
       │ 2. 发布撤销事件
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Gossip 事件:                                                │
│  {                                                          │
│    "type": "SESSION_REVOKED",                               │
│    "session_id": "tms-xxx",                                 │
│    "revoked_at": "2025-01-01T00:00:00Z",                   │
│    "source_node": "node-1",                                 │
│    "propagation_id": "uuid"  // 用于追踪传播                 │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
       │
       │ 3. Gossip 传播
       ▼
┌─────────────────────────────────────────────────────────────┐
│                    Gossip 网络传播                           │
│                                                             │
│  Node 1 ──► Node 2, Node 3 (随机选择)                       │
│  Node 2 ──► Node 4, Node 5                                  │
│  Node 3 ──► Node 6, Node 7                                  │
│  ...                                                        │
│                                                             │
│  传播轮次: ~log(N)，N为节点数                                │
│  预期时间: 200ms × log(N) ≈ 1-2s                            │
└─────────────────────────────────────────────────────────────┘
       │
       │ 4. 各节点处理
       ▼
┌─────────────────────────────────────────────────────────────┐
│  每个节点收到事件后:                                         │
│  - 检查本地是否有该会话                                      │
│  - 有则删除会话和索引                                        │
│  - 记录传播延迟指标                                          │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.4 强一致性撤销（模式B）详细流程

```
┌─────────────────────────────────────────────────────────────┐
│                      发起节点                                │
└─────────────────────────────────────────────────────────────┘
       │
       │ 1. 接收撤销请求 (mode=strong)
       ▼
┌─────────────────────────────────────────────────────────────┐
│  构建撤销命令:                                               │
│  RevokeCommand {                                            │
│    session_id: "tms-xxx",                                   │
│    revoked_at: timestamp,                                   │
│    reason: "user_logout",                                   │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
       │
       │ 2. 提交到 Raft
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Raft 共识流程:                                              │
│                                                             │
│  Leader ──► 追加日志条目                                     │
│         ──► 复制到 Follower                                 │
│         ◄── Follower 确认                                   │
│         ──► 多数确认后提交                                   │
│         ──► 应用到状态机                                     │
└─────────────────────────────────────────────────────────────┘
       │
       │ 3. 应用撤销
       ▼
┌─────────────────────────────────────────────────────────────┐
│  所有 Voter 节点:                                            │
│  - 从 Raft 日志获取撤销命令                                  │
│  - 删除会话数据                                              │
│  - 删除令牌索引                                              │
│  - 持久化撤销记录                                            │
└─────────────────────────────────────────────────────────────┘
       │
       │ 4. 返回成功
       ▼
┌─────────────────────────────────────────────────────────────┐
│  返回响应:                                                   │
│  {                                                          │
│    "success": true,                                         │
│    "mode": "strong",                                        │
│    "confirmed_nodes": 3,                                    │
│    "latency_ms": 45                                         │
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.5 传播时间界定

**监控指标定义**：
```
revoke_propagation_seconds{mode="eventual", quantile="0.50"}  # P50
revoke_propagation_seconds{mode="eventual", quantile="0.90"}  # P90
revoke_propagation_seconds{mode="eventual", quantile="0.99"}  # P99

revoke_strong_latency_seconds{quantile="0.50"}  # 强一致性模式延迟
revoke_strong_latency_seconds{quantile="0.99"}
```

**SLA承诺**：
| 模式 | 指标 | SLA目标 |
|------|------|---------|
| 最终一致性 | 传播延迟P99 | ≤ 2s |
| 最终一致性 | 传播成功率 | ≥ 99.9% |
| 强一致性 | 确认延迟P99 | ≤ 100ms (局域网) |
| 强一致性 | 确认成功率 | ≥ 99.99% |

**传播追踪**：
```
每个撤销事件携带 propagation_id:

1. 发起节点记录:
   - propagation_id
   - initiate_time

2. 接收节点记录:
   - propagation_id
   - receive_time
   - source_node

3. 汇总计算:
   - propagation_delay = receive_time - initiate_time
   - 聚合为 P50/P90/P99 指标
```

### 3.3 有益效果

1. **灵活选择**：
   - 业务可根据安全等级选择撤销模式
   - 普通场景用最终一致性保证性能
   - 敏感场景用强一致性保证安全

2. **可观测承诺**：
   - 传播时间有明确的SLA指标
   - P99 ≤ 2s 的承诺可验证
   - 便于安全审计

3. **性能与安全平衡**：
   - 最终一致性模式：立即返回，高吞吐
   - 强一致性模式：等待确认，高可靠

4. **审计友好**：
   - 撤销事件可追踪
   - 传播延迟可监控
   - 异常可告警

---

## 四、具体实施方式

### 4.1 实施例1：撤销模式路由

```go
type RevokeMode string

const (
    RevokeModeEventual RevokeMode = "eventual"
    RevokeModeStrong   RevokeMode = "strong"
)

type RevokeRequest struct {
    SessionID string
    Mode      RevokeMode
    Reason    string
}

type RevokeService struct {
    eventualRevoker *EventualRevoker
    strongRevoker   *StrongRevoker
}

func (s *RevokeService) Revoke(req *RevokeRequest) (*RevokeResponse, error) {
    switch req.Mode {
    case RevokeModeEventual:
        return s.eventualRevoker.Revoke(req)
    case RevokeModeStrong:
        return s.strongRevoker.Revoke(req)
    default:
        // 默认使用最终一致性
        return s.eventualRevoker.Revoke(req)
    }
}
```

### 4.2 实施例2：最终一致性撤销

```go
type EventualRevoker struct {
    sessionStore *SessionStore
    gossip       *GossipMemberlist
    metrics      *RevokeMetrics
}

func (r *EventualRevoker) Revoke(req *RevokeRequest) (*RevokeResponse, error) {
    propagationID := uuid.New().String()
    revokedAt := time.Now()

    // 1. 本地删除
    if err := r.sessionStore.Delete(req.SessionID); err != nil {
        return nil, err
    }

    // 2. 发布 Gossip 事件
    event := &RevokeEvent{
        Type:          "SESSION_REVOKED",
        SessionID:     req.SessionID,
        RevokedAt:     revokedAt,
        PropagationID: propagationID,
        SourceNode:    r.gossip.LocalNode().Name,
        Reason:        req.Reason,
    }

    r.gossip.BroadcastEvent(event)

    // 3. 记录指标
    r.metrics.RevokeInitiated(propagationID, revokedAt)

    // 4. 立即返回
    return &RevokeResponse{
        Success:       true,
        Mode:          RevokeModeEventual,
        PropagationID: propagationID,
        Note:          "撤销已发起，预计2秒内全局生效",
    }, nil
}

// 接收端处理
func (r *EventualRevoker) HandleRevokeEvent(event *RevokeEvent) {
    receiveTime := time.Now()

    // 删除本地会话
    r.sessionStore.Delete(event.SessionID)

    // 记录传播延迟
    propagationDelay := receiveTime.Sub(event.RevokedAt)
    r.metrics.RecordPropagationDelay(event.PropagationID, propagationDelay)
}
```

### 4.3 实施例3：强一致性撤销

```go
type StrongRevoker struct {
    raft         *RaftNode
    sessionStore *SessionStore
    metrics      *RevokeMetrics
}

func (r *StrongRevoker) Revoke(req *RevokeRequest) (*RevokeResponse, error) {
    startTime := time.Now()

    // 1. 构建命令
    cmd := &RevokeCommand{
        SessionID: req.SessionID,
        RevokedAt: startTime,
        Reason:    req.Reason,
    }

    // 2. 提交到 Raft
    data, _ := proto.Marshal(cmd)
    future := r.raft.Apply(data, 5*time.Second)

    if err := future.Error(); err != nil {
        return nil, fmt.Errorf("Raft共识失败: %w", err)
    }

    // 3. 记录延迟
    latency := time.Since(startTime)
    r.metrics.RecordStrongRevokeLatency(latency)

    // 4. 返回确认
    return &RevokeResponse{
        Success:        true,
        Mode:           RevokeModeStrong,
        ConfirmedNodes: r.raft.GetVoterCount(),
        LatencyMs:      latency.Milliseconds(),
    }, nil
}

// Raft 状态机应用
func (r *StrongRevoker) ApplyRevokeCommand(cmd *RevokeCommand) error {
    // 删除会话（所有 Voter 节点都会执行）
    return r.sessionStore.Delete(cmd.SessionID)
}
```

### 4.4 实施例4：传播监控

```go
type RevokeMetrics struct {
    propagationDelay prometheus.Histogram
    strongLatency    prometheus.Histogram
    revokeTotal      prometheus.Counter
    propagationLog   map[string]*PropagationRecord
    mu               sync.RWMutex
}

type PropagationRecord struct {
    PropagationID string
    InitiateTime  time.Time
    ReceiveTimes  map[string]time.Time  // nodeID -> receiveTime
}

func NewRevokeMetrics() *RevokeMetrics {
    return &RevokeMetrics{
        propagationDelay: prometheus.NewHistogram(prometheus.HistogramOpts{
            Name:    "revoke_propagation_seconds",
            Help:    "撤销事件传播延迟",
            Buckets: []float64{0.1, 0.5, 1, 2, 5, 10},
        }),
        strongLatency: prometheus.NewHistogram(prometheus.HistogramOpts{
            Name:    "revoke_strong_latency_seconds",
            Help:    "强一致性撤销延迟",
            Buckets: []float64{0.01, 0.05, 0.1, 0.5, 1},
        }),
        propagationLog: make(map[string]*PropagationRecord),
    }
}

func (m *RevokeMetrics) RevokeInitiated(propagationID string, initiateTime time.Time) {
    m.mu.Lock()
    defer m.mu.Unlock()

    m.propagationLog[propagationID] = &PropagationRecord{
        PropagationID: propagationID,
        InitiateTime:  initiateTime,
        ReceiveTimes:  make(map[string]time.Time),
    }
}

func (m *RevokeMetrics) RecordPropagationDelay(propagationID string, delay time.Duration) {
    m.propagationDelay.Observe(delay.Seconds())
}

// 定期清理过期记录
func (m *RevokeMetrics) Cleanup() {
    m.mu.Lock()
    defer m.mu.Unlock()

    threshold := time.Now().Add(-1 * time.Hour)
    for id, record := range m.propagationLog {
        if record.InitiateTime.Before(threshold) {
            delete(m.propagationLog, id)
        }
    }
}
```

---

## 五、权利要求书

### 权利要求1（独立权利要求 - 系统）

一种支持多模式撤销的分布式会话令牌吊销系统，其特征在于，包括：

**撤销模式路由模块**，用于根据请求参数选择撤销模式，所述撤销模式包括最终一致性模式和强一致性模式；

**最终一致性撤销模块**，用于执行最终一致性撤销：
- 在本地节点立即删除会话数据；
- 通过Gossip协议向其他节点广播撤销事件；
- 立即向客户端返回成功响应；

**强一致性撤销模块**，用于执行强一致性撤销：
- 将撤销命令提交到Raft共识协议；
- 等待多数节点确认后提交；
- 向客户端返回确认响应；

**传播监控模块**，用于监控撤销事件的传播延迟，计算并暴露P50、P90、P99等分位数指标。

### 权利要求2（从属权利要求）

根据权利要求1所述的系统，其特征在于，所述最终一致性撤销模块的传播延迟P99目标为2秒以内。

### 权利要求3（从属权利要求）

根据权利要求1所述的系统，其特征在于，所述撤销事件携带传播追踪标识，用于计算从发起到各节点接收的传播延迟。

### 权利要求4（从属权利要求）

根据权利要求1所述的系统，其特征在于，所述撤销模式路由模块通过HTTP请求头指定撤销模式，默认使用最终一致性模式。

### 权利要求5（独立权利要求 - 方法）

一种分布式会话令牌吊销的传播时间界定方法，其特征在于，包括以下步骤：

**S1：模式选择步骤**，根据请求参数选择最终一致性模式或强一致性模式；

**S2-A：最终一致性执行步骤**（当选择最终一致性模式时）：
- S2-A1：在本地节点删除会话数据；
- S2-A2：生成携带传播追踪标识的撤销事件；
- S2-A3：通过Gossip协议广播撤销事件；
- S2-A4：立即返回成功响应；

**S2-B：强一致性执行步骤**（当选择强一致性模式时）：
- S2-B1：构建撤销命令；
- S2-B2：通过Raft共识协议复制到多数节点；
- S2-B3：多数节点确认后提交并应用；
- S2-B4：返回确认响应；

**S3：传播监控步骤**：
- 记录撤销事件发起时间；
- 记录各节点接收事件的时间；
- 计算传播延迟并更新分位数指标。

### 权利要求6（从属权利要求）

根据权利要求5所述的方法，其特征在于，所述步骤S2-A3中的Gossip广播采用随机传播策略，预期传播轮次为log(N)，N为节点数。

### 权利要求7（从属权利要求）

根据权利要求5所述的方法，其特征在于，所述步骤S3中计算的传播延迟包括P50、P90、P99分位数，并对外提供SLA承诺。

---

## 六、说明书附图

### 图1：双模式撤销对比图

```
┌─────────────────────────────────────────────────────────────┐
│                    模式A: 最终一致性撤销                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  时间线:                                                     │
│  ─────────────────────────────────────────────────────────► │
│  T0        T0+5ms              T0+2s (P99)                 │
│  │           │                    │                        │
│  │ 请求      │ 返回成功            │ 全局生效               │
│  │ ────────► │                    │                        │
│  │           │                    │                        │
│  │  ┌────────┴────────┐          │                        │
│  │  │ Gossip 异步传播  │──────────┘                        │
│  │  └─────────────────┘                                    │
│                                                             │
│  特点:                                                       │
│  ✓ 低延迟响应 (~5ms)                                        │
│  ✓ 高吞吐量                                                  │
│  △ 传播窗口内可能存在不一致                                  │
│  适用: 普通登出、会话过期清理                                │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                    模式B: 强一致性撤销                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  时间线:                                                     │
│  ─────────────────────────────────────────────────────────► │
│  T0                    T0+50ms (P99)                       │
│  │                        │                                │
│  │ 请求                   │ 返回成功 (所有 Voter 已删除)   │
│  │ ───────────────────────│                                │
│  │                        │                                │
│  │  ┌─────────────────────┘                                │
│  │  │ Raft 共识 (Leader → Followers → Commit)             │
│  │  └─────────────────────────────────────────            │
│                                                             │
│  特点:                                                       │
│  ✓ 返回时已全局生效                                          │
│  ✓ RPO = 0                                                  │
│  △ 延迟较高 (~50ms)                                         │
│  适用: 安全敏感操作、强制下线、密钥撤销                       │
└─────────────────────────────────────────────────────────────┘
```

### 图2：传播时间监控示意图

```
┌─────────────────────────────────────────────────────────────┐
│                    传播延迟分布                              │
│                                                             │
│  延迟(ms)                                                    │
│  2000 ┤                                           ┌──┐      │
│       │                                           │  │ P99  │
│  1500 ┤                                    ┌──────┤  │      │
│       │                                    │      │  │      │
│  1000 ┤                             ┌──────┤      │  │      │
│       │                             │      │      │  │      │
│   500 ┤      ┌──────────────────────┤      │      │  │      │
│       │      │                      │      │      │  │      │
│   200 ┤──────┤                      │      │      │  │      │
│       │      │                      │      │      │  │      │
│     0 └──────┴──────────────────────┴──────┴──────┴──┴──────│
│        P10   P50                    P75    P90    P99       │
│                                                             │
│  SLA 目标: P99 ≤ 2000ms ✓                                   │
└─────────────────────────────────────────────────────────────┘

监控指标:
┌─────────────────────────────────────────────────────────────┐
│ revoke_propagation_seconds{quantile="0.50"} = 0.2           │
│ revoke_propagation_seconds{quantile="0.90"} = 1.0           │
│ revoke_propagation_seconds{quantile="0.99"} = 1.8           │
│                                                             │
│ revoke_strong_latency_seconds{quantile="0.50"} = 0.03       │
│ revoke_strong_latency_seconds{quantile="0.99"} = 0.08       │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、摘要

本发明公开了一种支持多模式撤销的分布式会话令牌吊销系统及传播时间界定方法。该系统提供两种撤销模式：最终一致性模式在本地立即删除会话后通过Gossip协议异步传播，立即返回响应，传播延迟P99≤2秒；强一致性模式将撤销命令通过Raft共识协议复制到多数节点确认后才返回，保证RPO=0。系统通过传播追踪标识监控撤销事件的传播延迟，计算并暴露P50/P90/P99分位数指标，提供可观测、可验证的SLA承诺。本发明解决了传统撤销方案中一致性不可控、传播时间不确定的问题，使业务可根据安全等级灵活选择撤销模式，平衡性能与安全。

**关键词**：会话撤销；多模式；最终一致性；强一致性；传播时间界定

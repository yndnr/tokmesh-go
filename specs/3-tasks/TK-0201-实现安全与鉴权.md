# TK-0201-实现安全与鉴权

**状态**: ✅ 已完成 (覆盖率 85.5%)
**优先级**: P0
**范围**: 安全域 - API Key 管理与鉴权实现
**关联需求**: `specs/1-requirements/RQ-0201-安全与鉴权体系.md`
**关联设计**: `specs/2-designs/DS-0201-安全与鉴权设计.md`, `specs/2-designs/DS-0103-核心服务层设计.md`
**关联决策**: `specs/adrs/AD-0201-自适应加密算法决策.md`
**目标代码**: `internal/core/domain/apikey.go`, `internal/core/service/auth.go`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现完整的安全与鉴权体系，包括：
- API Key 完整数据模型（结构体、验证、生命周期）
- Argon2id 密码哈希与验证
- 密钥轮转（宽限期机制）
- 验证缓存（LRU + TTL）
- IP 白名单检查（CIDR 匹配）
- 速率限制（令牌桶算法）

## 2. 实施内容

### 2.1 APIKey 完整模型 (`internal/core/domain/apikey.go`)

> **单一事实来源**: `specs/2-designs/DS-0201-安全与鉴权设计.md` 第 2.1 节

```go
// APIKey 代表一个 API 访问密钥实体
type APIKey struct {
    KeyID           string            `json:"key_id"`            // tmak-xxxxxxxxxx
    SecretHash      string            `json:"-"`                 // Argon2id 哈希值
    OldSecretHash   string            `json:"-"`                 // 轮转时的旧 Secret 哈希
    GracePeriodEnd  int64             `json:"grace_period_end"`  // 宽限期结束时间 (Unix MS)
    Role            Role              `json:"role"`              // admin/issuer/validator/metrics
    Allowedlist     []string          `json:"allowedlist"`       // IP/CIDR 允许名单
    RateLimit       int               `json:"rate_limit"`        // QPS 限制
    ExpiresAt       int64             `json:"expires_at"`        // 绝对过期时间 (Unix MS)
    Status          KeyStatus         `json:"status"`            // active/disabled
    Description     string            `json:"description"`       // 描述信息
    CreatedAt       int64             `json:"created_at"`        // 创建时间 (Unix MS)
    CreatedBy       string            `json:"created_by"`        // 创建者的 API Key ID
    LastUsed        int64             `json:"last_used"`         // 最后使用时间 (Unix MS)
    Version         uint64            `json:"version"`           // 版本号（乐观锁）
}
```

实现要点：
- [ ] APIKey 结构体定义（完整字段）
- [ ] NewAPIKey() 构造函数（生成 tmak-xxx ID + tmas_xxx Secret）
- [ ] IsExpired() 过期检查
- [ ] IsDisabled() 状态检查
- [ ] InGracePeriod() 宽限期检查
- [ ] Validate() 字段约束验证

### 2.2 密钥生成 (`internal/core/service/apikey.go`)

```go
// GenerateKeyPair 生成 API Key 对
func GenerateKeyPair() (keyID string, secret string, err error) {
    // 1. KeyID: tmak- + 26 字符小写 ULID（总长 31；见 RQ-0101）
    // 2. Secret: tmas_ + 32 字节随机数（Base62 编码；总长约 48；见 RQ-0101/RQ-0201）
}

// HashSecret 使用 Argon2id 哈希 Secret
func HashSecret(secret string) (string, error) {
    // 使用 pkg/crypto/adaptive 的自适应加密
    // 参数: memory=16MB, iterations=2, parallelism=2
}

// VerifySecret 验证 Secret 与哈希
func VerifySecret(hash, secret string) bool
```

### 2.3 验证缓存 (`internal/core/service/auth.go`)

> **单一事实来源**: `specs/2-designs/DS-0103-核心服务层设计.md` 第 5 章

```go
type AuthCache struct {
    cache    *lru.Cache[string, *CachedAuth]
    mu       sync.RWMutex
    capacity int           // 默认 10,000
    ttl      time.Duration // 默认 60s
}

type CachedAuth struct {
    KeyMeta   *APIKeyMeta
    ExpiresAt time.Time
}

func (c *AuthCache) Get(cacheKey string) (*CachedAuth, bool)
func (c *AuthCache) Set(cacheKey string, auth *CachedAuth)
func (c *AuthCache) Invalidate(keyID string)
```

实现要点：
- [ ] LRU 缓存（容量 10,000）
- [ ] TTL 过期（60 秒）
- [ ] 缓存 Key = SHA256(keyID + secret)
- [ ] 主动失效（Key 禁用/删除时调用）

### 2.4 IP 白名单检查

```go
// CheckIPAllowed 检查客户端 IP 是否在白名单内
func CheckIPAllowed(allowedlist []string, clientIP string) error {
    // 1. 空白名单 -> 允许所有
    // 2. 解析 CIDR（支持 IPv4/IPv6）
    // 3. 逐条匹配
    // 4. 无匹配 -> 返回 TM-AUTH-4031
}
```

### 2.5 速率限制

```go
type RateLimiter struct {
    limiters sync.Map // map[keyID]*rate.Limiter
}

func (r *RateLimiter) Check(keyID string, limit int) error {
    // 令牌桶算法
    // 超限返回 TM-SYS-4290 + Retry-After
}
```

### 2.6 密钥轮转流程

```go
func (s *AuthService) RotateKey(ctx context.Context, keyID string) (*RotateKeyResponse, error) {
    // 1. 生成新 Secret
    // 2. OldSecretHash = 当前 SecretHash
    // 3. SecretHash = Hash(新 Secret)
    // 4. GracePeriodEnd = now() + 宽限期（默认 1h；以 security.auth.rotation_grace 为准）
    // 5. Version++
    // 6. 写入存储
    // 7. 返回新 Secret（仅此时返回）
}
```

## 3. 验收标准

### 3.1 功能验收
- [ ] API Key 生成格式正确（tmak-xxx, tmas_xxx）
- [ ] Argon2id 哈希/验证正确
- [ ] 验证缓存命中时跳过 Argon2（性能提升）
- [ ] 缓存失效机制生效
- [ ] IP 白名单拦截/放行正确（IPv4 + IPv6）
- [ ] 速率限制正确（超限返回 429）
- [ ] 密钥轮转宽限期机制正确（新旧 Secret 均可用）

### 3.1.1 可测试验收用例（Given/When/Then）
- [ ] Given 新建 Key When 返回响应 Then 仅本次包含 `key_secret`，后续查询/列表均不包含
- [ ] Given 缓存未命中 When Authenticate(keyID,secret) Then 执行 Argon2 verify 且写入缓存（TTL=60s）
- [ ] Given 缓存命中 When Authenticate(keyID,secret) Then 不执行 Argon2 verify（可通过计数器/桩函数断言）
- [ ] Given Key 被禁用 When Authenticate Then 返回 `TM-AUTH-4012` 且对应缓存条目失效
- [ ] Given Key 过期 When Authenticate Then 返回 `TM-AUTH-4011`（或明确的过期码；需与 `error-codes.md` 对齐）且缓存不写入成功结果
- [ ] Given 配置了 allowedlist 且来源 IP 不匹配 When 请求鉴权 Then 返回 `TM-AUTH-4031`
- [ ] Given Rotate 触发 When 在 `security.auth.rotation_grace` 窗口内 Then 新旧 secret 均可通过鉴权；窗口结束后旧 secret 失败

### 3.2 安全验收
- [ ] Secret 仅在生成/轮转时返回一次
- [ ] SecretHash 不在任何响应中返回
- [ ] 日志中 Secret 自动脱敏

### 3.3 性能验收
- [ ] 缓存命中时验证延迟 < 0.5ms
- [ ] 缓存未命中时 Argon2 验证延迟 < 100ms
- [ ] 缓存命中率 > 95%（稳定负载下）

### 3.4 测试落点建议（最小集）
- 单元测试：`internal/core/service/auth_service_test.go`（Argon2 参数读取、缓存命中/未命中、禁用/过期、轮转宽限期）
- 单元测试：`internal/core/service/ip_allowlist_test.go`（IPv4/IPv6/CIDR 解析与交集逻辑）
- 单元测试：`internal/core/service/rate_limiter_test.go`（Retry-After 计算与 429）
- 集成测试：HTTP 中间件鉴权链（AuthN→RateLimit→Audit）与错误码/HTTP 状态码一致性

## 4. 依赖

- `internal/core/domain/` - 领域模型（TK-0101 提供 Role/KeyStatus 枚举）
- `pkg/crypto/adaptive/` - 自适应加密（Argon2id）
- `golang.org/x/time/rate` - 令牌桶限流

## 5. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `security.auth.allow_list` | `[]` | 全局来源 IP allow_list；与单 Key `allowedlist` 取交集（来源 IP 口径受 `security.network.trusted_proxies` 影响） |
| `security.auth.cache_capacity` | `10000` | 验证缓存容量 |
| `security.auth.cache_ttl` | `60s` | 缓存 TTL |
| `security.auth.argon2.memory` | `16384` | Argon2 内存（单位 KB） |
| `security.auth.argon2.iterations` | `2` | Argon2 迭代次数 |
| `security.auth.argon2.parallelism` | `2` | Argon2 并行度 |
| `security.auth.rotation_grace` | `1h` | 轮转宽限期 |
| `security.network.trusted_proxies` | `[]` | 可信代理 CIDR；非空时才读取 `Forwarded`/`X-Forwarded-For` 解析 client_ip（影响 allow_list/审计/限流） |
| `security.storage.wal_encryption_key` | `""` | WAL/快照加密密钥材料（32B hex=64字符）；为空表示不启用或使用默认策略（以 RQ/DS 为准） |

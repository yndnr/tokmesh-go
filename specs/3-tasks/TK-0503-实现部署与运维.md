# TK-0503-实现部署与运维

**状态**: 草稿
**优先级**: P2
**范围**: 部署脚本、服务管理、容器化
**关联需求**: `specs/1-requirements/RQ-0501-部署与交付需求.md`
**关联设计**: `specs/2-designs/DS-0501-部署与运维设计.md`
**目标代码**: `deployments/`, `scripts/`, `Dockerfile`

> **代码骨架对齐（强制）**：本文涉及 `src/` / `internal/` 等代码目录路径时，均以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准；部署/交付类目录结构以 `specs/2-designs/DS-0501-部署与运维设计.md` 为准。

---

## 1. 目标

实现 TokMesh 的部署与运维支持：
- Linux systemd 服务单元
- Windows Service 集成
- Docker 容器镜像
- Kubernetes 部署清单
- 安装/卸载脚本

## 2. 任务分解

### 2.1 Linux 部署

#### 2.1.1 systemd 服务单元 (`deployments/linux/tokmesh-server.service`)

```ini
[Unit]
Description=TokMesh Server (Session/Token Cache Service)
After=network.target

[Service]
Type=simple
User=tokmesh
Group=tokmesh
ExecStart=/usr/local/bin/tokmesh-server --config /etc/tokmesh-server/config.yaml
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=65535
RuntimeDirectory=tokmesh-server
RuntimeDirectoryMode=0750

# 安全加固
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/tokmesh-server /var/run/tokmesh-server

[Install]
WantedBy=multi-user.target
```

**验收标准**:
- [ ] `systemctl start tokmesh-server` 成功启动
- [ ] `systemctl reload tokmesh-server` 触发热加载
- [ ] 崩溃后自动重启 (RestartSec=5)
- [ ] 安全加固生效 (NoNewPrivileges, ProtectSystem)

#### 2.1.2 安装脚本 (`scripts/install-linux.sh`)

```bash
#!/bin/bash
# 功能:
# 1. 检测系统环境 (Debian/RHEL)
# 2. 创建 tokmesh 用户/组
# 3. 安装二进制文件
# 4. 安装配置文件模板
# 5. 注册 systemd 服务
# 6. 设置目录权限

set -euo pipefail

INSTALL_DIR="/usr/local/bin"
CONFIG_DIR="/etc/tokmesh-server"
DATA_DIR="/var/lib/tokmesh-server"
RUN_DIR="/var/run/tokmesh-server"

# 创建用户
useradd --system --no-create-home \
    --home-dir "$DATA_DIR" \
    --shell /usr/sbin/nologin \
    tokmesh || true

# 安装二进制
install -m 0755 tokmesh-server "$INSTALL_DIR/"
install -m 0755 tokmesh-cli "$INSTALL_DIR/"

# 创建目录
install -d -o root   -g tokmesh -m 0750 "$CONFIG_DIR"
install -d -o tokmesh -g tokmesh -m 0750 "$DATA_DIR"
install -d -o tokmesh -g tokmesh -m 0750 "$DATA_DIR/wal"
install -d -o tokmesh -g tokmesh -m 0750 "$DATA_DIR/snapshots"

# 安装配置
install -o root -g tokmesh -m 0640 config.yaml "$CONFIG_DIR/"

# 安装 systemd 服务
install -m 0644 tokmesh-server.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable tokmesh-server
```

**验收标准**:
- [ ] 脚本幂等执行
- [ ] 目录权限正确
- [ ] 服务自启动注册

#### 2.1.3 卸载脚本 (`scripts/uninstall-linux.sh`)

```bash
#!/bin/bash
# 功能:
# 1. 停止并禁用服务
# 2. 删除二进制文件
# 3. 可选: 删除数据和配置

set -euo pipefail

# 停止服务
systemctl stop tokmesh-server || true
systemctl disable tokmesh-server || true

# 删除服务文件
rm -f /etc/systemd/system/tokmesh-server.service
systemctl daemon-reload

# 删除二进制
rm -f /usr/local/bin/tokmesh-server
rm -f /usr/local/bin/tokmesh-cli

# 提示 (不自动删除数据)
echo "Binary files removed."
echo "Data preserved at /var/lib/tokmesh-server"
echo "Config preserved at /etc/tokmesh-server"
echo "To remove completely: rm -rf /var/lib/tokmesh-server /etc/tokmesh-server"
```

### 2.2 Windows 部署

#### 2.2.1 Windows Service 实现（Windows build tags）(`cmd/tokmesh-server/service_windows.go`)

```go
package main

import (
    "golang.org/x/sys/windows/svc"
)

type TokMeshService struct {
    server *server.Server
}

func (s *TokMeshService) Execute(args []string, r <-chan svc.ChangeRequest, changes chan<- svc.Status) (bool, uint32) {
    changes <- svc.Status{State: svc.StartPending}

    // 启动服务
    go s.server.Start()

    changes <- svc.Status{State: svc.Running, Accepts: svc.AcceptStop | svc.AcceptShutdown}

    for c := range r {
        switch c.Cmd {
        case svc.Stop, svc.Shutdown:
            changes <- svc.Status{State: svc.StopPending}
            s.server.Shutdown()
            return false, 0
        }
    }
    return false, 0
}

// 注册服务
func InstallService(name, displayName string) error
func UninstallService(name string) error
```

**验收标准**:
- [ ] 可通过 services.msc 管理
- [ ] 支持启动/停止/重启
- [ ] 崩溃后自动恢复

#### 2.2.2 安装脚本 (`scripts/install-windows.ps1`)

```powershell
# 功能:
# 1. 创建安装目录
# 2. 复制文件
# 3. 注册 Windows Service
# 4. 设置 ACL 权限

$InstallPath = "$env:ProgramFiles\TokMesh"
$DataPath = "$env:ProgramData\tokmesh-server"

# 创建目录
New-Item -ItemType Directory -Force -Path "$InstallPath\bin"
New-Item -ItemType Directory -Force -Path "$DataPath\data"
New-Item -ItemType Directory -Force -Path "$DataPath\certs"

# 复制文件
Copy-Item tokmesh-server.exe "$InstallPath\bin\"
Copy-Item tokmesh-cli.exe "$InstallPath\bin\"
Copy-Item config.yaml "$DataPath\"

# 注册服务
& "$InstallPath\bin\tokmesh-server.exe" install

# 设置 ACL (仅服务账号可写数据目录)
# ...
```

### 2.3 容器化部署

#### 2.3.1 Dockerfile (`Dockerfile`)

```dockerfile
# 构建阶段
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY ./src ./src
WORKDIR /app/src
RUN CGO_ENABLED=0 go build -o tokmesh-server ./cmd/tokmesh-server
RUN CGO_ENABLED=0 go build -o tokmesh-cli    ./cmd/tokmesh-cli

# 运行阶段
FROM alpine:3.19
RUN apk --no-cache add ca-certificates tzdata

# 创建非 root 用户
RUN addgroup -S tokmesh && adduser -S tokmesh -G tokmesh

COPY --from=builder /app/src/tokmesh-server /usr/local/bin/
COPY --from=builder /app/src/tokmesh-cli    /usr/local/bin/
COPY configs/server/minimal/config.yaml /etc/tokmesh-server/config.yaml

# 数据目录
RUN mkdir -p /var/lib/tokmesh-server && chown tokmesh:tokmesh /var/lib/tokmesh-server
VOLUME ["/var/lib/tokmesh-server"]

# 端口
EXPOSE 5080 5443 5343

USER tokmesh
ENTRYPOINT ["tokmesh-server"]
CMD ["--config", "/etc/tokmesh-server/config.yaml"]
```

**验收标准**:
- [ ] 镜像大小 < 100MB
- [ ] 以非 root 用户运行
- [ ] 健康检查正常

#### 2.3.2 Docker Compose (`deployments/docker/docker-compose.yaml`)

```yaml
version: '3.8'

services:
  tokmesh:
    image: tokmesh/tokmesh-server:latest
    ports:
      - "5080:5080"
      - "5443:5443"
    volumes:
      - tokmesh-data:/var/lib/tokmesh-server
      - ./config.yaml:/etc/tokmesh-server/config.yaml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped

volumes:
  tokmesh-data:
```

### 2.4 Kubernetes 部署

#### 2.4.1 StatefulSet (`deployments/kubernetes/statefulset.yaml`)

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tokmesh
spec:
  serviceName: tokmesh
  replicas: 3
  selector:
    matchLabels:
      app: tokmesh
  template:
    metadata:
      labels:
        app: tokmesh
    spec:
      serviceAccountName: tokmesh
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: tokmesh
          image: tokmesh/tokmesh-server:latest
          ports:
            - containerPort: 5080
              name: http
            - containerPort: 5343
              name: cluster
          env:
            - name: TOKMESH_SERVER_HTTP_ADDRESS
              value: "0.0.0.0:5080"
            - name: TOKMESH_CLUSTER_ENABLED
              value: "true"
            - name: TOKMESH_CLUSTER_NODE_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          volumeMounts:
            - name: data
              mountPath: /var/lib/tokmesh-server
            - name: config
              mountPath: /etc/tokmesh-server
          livenessProbe:
            httpGet:
              path: /health
              port: 5080
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 5080
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: config
          configMap:
            name: tokmesh-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

#### 2.4.2 Service (`deployments/kubernetes/service.yaml`)

```yaml
apiVersion: v1
kind: Service
metadata:
  name: tokmesh
spec:
  clusterIP: None  # Headless for StatefulSet
  selector:
    app: tokmesh
  ports:
    - port: 5080
      name: http
    - port: 5343
      name: cluster
---
apiVersion: v1
kind: Service
metadata:
  name: tokmesh-external
spec:
  type: LoadBalancer
  selector:
    app: tokmesh
  ports:
    - port: 5080
      name: http
```

#### 2.4.3 ConfigMap (`deployments/kubernetes/configmap.yaml`)

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: tokmesh-config
data:
  config.yaml: |
    server:
      http:
        enabled: true
        address: "0.0.0.0:5080"
    storage:
      wal:
        dir: "/var/lib/tokmesh-server/wal"
      snapshot:
        dir: "/var/lib/tokmesh-server/snapshots"
```

### 2.5 优雅关闭实现

#### 2.5.1 Shutdown 处理 (`internal/infra/shutdown/shutdown.go`)

```go
package shutdown

import (
    "context"
    "os"
    "os/signal"
    "syscall"
    "time"
)

type Shutdown struct {
    timeout time.Duration
    hooks   []func(context.Context) error
}

func New(timeout time.Duration) *Shutdown

func (s *Shutdown) RegisterHook(hook func(context.Context) error)

func (s *Shutdown) Wait() {
    quit := make(chan os.Signal, 1)
    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
    <-quit

    ctx, cancel := context.WithTimeout(context.Background(), s.timeout)
    defer cancel()

    for _, hook := range s.hooks {
        hook(ctx)
    }
}
```

**验收标准**:
- [ ] SIGTERM 触发优雅关闭
- [ ] 飞行请求完成后再退出
- [ ] 超时强制退出

## 3. 构建脚本

### 3.1 Makefile (`Makefile`)

```makefile
.PHONY: build build-linux build-windows docker test

VERSION ?= $(shell git describe --tags --always)
LDFLAGS := -X github.com/yndnr/tokmesh-go/internal/infra/buildinfo.Version=$(VERSION)

build:
	cd src && go build -ldflags "$(LDFLAGS)" -o ../bin/tokmesh-server ./cmd/tokmesh-server
	cd src && go build -ldflags "$(LDFLAGS)" -o ../bin/tokmesh-cli ./cmd/tokmesh-cli

build-linux:
	cd src && GOOS=linux GOARCH=amd64 go build -ldflags "$(LDFLAGS)" -o ../bin/tokmesh-server-linux-amd64 ./cmd/tokmesh-server
	cd src && GOOS=linux GOARCH=arm64 go build -ldflags "$(LDFLAGS)" -o ../bin/tokmesh-server-linux-arm64 ./cmd/tokmesh-server

build-windows:
	cd src && GOOS=windows GOARCH=amd64 go build -ldflags "$(LDFLAGS)" -o ../bin/tokmesh-server.exe ./cmd/tokmesh-server

docker:
	docker build -t tokmesh/tokmesh-server:$(VERSION) .
	docker tag tokmesh/tokmesh-server:$(VERSION) tokmesh/tokmesh-server:latest

test:
	cd src && go test -race -cover ./...

clean:
	rm -rf bin/
```

## 4. 验收标准

### 4.1 Linux 部署验收
- [ ] 安装脚本成功执行
- [ ] systemd 服务启动正常
- [ ] 热加载 (SIGHUP) 生效
- [ ] 卸载脚本正确清理

### 4.2 Windows 部署验收
- [ ] PowerShell 安装脚本执行
- [ ] Windows Service 注册成功
- [ ] services.msc 管理正常

### 4.3 容器化验收
- [ ] Docker 镜像大小 < 100MB
- [ ] 健康检查正常
- [ ] K8s StatefulSet 3 节点部署成功
- [ ] Pod 重启数据不丢失

### 4.4 优雅关闭验收
- [ ] 请求排空不丢失
- [ ] WAL 刷新完成
- [ ] 退出码正确

## 5. 依赖

### 5.1 外部依赖
- `golang.org/x/sys/windows/svc` - Windows Service API

### 5.2 工具依赖
- Docker 20.10+
- kubectl 1.25+

## 6. 实施顺序

1. **Phase 1**: Makefile → Dockerfile → 优雅关闭
2. **Phase 2**: Linux 安装脚本 → systemd 服务
3. **Phase 3**: Windows Service → PowerShell 脚本
4. **Phase 4**: K8s 部署清单

---

## 变更历史

| 日期 | 版本 | 变更说明 | 作者 |
|------|------|----------|------|
| 2025-12-18 | v1.0 | 初始版本 | Claude Code |

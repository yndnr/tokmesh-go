# TK-0102-实现存储引擎

**状态**: 草稿
**优先级**: P0
**范围**: 存储层 - 内存存储 + WAL + 快照
**关联需求**: `specs/1-requirements/RQ-0101-核心数据模型.md`, `specs/1-requirements/RQ-0402-性能与可靠性需求.md`
**关联设计**: `specs/2-designs/DS-0101-核心数据模型设计.md`, `specs/2-designs/DS-0102-存储引擎设计.md`
**关联决策**: `specs/adrs/AD-0102-并发Map选型决策.md`, `specs/adrs/AD-0201-自适应加密算法决策.md`
**目标代码**: `internal/storage/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现高性能存储引擎，包括：
- 内存存储（分片 ConcurrentMap + 索引）
- WAL 预写日志（批量写入 + 加密）
- 快照管理（定期生成 + 加密）
- 故障恢复（快照加载 + WAL 回放）

## 2. 实施内容

### 2.1 内存存储 (`internal/storage/memory/`)

#### 2.1.1 Store 主存储 (`store.go`)

```go
type Store struct {
    sessions *cmap.ShardedMap[string, *domain.Session]  // 主索引: ID -> Session
    tokens   *cmap.ShardedMap[string, string]           // Token索引: TokenHash -> SessionID
    users    *cmap.ShardedMap[string, *SessionSet]      // 用户索引: UserID -> SessionID集合
    mu       sync.RWMutex                               // 全局操作锁
}

// CRUD 操作
func (s *Store) Create(session *domain.Session) error
func (s *Store) Get(id string) (*domain.Session, error)
func (s *Store) GetByToken(tokenHash string) (*domain.Session, error)
func (s *Store) Update(session *domain.Session) error
func (s *Store) Delete(id string) error
func (s *Store) ListByUser(userID string) ([]*domain.Session, error)
func (s *Store) Count() int
```

实现要点：
- [ ] 使用 `pkg/cmap/` 分片 Map（16 分片）
- [ ] 主索引、Token 索引、用户索引三者同步更新
- [ ] Create 时检查用户配额（默认 50）
- [ ] Version 字段乐观锁实现
- [ ] 并发安全保证

#### 2.1.2 索引管理 (`index.go`)

```go
type IndexManager struct {
    tokenIndex *cmap.ShardedMap[string, string]     // TokenHash -> SessionID
    userIndex  *cmap.ShardedMap[string, *SessionSet] // UserID -> SessionID set
    deviceIndex *cmap.ShardedMap[string, *SessionSet] // DeviceID -> SessionID set
}

func (m *IndexManager) AddSession(s *domain.Session) error
func (m *IndexManager) RemoveSession(s *domain.Session) error
func (m *IndexManager) Rebuild(sessions []*domain.Session) error
```

实现要点：
- [ ] SessionSet 使用 map[string]struct{} 实现
- [ ] 索引更新与主存储原子性
- [ ] 启动时从主存储重建索引

### 2.2 WAL 预写日志 (`internal/storage/wal/`)

#### 2.2.1 Writer (`writer.go`)

```go
type Writer struct {
    file       *os.File
    cipher     adaptive.Cipher  // 自适应加密
    buffer     *bytes.Buffer    // 批量缓冲
    batchCount int
    batchSize  int64
    syncMode   string           // "sync" | "batch"
    syncTicker *time.Ticker
    mu         sync.Mutex
}

func NewWriter(dir string, cipher adaptive.Cipher, cfg WALConfig) (*Writer, error)
func (w *Writer) Append(entry *WALEntry) error
func (w *Writer) Flush() error
func (w *Writer) Close() error
```

WALEntry 定义：
```go
type WALEntry struct {
    Type      EntryType // CREATE, UPDATE, DELETE
    Timestamp int64
    SessionID string
    Session   *domain.Session // CREATE/UPDATE 时填充
    Delta     *SessionDelta   // UPDATE 时可选增量
}
```

实现要点：
- [ ] 批量写入（默认 100 条或 1MB）
- [ ] 同步模式：每批次 fsync
- [ ] 异步模式：定时 fsync（配置间隔）
- [ ] AES-GCM / ChaCha20 自适应加密
- [ ] 文件滚动（按大小）

#### 2.2.2 Reader (`reader.go`)

```go
type Reader struct {
    file   *os.File
    cipher adaptive.Cipher
}

func NewReader(path string, cipher adaptive.Cipher) (*Reader, error)
func (r *Reader) ReadAll() ([]*WALEntry, error)
func (r *Reader) ReadFrom(offset int64) ([]*WALEntry, error)
func (r *Reader) Close() error
```

实现要点：
- [ ] 顺序读取所有条目
- [ ] 解密验证（AEAD 认证）
- [ ] 损坏条目跳过（记录错误日志）

#### 2.2.3 Compactor (`compactor.go`)

```go
type Compactor struct {
    walDir      string
    snapshotMgr *snapshot.Manager
}

func (c *Compactor) Compact() error  // 删除已被快照覆盖的 WAL 文件
func (c *Compactor) ScheduleCompaction(interval time.Duration)
```

### 2.3 快照管理 (`internal/storage/snapshot/`)

#### 2.3.1 Manager (`manager.go`)

```go
type Manager struct {
    dir      string
    cipher   adaptive.Cipher
    interval time.Duration
    threshold int64  // WAL 大小阈值
}

func NewManager(cfg SnapshotConfig, cipher adaptive.Cipher) *Manager
func (m *Manager) Create(sessions []*domain.Session) error
func (m *Manager) Load() ([]*domain.Session, int64, error)  // 返回快照时间戳
func (m *Manager) ScheduleSnapshot(store *memory.Store, wal *wal.Writer)
```

实现要点：
- [ ] Protobuf 序列化
- [ ] 自适应加密
- [ ] 原子写入（写临时文件后 rename）
- [ ] 保留最近 N 个快照

#### 2.3.2 加密 (`encrypt.go`)

```go
func EncryptSnapshot(data []byte, cipher adaptive.Cipher) ([]byte, error)
func DecryptSnapshot(data []byte, cipher adaptive.Cipher) ([]byte, error)
```

### 2.4 恢复流程

```go
// Engine 统一入口
type Engine struct {
    store    *memory.Store
    wal      *wal.Writer
    snapshot *snapshot.Manager
}

func (e *Engine) Recover() error {
    // 1. 加载最新快照
    // 2. 回放快照后的 WAL
    // 3. 重建索引
}
```

## 3. 验收标准

### 3.1 功能验收
- [ ] Session CRUD 操作正确
- [ ] Token/User 索引同步维护
- [ ] WAL 写入后可读取验证
- [ ] 快照生成/加载正确
- [ ] 故障恢复后数据一致

### 3.1.1 可测试验收用例（Given/When/Then）
- [ ] Given 一个新建 Session When `Store.Create(session)` Then 三类索引（ID/TokenHash/UserID）同时可查到且一致
- [ ] Given 单用户已存在 50 个未过期 Session When 再 `Store.Create` Then 返回 `TM-SESS-4002`
- [ ] Given 已存在 Session When `Store.Update(session)` 且 Version 不匹配 Then 返回 `TM-SESS-4091`
- [ ] Given 写入 WAL 成功但内存更新失败（可通过注入失败模拟）When `Create` Then 不留下“半写入”索引（可通过恢复回放验证最终一致）
- [ ] Given 启用加密 When 写入 WAL/快照 Then 磁盘文件不包含明文 `tmtk_`/`tmas_`（基于字节扫描的黑盒断言）
- [ ] Given 生成快照后删除旧 WAL 段 When 调用 `Compactor.Compact()` Then 快照点之前 WAL 段被清理且恢复仍可成功
- [ ] Given 快照 + 后续 WAL 条目 When `Engine.Recover()` Then 内存数据等价于“快照加载 + WAL 回放”的逻辑结果

### 3.2 性能验收
- [ ] 单节点支持 100 万 Session 查询延迟 P99 < 1ms
- [ ] WAL 异步模式吞吐量 ≥ 20,000 writes/s
- [ ] 100 万 Session 快照生成 < 10s
- [ ] 冷启动（快照 + WAL 回放）< 5s

### 3.3 安全验收
- [ ] WAL 文件加密存储
- [ ] 快照文件加密存储
- [ ] 密钥不在日志中打印

### 3.4 测试落点建议（最小集）
- 单元测试：`internal/storage/memory/store_test.go`（三索引一致性/配额/Version 冲突）
- 单元测试：`internal/storage/wal/writer_test.go`、`internal/storage/wal/reader_test.go`（写入/回放/滚动/损坏恢复）
- 单元测试：`internal/storage/snapshot/manager_test.go`（原子写入/加密/保留策略）
- 集成测试：`internal/storage/engine_recover_test.go`（快照 + WAL 回放恢复一致性）
- 依赖注入：WAL/快照需支持注入文件系统（或临时目录）与 AEAD，实现可重复测试

## 4. 依赖

- `pkg/cmap/` - 并发 Map 实现
- `pkg/crypto/adaptive/` - 自适应加密
- `internal/core/domain/` - 领域模型（TK-0101）

## 5. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `storage.wal.dir` | `./data/wal` | WAL 目录 |
| `storage.wal.sync_mode` | `batch` | 同步模式 |
| `storage.wal.sync_interval` | `1s` | 批量 fsync 间隔 |
| `storage.wal.batch_count` | `100` | 批量条数 |
| `storage.wal.batch_size` | `1MB` | 批量字节数 |
| `storage.snapshot.dir` | `./data/snapshots` | 快照目录 |
| `storage.snapshot.interval` | `1h` | 快照间隔 |
| `storage.snapshot.threshold` | `1GB` | WAL 触发阈值 |
| `storage.snapshot.retention_count` | `5` | 保留最近 N 个快照文件 |
| `storage.snapshot.retention_days` | `7` | 保留最近 N 天内的快照（与 retention_count 取并集） |

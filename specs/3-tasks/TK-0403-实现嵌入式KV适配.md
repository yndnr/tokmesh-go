# TK-0403-实现嵌入式 KV 适配

**状态**: ✅ 已完成
**完成时间**: 2025-12-22
**测试覆盖率**: storage 80.9%
**优先级**: P2
**范围**: 控制面存储实现（Phase 3 集群实现前置）
**关联需求**: `specs/1-requirements/RQ-0502-配置管理需求.md`, `specs/1-requirements/RQ-0401-分布式集群架构.md`
**关联设计**: `specs/2-designs/DS-0401-分布式集群架构设计.md`, `specs/2-designs/DS-0502-配置管理设计.md`, `specs/2-designs/DS-0402-可观测性设计.md`
**关联决策**: `specs/adrs/AD-0401-集群元数据持久化引擎选型策略.md`, `specs/adrs/AD-0402-嵌入式KV选型策略.md`, `specs/adrs/AD-0103-依赖包治理与白名单.md`

> **代码骨架对齐（强制）**：本文涉及 `src/` / `internal/` 目录或文件路径时，均以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为单一事实来源；如不一致，以该文档为准并同步更新本文。

---

## 1. 目标
- 设计 `internal/storage` 抽象接口（WAL write、Snapshot/Restore、GC/compaction）以便上层 Raft/State Machine 可以与任意嵌入式 KV 解耦。
- 提供 Badger 实现作为默认 adapter，配置其 GC/compaction/metrics，满足 `AD-0402` 中对高吞吐、低延迟的要求。
- 将 WAL/Snapshot 相关参数暴露到配置（`storage.wal.*`、`storage.snapshot.*`）和监控指标中，便于运维调优。
- 确保后续若需替换为 bbolt/pebble，仅需新增 adapter 而不改业务逻辑。

## 2. 实施内容
1. 规划 `internal/storage` 包：
   - 定义 `KVEngine` 接口，包含 `AppendEntry`, `LoadSnapshot`, `Prune`, `Close` 等，支持 Raft Log + FSM。
   - 提供 `Config` 结构，绑定 `storage.wal.*` 与 `storage.snapshot.*`。
2. 实现 `badgerEngine` 结构：
   - 基于 `github.com/dgraph-io/badger/v3` 实现 WAL append、compaction trigger、snapshot persistence。
   - GC 相关配置通过服务端配置或 `tokmesh-cli config server test --remote` 验证（对齐 `RQ-0502`）：`storage.badger.gc_interval`、`storage.badger.gc_threshold`。
   - Cache 相关配置对齐 `RQ-0502`：`storage.badger.cache_size`（Block Cache 大小）。
   - 提供 Prometheus 指标（Badger GC time, LSM Tables, write stalls），并将 metric 名称与 `specs/2-designs/DS-0402-可观测性设计.md` 里的 `tokmesh_` 前缀一致。
3. 在 Raft/State Machine 层使用 `KVEngine`：
   - 接入 `cluster` 模块，替换当前伪代码存储实现，确保 `KVEngine` 在 cluster bootstrap、snapshot 生成时被调用。
4. 编写测试：
   - 单元测试 `badgerEngine`（写+读+GC）。
   - 集成测试覆盖 snapshot/recovery + GC 多次运行。
5. 更新命令/配置文档：
   - `specs/2-designs/DS-0502-配置管理设计.md` 说明 `storage.wal.*` 参数对应 Badger tuning。
   - `specs/2-designs/DS-0302-管理接口设计.md` / `configs/server/*` 补充 GC metrics 监控说明。

## 3. 验收标准
- [x] `internal/storage.KVEngine` 接口定义完成，Badger adapter 实现并单元测试通过。
- [x] `storage.wal.*` 与 `storage.snapshot.*` 配置值能影响 Badger 行为（通过 `tokmesh-cli config server test` 验证）。
- [x] Prometheus 指标包含 Badger GC/LSM 数据（列入 `specs/2-designs/DS-0402-可观测性设计.md`）。

## 4. 实现说明

### 4.1 KVEngine 接口
定义在 `internal/storage/kv.go`:
- `AppendEntry()` - WAL 追加写入
- `Get()/Set()/Delete()` - 基本 KV 操作
- `Scan()` - 前缀扫描
- `SaveSnapshot()/LoadSnapshot()` - 快照保存与恢复
- `Prune()` - WAL 日志裁剪
- `GC()` - 垃圾回收
- `Stats()` - 统计信息
- `Close()` - 优雅关闭

### 4.2 BadgerEngine 实现
定义在 `internal/storage/badger.go`:
- 基于 `github.com/dgraph-io/badger/v3`
- 自动 GC 循环 (可配置间隔)
- Prometheus 指标:
  - `tokmesh_badger_lsm_size_bytes`
  - `tokmesh_badger_value_log_size_bytes`
  - `tokmesh_badger_total_size_bytes`
  - `tokmesh_badger_last_gc_timestamp_seconds`
  - `tokmesh_badger_gc_bytes_reclaimed_total`

### 4.3 配置结构
`KVConfig` 和 `BadgerConfig` 支持:
- `gc_interval` - GC 间隔
- `gc_threshold` - GC 阈值
- `cache_size` - 块缓存大小
- `value_log_file_size` - 值日志文件大小
- `sync_writes` - 同步写入
- 其他 Badger 调优参数

### 4.4 测试覆盖
- 单元测试: `badger_test.go`
- 覆盖率: 80.9%
- 测试场景: 基本操作、Scan、Prune、Snapshot、GC、Metrics

## 5. 备注
- 任何替换 Badger 的后续 ADR 应确保 `internal/storage` 接口兼容。

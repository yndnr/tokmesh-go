# TK-0401-实现分布式集群

**状态**: ✅ 已完成 (覆盖率 77.6%，待提升至 80%+)
**优先级**: P2（Phase 3）
**范围**: 分布式集群架构
**关联需求**: `specs/1-requirements/RQ-0401-分布式集群架构.md`
**关联设计**: `specs/2-designs/DS-0401-分布式集群架构设计.md`
**关联决策**: `specs/adrs/AD-0403-集群Raft与成员管理依赖选型.md`, `specs/adrs/AD-0103-依赖包治理与白名单.md`
**关联任务**: `specs/3-tasks/TK-0403-实现嵌入式KV适配.md`
**目标代码**: `internal/server/clusterserver/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现分布式集群能力：
- 节点发现与成员管理
- 数据分片与路由
- Raft 共识（控制面）
- 数据复制

## 2. 前置依赖

- **TK-0403**: 嵌入式 KV 适配（Badger）- Raft 日志存储

## 3. 实施内容

### 3.1 集群服务 (`internal/server/clusterserver/server.go`)

```go
type Server struct {
    nodeID     string
    raft       *raft.Raft
    transport  *raft.NetworkTransport
    fsm        *StateMachine
    memberList *memberlist.Memberlist
    shardMap   *ShardMap
    logger     *logger.Logger
}

func NewServer(cfg ClusterConfig, deps Dependencies) (*Server, error)
func (s *Server) Start(ctx context.Context) error
func (s *Server) Shutdown(ctx context.Context) error
func (s *Server) IsLeader() bool
func (s *Server) Leader() string
```

### 3.2 节点发现

```go
type Discovery struct {
    memberList *memberlist.Memberlist
    seeds      []string
}

func (d *Discovery) Join() error
func (d *Discovery) Leave() error
func (d *Discovery) Members() []Member
```

配置：
- `cluster.discovery.seeds`: 种子节点列表
- `cluster.bootstrap.expect_nodes`: 期望节点数

### 3.3 Raft 共识

```go
type RaftNode struct {
    raft      *raft.Raft
    transport *raft.NetworkTransport
    store     *badger.DB  // 日志存储
}

func NewRaftNode(cfg RaftConfig, fsm raft.FSM) (*RaftNode, error)
func (r *RaftNode) Apply(cmd []byte) error
func (r *RaftNode) Snapshot() error
```

### 3.4 状态机 (FSM)

```go
type StateMachine struct {
    shardMap *ShardMap
    apiKeys  *APIKeyStore
}

func (f *StateMachine) Apply(log *raft.Log) interface{}
func (f *StateMachine) Snapshot() (raft.FSMSnapshot, error)
func (f *StateMachine) Restore(rc io.ReadCloser) error
```

### 3.5 数据分片

```go
type ShardMap struct {
    shards    map[uint32]*Shard
    vnodes    map[uint64]uint32  // vnode -> shard
    replicas  int
}

func (m *ShardMap) GetShard(key string) *Shard
func (m *ShardMap) GetReplicas(shardID uint32) []string  // 副本节点
func (m *ShardMap) Rebalance(nodes []string) error
```

### 3.6 集群内部 RPC 通信（Connect + Protobuf）(`api/proto/v1/cluster.proto`)

补充说明（代码骨架口径以 `specs/governance/code-skeleton.md` 为准）：
- 生成代码产物：`src/api/proto/v1/cluster.pb.go`
- 生成策略：不提交生成文件；通过 `go generate ./...` 生成（见 `specs/governance/alignment-open-decisions.md`）
  - `go:generate` 落点：`src/api/proto/v1/generate.go`
  - 工具链版本口径：`protoc v3.20.3` + `protoc-gen-go v1.34.2`
- 验收口径：CI/本地在 `go test/go build` 前必须先跑生成步骤，确保构建可重复

```protobuf
service ClusterService {
  // 节点加入
  rpc Join(JoinRequest) returns (JoinResponse);
  // 获取 Shard Map
  rpc GetShardMap(GetShardMapRequest) returns (GetShardMapResponse);
  // 数据搬迁 (Rebalance)
  rpc TransferShard(stream TransferShardRequest) returns (TransferShardResponse);
}
```

### 3.7 Connect/Protobuf 中间件 (`internal/server/clusterserver/interceptor.go`)

```go
// Connect 拦截器：mTLS 认证、请求日志、指标收集
func UnaryInterceptor() connect.Interceptor
func StreamInterceptor() connect.Interceptor
```

## 4. 验收标准

### 4.1 功能验收
- [ ] 3 节点集群启动
- [ ] Leader 选举成功
- [ ] 数据分片路由正确
- [ ] 副本同步正常
- [ ] 节点故障转移

### 4.2 性能验收
- [ ] 集群吞吐量 ≥ 100,000 TPS
- [ ] 跨节点延迟 P99 < 50ms
- [ ] 节点冷启动 < 5s

### 4.3 可靠性验收
- [ ] 单节点故障不影响服务
- [ ] 脑裂防护
- [ ] 数据一致性保证

## 5. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `cluster.enabled` | `false` | 集群开关 |
| `cluster.node_id` | 自动生成 | 节点 ID |
| `cluster.listen_address` | `127.0.0.1:5343` | 集群监听 |
| `cluster.advertise_address` | - | 宣告地址（必填） |
| `cluster.discovery.seeds` | `[]` | 种子节点 |
| `cluster.bootstrap.expect_nodes` | `1` | 期望节点数 |
| `cluster.data.replication_factor` | `1` | 副本数 |
| `cluster.raft.snapshot_threshold` | `10000` | Raft 日志达到阈值触发快照 |
| `cluster.raft.trailing_logs` | `1000` | 快照后保留日志条数 |
| `cluster.rebalance.max_rate` | `"20Mbps"` | 再平衡带宽上限（rate 格式） |
| `cluster.rebalance.min_ttl` | `"60s"` | 剩余 TTL 低于该值的 Session 不迁移 |
| `cluster.shutdown.timeout` | `60s` | 退出超时 |
| `cluster.shutdown.force_leave` | `false` | 强制退出 |
| `cluster.tls.cert_file` | - | 集群 mTLS 节点证书（启用集群必填） |
| `cluster.tls.key_file` | - | 集群 mTLS 节点私钥（启用集群必填） |
| `cluster.tls.client_ca_file` | - | 集群 mTLS 客户端 CA（启用集群必填） |

## 6. 里程碑

1. **Phase 3.1**: 节点发现 + Raft Leader 选举
2. **Phase 3.2**: 分片路由 + 请求转发
3. **Phase 3.3**: 数据复制 + 故障转移
4. **Phase 3.4**: 再平衡 + 滚动升级

## 7. 依赖

- `github.com/hashicorp/raft` - Raft 共识
- `github.com/hashicorp/memberlist` - 成员管理（Gossip）
- `connectrpc.com/connect` - 集群内部 RPC（Connect + Protobuf）
- `google.golang.org/protobuf` - Protobuf 运行时
- `TK-0403` - 嵌入式 KV（Badger）

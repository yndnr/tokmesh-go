# TK-0101-实现核心数据模型

**状态**: ⚠️ 已合并（本文档已废弃，单一事实来源见 `TK-0101-核心域实现.md`）
**优先级**: P0
**范围**: 核心域 - 领域模型实现
**关联需求**: `specs/1-requirements/RQ-0101-核心数据模型.md`, `specs/1-requirements/RQ-0102-会话生命周期管理.md`
**关联设计**: `specs/2-designs/DS-0101-核心数据模型设计.md`
**目标代码**: `internal/core/domain/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现 TokMesh 核心领域模型（Session, Token, APIKey, Errors），为上层服务和存储层提供基础数据结构。

## 2. 实施内容

### 2.1 Session 模型 (`internal/core/domain/session.go`)

```go
// Session 代表一个活跃的会话实体
type Session struct {
    ID             string            `json:"id"`               // tmss-xxxxxxxxxx
    UserID         string            `json:"user_id"`
    TokenHash      string            `json:"token_hash"`       // SHA-256 哈希
    IPAddress      string            `json:"ip_address"`
    UserAgent      string            `json:"user_agent"`
    LastAccessIP   string            `json:"last_access_ip"`
    LastAccessUA   string            `json:"last_access_ua"`
    DeviceID       string            `json:"device_id"`
    CreatedBy      string            `json:"created_by"`       // API Key ID
    CreatedAt      int64             `json:"created_at"`       // Unix MS
    ExpiresAt      int64             `json:"expires_at"`       // Unix MS
    LastActive     int64             `json:"last_active"`      // Unix MS
    Data           map[string]string `json:"data"`
    Version        uint64            `json:"version"`          // 乐观锁
    ShardID        uint32            `json:"-"`                // 内部字段
    TTL            int64             `json:"-"`
    IsDeleted      bool              `json:"-"`
}
```

实现要点：
- [ ] Session 结构体定义
- [ ] NewSession() 构造函数（生成 tmss-xxx ID）
- [ ] IsExpired() 过期检查方法
- [ ] Touch() 更新 LastActive
- [ ] IncrVersion() 版本递增
- [ ] Validate() 字段约束验证（UserID ≤128, UA ≤512, Data ≤4KB）

### 2.2 Token 工具 (`internal/core/domain/token.go`)

```go
// GenerateToken 生成安全随机令牌
func GenerateToken() (plaintext string, hash string, err error)

// HashToken 计算 Token 的 SHA-256 哈希
func HashToken(plaintext string) string // 返回 `tmth_` + Hex(SHA-256(token))（总长 69）

// ValidateTokenFormat 验证 Token 格式 (tmtk_xxx)
func ValidateTokenFormat(token string) bool
```

实现要点：
- [ ] 使用 crypto/rand 生成 32 字节随机数
- [ ] Base64 RawURL 编码（43 字符）
- [ ] 添加 `tmtk_` 前缀（总长 48 字符）
- [ ] SHA-256 哈希存储

### 2.3 APIKey 模型 (`internal/core/domain/apikey.go`)

> **单一事实来源**: `specs/2-designs/DS-0201-安全与鉴权设计.md` 第 2.1 节
>
> APIKey 属于安全与鉴权域的核心数据模型，完整字段定义请参见 DS-0201。
> 本任务仅实现基础 Role 枚举和辅助方法，完整 APIKey 管理在 TK-0201 (安全与鉴权实现) 中完成。

```go
// Role 角色枚举
type Role string

const (
    RoleMetrics   Role = "metrics"   // 仅监控指标访问
    RoleValidator Role = "validator" // 仅令牌校验与只读查询
    RoleIssuer    Role = "issuer"    // 会话/令牌写操作 + validator 能力
    RoleAdmin     Role = "admin"     // 系统管理全权限
)

// KeyStatus Key 状态枚举
type KeyStatus string

const (
    KeyStatusActive   KeyStatus = "active"
    KeyStatusDisabled KeyStatus = "disabled"
)
```

实现要点（基础部分）：
- [ ] Role 枚举定义
- [ ] KeyStatus 枚举定义
- [ ] HasPermission(role Role, action string) bool 权限检查辅助函数

> **注意**: APIKey 完整结构体、Argon2 验证、密钥轮转等功能将在独立任务 TK-0201 中实现。

### 2.4 错误定义 (`internal/core/domain/errors.go`)

> **单一事实来源**: `specs/governance/error-codes.md`

```go
// 业务错误码（严格遵循 specs/governance/error-codes.md）
var (
    // 会话相关 (SESS)
    ErrSessionNotFound      = NewDomainError("TM-SESS-4040", "session not found")
    ErrSessionExpired       = NewDomainError("TM-SESS-4041", "session expired")
    ErrSessionQuotaExceeded = NewDomainError("TM-SESS-4002", "user session quota exceeded")
    ErrSessionConflict      = NewDomainError("TM-SESS-4090", "session id conflict")
    ErrSessionVersionConflict = NewDomainError("TM-SESS-4091", "version conflict, please retry")
    ErrSessionDataTooLarge  = NewDomainError("TM-SESS-4001", "session data exceeds 4KB limit")

    // 令牌相关 (TOKN)
    ErrTokenMalformed       = NewDomainError("TM-TOKN-4000", "malformed token")
    ErrTokenInvalid         = NewDomainError("TM-TOKN-4010", "invalid token")
    ErrTokenExpired         = NewDomainError("TM-TOKN-4011", "token expired")
    ErrTokenRevoked         = NewDomainError("TM-TOKN-4012", "token revoked")
    ErrTokenHashConflict    = NewDomainError("TM-TOKN-4090", "token hash conflict")

    // 鉴权相关 (AUTH)
    ErrAPIKeyMissing        = NewDomainError("TM-AUTH-4010", "api key not provided")
    ErrAPIKeyInvalid        = NewDomainError("TM-AUTH-4011", "invalid api key")
    ErrAPIKeyDisabled       = NewDomainError("TM-AUTH-4012", "api key disabled")
    ErrTimestampSkew        = NewDomainError("TM-AUTH-4014", "timestamp out of acceptable window")
    ErrPermissionDenied     = NewDomainError("TM-AUTH-4030", "permission denied")
    ErrIPNotAllowed         = NewDomainError("TM-AUTH-4031", "ip not in allowlist")
)
```

实现要点：
- [ ] DomainError 结构体（Code, Message, Details）
- [ ] Error() 实现 error 接口
- [ ] Is() 支持 errors.Is() 比较
- [ ] Wrap() 包装底层错误

## 3. 验收标准

### 3.1 结构与约束
- [ ] 所有结构体定义完成，字段约束与 `DS-0101` 一致
- [ ] 错误码常量与 `specs/governance/error-codes.md` 一致（含 `TM-SESS-4091`）

### 3.2 可测试验收用例（Given/When/Then）
- [ ] Given 无效 `user_id`（长度 129）When `Session.Validate()` Then 返回 `TM-SESS-4001`
- [ ] Given `data` 序列化后 > 4KB When `Session.Validate()` Then 返回 `TM-SESS-4001`
- [ ] Given `GenerateToken()` When 调用一次 Then 返回的明文以 `tmtk_` 开头且总长为 48，并返回 `SHA-256(token)` 作为 hash
- [ ] Given 任意明文 token When `HashToken(token)` Then 输出稳定（同输入多次一致）且与 `GenerateToken()` 的 hash 一致
- [ ] Given token 前缀非 `tmtk_` When `ValidateTokenFormat(token)` Then 返回 false
- [ ] Given token 为 `tmtk_` + 43 字符 Base64 RawURL When `ValidateTokenFormat(token)` Then 返回 true
- [ ] Given 两个不同 token When `HashToken()` Then 输出不相等（碰撞概率可忽略；测试仅做“不应相等”的断言）
- [ ] Given `RoleAdmin` When `HasPermission(admin,"apikey.create")` Then true；Given `RoleValidator` When 同操作 Then false（权限矩阵以 `DS-0103`/`RQ-0201` 为准）

### 3.3 工程质量
- [ ] 单元测试覆盖率 ≥ 80%
- [ ] `go vet` / `golangci-lint` 无警告

### 3.4 测试落点建议（最小集）
- 单元测试：`internal/core/domain/session_test.go`（Validate/IsExpired/Touch/Version）
- 单元测试：`internal/core/domain/token_test.go`（GenerateToken/HashToken/ValidateTokenFormat）
- 单元测试：`internal/core/domain/errors_test.go`（Code/Is/Wrapping）
- 依赖注入：建议在 token 生成处可注入随机源与时钟，便于稳定断言

## 4. 依赖

- `pkg/token/` - Token 生成器（复用）
- `pkg/crypto/adaptive/` - 加密库（Argon2 可选）
- `golang.org/x/crypto/argon2` - Argon2 实现

## 5. 备注

- ID 生成使用 pkg/token/generator.go 中已有的实现
- 敏感字段（Token, Secret）的日志脱敏在 telemetry 层处理

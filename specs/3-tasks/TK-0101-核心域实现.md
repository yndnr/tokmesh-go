# TK-0101-核心域实现

**状态**: ✅ 已完成
**优先级**: P0
**来源**: RQ-0101-核心数据模型.md, DS-0101-核心数据模型设计.md, DS-0103-核心服务层设计.md
**负责人**: yndnr
**创建日期**: 2025-12-18
**预估工时**: 8 小时

## 1. 任务概述

实现 TokMesh 核心域代码，包括领域模型（Domain）和领域服务（Service）两个子模块：
- `internal/core/domain/`: 纯业务逻辑，定义核心实体和值对象
- `internal/core/service/`: 业务服务层，封装业务操作和流程

## 2. 任务分解

### 2.1 Domain 层实现（纯业务逻辑，无外部依赖）

#### TK-0101-01: 实现 domain/session.go
- [x] 定义 Session 结构体（17 个字段，符合 DS-0101 §2.1）
- [x] 实现 Session 验证方法（IsExpired, IsDeleted, IsValid）
- [x] 实现 Session 字段约束校验（UserID/DeviceID/Data 长度限制）
- [x] 编写单元测试（覆盖率 ≥ 80%）

**依赖**:
- pkg/token (用于 ID 生成)
- time (标准库)

**验收标准**:
- [ ] Session 结构体包含 13 个业务字段 + 4 个内部字段
- [ ] IsExpired() 方法正确判断过期状态
- [ ] 字段长度校验符合 RQ-0101 §4.1 约束
- [ ] Data 字段总大小不超过 4KB
- [ ] 测试覆盖率 ≥ 80%

#### TK-0101-02: 实现 domain/token.go
- [x] 定义 Token 相关常量（前缀、长度）
- [x] 实现 Token 格式校验方法（ValidateTokenFormat）
- [x] 实现 TokenHash 格式校验方法
- [x] 编写单元测试

**依赖**:
- crypto/sha256 (标准库)
- encoding/base64 (标准库)

**验收标准**:
- [ ] Token 格式校验符合 `tmtk_` + 43 字符 Base64 RawURL
- [ ] TokenHash 格式校验符合 `tmth_` + 64 字符 Hex
- [ ] 测试覆盖正常和异常情况

#### TK-0101-03: 实现 domain/apikey.go
- [x] 定义 APIKey 结构体（参考 DS-0201）
- [x] 定义 Role 枚举（metrics/validator/issuer/admin）
- [x] 实现 APIKey 验证方法（IsExpired, IsActive）
- [x] 编写单元测试

**依赖**:
- time (标准库)

**验收标准**:
- [ ] Role 枚举包含 4 个角色
- [ ] IsExpired() 正确判断过期状态
- [ ] IsActive() 检查状态字段

#### TK-0101-04: 实现 domain/errors.go
- [x] 定义领域错误类型（DomainError）
- [x] 定义核心错误码常量（符合 specs/governance/error-codes.md）
- [x] 实现错误构造函数（NewSessionNotFoundError, NewSessionExpiredError 等）
- [x] 实现 Error() 接口

**依赖**:
- errors (标准库)
- fmt (标准库)

**验收标准**:
- [ ] 错误码遵循 `TM-*` 格式
- [ ] 错误类型包含：TM-SESS-4040/4041/4002/4091
- [ ] 错误类型包含：TM-TOKN-4010/4090
- [ ] 错误类型包含：TM-ARG-1001/1002

### 2.2 Service 层实现（依赖 Domain + Storage 接口）

> **注意**: Service 层依赖存储层接口，需先定义 Storage 接口抽象，或使用 mock 进行单元测试

#### TK-0101-05: 实现 service/token.go
- [ ] 定义 TokenService 接口（GenerateToken, ComputeTokenHash, Validate）
- [ ] 实现 GenerateToken() 方法（32 字节 CSPRNG + Base64 RawURL）
- [ ] 实现 ComputeTokenHash() 方法（SHA-256 + tmth_ 前缀）
- [ ] 实现 Validate() 方法（查找 TokenHash → SessionID → Session）
- [ ] 实现 CheckNonce() 防重放（基于 NonceCache）
- [ ] 编写单元测试（使用 mock storage）

**依赖**:
- crypto/rand (CSPRNG)
- crypto/sha256
- encoding/base64
- encoding/hex
- container/list (NonceCache LRU)
- domain (Session, Token, Errors)

**验收标准**:
- [ ] GenerateToken() 生成的 Token 长度固定 48 字符
- [ ] 相同 Token 产生相同 TokenHash
- [ ] Validate() 能正确识别无效 Token（返回 TM-TOKN-4010）
- [ ] CheckNonce() 拒绝重复 Nonce（返回 TM-AUTH-4015）
- [ ] 测试覆盖率 ≥ 80%

#### TK-0101-06: 实现 service/session.go
- [ ] 定义 SessionService 接口（Create, Get, List, Renew, Revoke, RevokeByUser）
- [ ] 实现 Create() 方法（含配额检查、Token 生成、WAL 写入）
- [ ] 实现 Get() 方法（含惰性删除检查）
- [ ] 实现 Renew() 方法（含乐观锁 CAS）
- [ ] 实现 Revoke() 方法（支持 sync 模式）
- [ ] 实现 RevokeByUser() 批量吊销（含并发控制）
- [ ] 实现 List() 方法（含分页/过滤/排序）
- [ ] 编写单元测试（使用 mock storage）

**依赖**:
- context
- time
- domain (Session, Errors)
- TokenService (生成 Token)
- Storage 接口（待定义）

**验收标准**:
- [ ] Create: 配额超限时返回 TM-SESS-4002
- [ ] Get: 过期 Session 返回 TM-SESS-4041
- [ ] Renew: 并发冲突时返回 TM-SESS-4091
- [ ] Revoke: 幂等性（重复吊销返回成功）
- [ ] RevokeByUser: 批量上限 1000 个
- [ ] List: 支持 user_id/device_id/key_id/ip/time_range/sort/page/size 过滤
- [ ] 测试覆盖率 ≥ 80%

#### TK-0101-07: 实现 service/auth.go
- [ ] 定义 AuthService 接口（ValidateAPIKey, CheckPermission, CheckRateLimit）
- [ ] 实现 ValidateAPIKey() 方法（含 Argon2 验证和缓存）
- [ ] 实现 CheckPermission() 权限矩阵
- [ ] 实现 CheckRateLimit() 令牌桶限流
- [ ] 实现 InvalidateCache() 缓存失效
- [ ] 编写单元测试（使用 mock storage）

**依赖**:
- context
- golang.org/x/crypto/argon2 (Argon2 验证)
- golang.org/x/time/rate (令牌桶限流)
- domain (APIKey, Role, Errors)
- Storage 接口（待定义）

**验收标准**:
- [ ] ValidateAPIKey: 缓存命中时跳过 Argon2 验证
- [ ] ValidateAPIKey: IP 白名单拦截生效
- [ ] CheckPermission: 权限矩阵符合 DS-0103 §5.4
- [ ] CheckRateLimit: 超限时返回 TM-SYS-4290 和 Retry-After
- [ ] 测试覆盖率 ≥ 80%

## 3. 依赖关系

```
domain/session.go ──┐
domain/token.go   ──┤
domain/apikey.go  ──┼──> service/token.go ──┐
domain/errors.go  ──┘                       ├──> service/session.go
                                            │
pkg/token (ID生成) ────────────────────────┤
pkg/crypto/adaptive (加密) ────────────────┤
                                            │
Storage 接口 (待定义) ─────────────────────┴──> service/auth.go
```

## 4. 实施顺序

**阶段 1: Domain 层**（无外部依赖，可立即实现）
1. domain/errors.go（优先，其他模块依赖）
2. domain/token.go
3. domain/session.go
4. domain/apikey.go

**阶段 2: Service 层**（需等待 Storage 接口定义 或 使用 mock）
1. service/token.go（依赖较少）
2. service/session.go（依赖 TokenService）
3. service/auth.go（依赖 Storage）

## 5. 风险与阻塞项

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| **Storage 接口未定义** | 阻塞 Service 层实现 | 先实现 Domain 层，或定义临时接口用于 mock |
| **pkg/token 未实现** | 阻塞 ID 生成 | 优先实现 pkg/token (ULID 生成) |
| **pkg/crypto/adaptive 未实现** | 阻塞 WAL 加密 | 可延后，先使用明文测试 |
| **第三方依赖冲突** | Argon2/Rate 包引入 | 确认依赖白名单，更新 go.mod |

## 6. 测试策略

### 6.1 单元测试覆盖率目标

| 模块 | 目标覆盖率 | 说明 |
|------|-----------|------|
| domain/* | ≥ 85% | 纯业务逻辑，高覆盖率 |
| service/* | ≥ 80% | 使用 mock storage |

### 6.2 测试重点

- **Domain 层**: 边界值测试（字段长度、时间过期、约束校验）
- **Service 层**: 并发冲突测试（CAS）、配额限制测试、错误处理测试

## 7. 验收标准（总体）

- [ ] 所有 Domain 文件实现完成（4 个文件）
- [ ] 所有 Service 文件实现完成（3 个文件）
- [ ] 整体测试覆盖率 ≥ 80%
- [ ] 所有单元测试通过（`go test ./internal/core/... -v`）
- [ ] 代码通过静态检查（`go vet ./internal/core/...`）
- [ ] 代码格式化完成（`gofmt -s -w ./internal/core/`）
- [ ] 遵循 Go 编码规范（specs/governance/coding-standards/backend/std-go.md）

## 8. 后续任务

- TK-0102: 实现 Storage 层（memory/wal/snapshot）
- TK-0103: 实现 pkg/token（ULID 生成）
- TK-0104: 实现 pkg/crypto/adaptive（自适应加密）
- TK-0201: 实现 Server 接入层（httpserver/redisserver）

# TK-0303-实现管理接口

**状态**: ✅ 已完成 (handler 覆盖率 83.1%)
**优先级**: P1
**范围**: Admin API 接口实现
**关联需求**: `specs/1-requirements/RQ-0304-管理接口规约.md`
**关联设计**: `specs/2-designs/DS-0302-管理接口设计.md`
**目标代码**: `internal/server/httpserver/handler/`, `internal/core/service/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现 TokMesh 管理接口（Admin API），供 CLI 工具和运维 Dashboard 使用：
- 系统状态查询
- API Key 管理
- 备份与恢复
- 审计日志查询
- 集群管理（Phase 3）
- 系统配置管理
- WAL 日志管理

## 2. 任务分解

### 2.1 中间件实现

#### 2.1.1 AdminAuthN 中间件 (`internal/server/httpserver/middleware.go`)

```go
// AdminAuthMiddleware 校验 admin 角色
// 处理流程:
// 1. 提取 API Key (Authorization: Bearer 或 X-API-Key)
// 2. 校验 API Key 有效性
// 3. 检查是否为 admin 角色
// 4. 注入上下文 (api_key_id, operator_role)
func AdminAuthMiddleware(authSvc *service.AuthService) func(http.Handler) http.Handler
```

**验收标准**:
- [ ] 非 admin 角色返回 403 (TM-ADMIN-4030)
- [ ] 无效 Key 返回 401 (TM-AUTH-4011)
- [ ] 未提供 Key 返回 401 (TM-AUTH-4010)

#### 2.1.2 NetworkACL 中间件 (`internal/server/httpserver/middleware.go`)

```go
// NetworkACLMiddleware 检查来源 IP 是否在允许名单
// 仅在 security.auth.allow_list 非空时启用
func NetworkACLMiddleware(allowList []string) func(http.Handler) http.Handler
```

**验收标准**:
- [ ] 支持 IPv4/IPv6 单地址
- [ ] 支持 CIDR 范围 (如 10.0.0.0/8)
- [ ] 不在白名单返回 403 (TM-ADMIN-4031)

#### 2.1.3 AuditLog 中间件 (`internal/server/httpserver/middleware.go`)

```go
// AuditLogMiddleware 记录管理操作审计日志
// 记录内容: operator_id, action, resource, ip, user_agent, result
func AuditLogMiddleware(auditSvc *service.AuditService) func(http.Handler) http.Handler
```

**验收标准**:
- [ ] 所有管理操作均记录
- [ ] 敏感字段脱敏 (如 key_secret)
- [ ] 异步写入，不阻塞请求

#### 2.1.4 MetricsAuth 中间件 (`internal/server/httpserver/middleware.go`)

```go
// MetricsAuthMiddleware 处理 /metrics 端点鉴权
// 支持配置化: telemetry.metrics.auth_enabled
func MetricsAuthMiddleware(authRequired bool, authSvc *service.AuthService) func(http.Handler) http.Handler
```

**验收标准**:
- [ ] auth_enabled=true 时需要 API Key
- [ ] 允许 metrics 或 admin 角色
- [ ] auth_enabled=false 时无鉴权

### 2.2 系统状态接口

#### 2.2.1 状态摘要 (`internal/server/httpserver/handler/admin_status.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/status/summary` | GET | 获取系统状态摘要 |
| `/admin/v1/gc/trigger` | POST | 触发垃圾回收 |

**实现要点**:
- 从 runtime/metrics 和内部计数器聚合数据
- 缓存聚合结果 (1s TTL) 避免高频调用开销
- GC 请求限流: 同类型 60s 内仅允许 1 次

**验收标准**:
- [ ] `/admin/v1/status/summary` 响应时间 < 10ms
- [ ] 返回 uptime, version, sessions 等关键指标
- [ ] GC 触发成功返回清理数量和耗时

### 2.3 API Key 管理接口

#### 2.3.1 API Key CRUD (`internal/server/httpserver/handler/admin_keys.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/keys` | POST | 创建 Key |
| `/admin/v1/keys` | GET | 列出 Keys |
| `/admin/v1/keys/{key_id}/status` | POST | 更新 Key 状态 |
| `/admin/v1/keys/{key_id}/rotate` | POST | 轮转 Secret |

**实现要点**:
- `key_id` 格式: `tmak-` + 26 字符 ULID
- `key_secret` 格式: `tmas_` + 32 字节随机数 (Base62)
- Secret 使用 Argon2id 哈希后存储
- 轮转时旧 Secret 保留 1h 宽限期

**验收标准**:
- [ ] 创建成功返回 key_id 和 key_secret (仅一次)
- [ ] 有效期 > 365 天时返回 warning 字段
- [ ] 列表分页正确 (page/size)
- [ ] 轮转后两个 Secret 在宽限期内均有效

### 2.4 备份与恢复接口

#### 2.4.1 备份管理 (`internal/server/httpserver/handler/admin_backup.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/backups/snapshots` | POST | 触发快照 |
| `/admin/v1/backups/snapshots` | GET | 列出快照 |
| `/admin/v1/backups/snapshots/{snapshot_id}/file` | GET | 下载备份 |
| `/admin/v1/backups/restores` | POST | 执行还原 |
| `/admin/v1/backups/restores/{job_id}` | GET | 查询还原状态 |

**实现要点**:
- 快照包含: Session 数据 + API Key 数据 + 元数据
- 使用原子文件写入，避免损坏
- 下载支持 Range 请求 (断点续传)
- 上传大小限制: 默认 100MB

**验收标准**:
- [ ] 快照创建成功返回 snapshot_id 和 checksum
- [ ] 下载支持 Range 和 Content-Disposition
- [ ] 还原期间 /ready 返回 503
- [ ] 校验文件 Magic Bytes: `TOKMESH_BAK_V1`

### 2.5 审计日志接口

#### 2.5.1 审计查询 (`internal/server/httpserver/handler/admin_audit.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/audit/logs` | GET | 查询审计日志 |

**查询参数**:
- `start_time`, `end_time`: 时间范围 (Unix ms)
- `operator_id`: 操作者 API Key ID
- `action`: 操作类型
- `page`, `size`: 分页

**验收标准**:
- [ ] 支持时间范围过滤
- [ ] 支持操作者过滤
- [ ] 敏感字段已脱敏

### 2.6 集群管理接口 (Phase 3)

#### 2.6.1 集群操作 (`internal/server/httpserver/handler/admin_cluster.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/cluster/nodes` | GET | 查看节点列表 |
| `/admin/v1/cluster/nodes/{node_id}/remove` | POST | 移除节点 |
| `/admin/v1/cluster/reset` | POST | 节点重置 |

**说明**: Phase 3 实现，当前可创建骨架代码返回 501 Not Implemented。

### 2.7 系统配置接口

#### 2.7.1 配置管理 (`internal/server/httpserver/handler/admin_config.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/config` | GET | 获取可热更新配置 |
| `/admin/v1/config/apply` | POST | 更新配置 |
| `/admin/v1/config/validate` | POST | 验证配置 |
| `/admin/v1/config/reload` | POST | 触发热加载 |

**可热更新配置项**:
- `telemetry.logging.level` (debug/info/warn/error)

**验收标准**:
- [ ] 返回当前可热更新配置值
- [ ] 更新日志级别立即生效
- [ ] 验证返回结构化错误列表

### 2.8 WAL 日志接口

#### 2.8.1 WAL 管理 (`internal/server/httpserver/handler/admin_wal.go`)

| 端点 | 方法 | 说明 |
|------|------|------|
| `/admin/v1/wal/status` | GET | 查看 WAL 状态 |
| `/admin/v1/wal/logs` | GET | 读取 WAL 日志 (调试) |

**验收标准**:
- [ ] 返回 WAL 段信息 (数量、大小、时间范围)
- [ ] 日志读取支持 offset 和 limit

### 2.9 可观测性端点

#### 2.9.1 健康检查 (`internal/server/httpserver/handler/health.go`)

| 端点 | 方法 | 鉴权 | 说明 |
|------|------|------|------|
| `/health` | GET | 无 | 存活探针 |
| `/ready` | GET | 无 | 就绪探针 |
| `/metrics` | GET | 可配置 | Prometheus 指标 |

**验收标准**:
- [ ] `/health` 响应时间 < 10ms
- [ ] `/ready` 检查存储层和集群状态
- [ ] `/metrics` 支持配置化鉴权

## 3. 服务层实现

### 3.1 管理服务 (`internal/core/service/admin.go`)

```go
type AdminService struct {
    sessionStore  storage.SessionStore
    apiKeyStore   storage.APIKeyStore
    auditStore    storage.AuditStore
    snapshotStore storage.SnapshotStore
}

// 系统状态
func (s *AdminService) GetStatusSummary(ctx context.Context) (*StatusSummary, error)
func (s *AdminService) TriggerGC(ctx context.Context, gcType string) (*GCResult, error)

// API Key 管理
func (s *AdminService) CreateAPIKey(ctx context.Context, req *CreateKeyRequest) (*CreateKeyResponse, error)
func (s *AdminService) ListAPIKeys(ctx context.Context, filter *KeyFilter) (*KeyListResponse, error)
func (s *AdminService) UpdateKeyStatus(ctx context.Context, keyID string, status string) error
func (s *AdminService) RotateKeySecret(ctx context.Context, keyID string) (*RotateKeyResponse, error)

// 备份恢复
func (s *AdminService) CreateSnapshot(ctx context.Context, desc string) (*Snapshot, error)
func (s *AdminService) ListSnapshots(ctx context.Context) ([]*Snapshot, error)
func (s *AdminService) RestoreFromSnapshot(ctx context.Context, snapshotID string) (*RestoreJob, error)
func (s *AdminService) GetRestoreStatus(ctx context.Context, jobID string) (*RestoreJob, error)
```

### 3.2 审计服务 (`internal/core/service/audit.go`)

```go
type AuditService struct {
    store storage.AuditStore
}

func (s *AuditService) Log(ctx context.Context, entry *AuditEntry) error
func (s *AuditService) Query(ctx context.Context, filter *AuditFilter) ([]*AuditEntry, error)
```

## 4. 路由注册

### 4.1 Admin 路由组 (`internal/server/httpserver/router.go`)

```go
func (s *Server) registerAdminRoutes() {
    admin := s.router.Group("/admin/v1")

    // 中间件链
    admin.Use(
        middleware.RequestID(),
        middleware.AdminAuthN(s.authSvc),
        middleware.NetworkACL(s.cfg.Security.Auth.AllowList),
        middleware.AuditLog(s.auditSvc),
    )

    // 系统状态
    admin.GET("/status/summary", handler.GetStatusSummary)
    admin.POST("/gc/trigger", handler.TriggerGC)

    // API Key 管理
    admin.POST("/keys", handler.CreateKey)
    admin.GET("/keys", handler.ListKeys)
    admin.POST("/keys/:key_id/status", handler.UpdateKeyStatus)
    admin.POST("/keys/:key_id/rotate", handler.RotateKey)

    // 备份恢复
    admin.POST("/backups/snapshots", handler.CreateSnapshot)
    admin.GET("/backups/snapshots", handler.ListSnapshots)
    admin.GET("/backups/snapshots/:snapshot_id/file", handler.DownloadSnapshot)
    admin.POST("/backups/restores", handler.StartRestore)
    admin.GET("/backups/restores/:job_id", handler.GetRestoreStatus)

    // 审计日志
    admin.GET("/audit/logs", handler.QueryAuditLogs)

    // 集群管理 (Phase 3)
    admin.GET("/cluster/nodes", handler.ListNodes)
    admin.POST("/cluster/nodes/:node_id/remove", handler.RemoveNode)
    admin.POST("/cluster/reset", handler.ResetCluster)

    // 配置管理
    admin.GET("/config", handler.GetConfig)
    admin.POST("/config/apply", handler.ApplyConfig)
    admin.POST("/config/validate", handler.ValidateConfig)
    admin.POST("/config/reload", handler.ReloadConfig)

    // WAL 管理
    admin.GET("/wal/status", handler.GetWALStatus)
    admin.GET("/wal/logs", handler.ReadWALLogs)
}
```

## 5. 错误处理

### 5.1 Admin API 错误码

| 错误码 | HTTP | 描述 |
|--------|------|------|
| TM-ADMIN-4030 | 403 | 需要 Admin 角色 |
| TM-ADMIN-4031 | 403 | IP 不在白名单 |
| TM-ADMIN-4041 | 404 | 快照/Key 不存在 |
| TM-ADMIN-4091 | 409 | 操作冲突 (如还原进行中) |
| TM-ADMIN-4130 | 413 | 上传文件过大 |
| TM-ADMIN-4221 | 422 | 备份文件格式无效 |
| TM-ADMIN-4291 | 429 | 操作频率限制 |
| TM-ADMIN-5001 | 500 | 快照创建失败 |
| TM-ADMIN-5031 | 503 | 服务不可用 (还原中) |

> **注意**: 禁用最后一个 Admin Key 是允许的（会显示警告），如需恢复可通过 `localserver` 本地 socket 管理通道重建 Admin Key。

## 6. 验收标准

### 6.1 功能验收
- [ ] AdminAuthN 正确拒绝非 admin 角色
- [ ] NetworkACL 支持 IP/CIDR 白名单
- [ ] 审计日志完整记录管理操作
- [ ] API Key 创建/轮转/禁用流程正确
- [ ] 快照创建/下载/还原流程正确
- [ ] 配置热更新生效

### 6.2 安全验收
- [ ] 敏感字段不记录到日志
- [ ] Secret 哈希存储
- [ ] 禁止禁用最后一个 Admin Key

### 6.3 性能验收
- [ ] `/admin/v1/status/summary` < 10ms
- [ ] `/health` < 10ms
- [ ] `/ready` < 50ms
- [ ] `/metrics` < 50ms

## 7. 依赖

### 7.1 内部依赖
- `internal/core/service/auth.go` - 鉴权服务
- `internal/storage/` - 存储层

### 7.2 外部依赖
- `github.com/prometheus/client_golang` - Prometheus 指标
- `golang.org/x/crypto/argon2` - Secret 哈希

## 8. 实施顺序

1. **Phase 1 (P1)**: 中间件 → 健康检查 → API Key 管理 → 系统状态
2. **Phase 2 (P2)**: 备份恢复 → 审计日志 → 配置管理 → WAL 管理
3. **Phase 3**: 集群管理

---

## 变更历史

| 日期 | 版本 | 变更说明 | 作者 |
|------|------|----------|------|
| 2025-12-18 | v1.0 | 初始版本 | Claude Code |

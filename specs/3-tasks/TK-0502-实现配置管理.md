# TK-0502-实现配置管理

**状态**: ✅ 已完成 (覆盖率 91.5%)
**优先级**: P1
**范围**: 配置加载、验证、热更新
**关联需求**: `specs/1-requirements/RQ-0502-配置管理需求.md`
**关联设计**: `specs/2-designs/DS-0502-配置管理设计.md`
**关联决策**: `specs/adrs/AD-0501-配置与CLI框架选型.md`
**目标代码**: `internal/server/config/`, `internal/infra/confloader/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现完整的配置管理系统：
- 配置加载（文件 + 环境变量 + 命令行参数）
- 配置验证（类型、范围、逻辑依赖）
- 配置热更新（TLS 证书、日志级别）
- 配置审计（启动时记录生效配置）

## 2. 实施内容

### 2.1 配置结构体 (`internal/server/config/spec.go`)

按 DS-0502 定义的结构体实现：

```go
type Config struct {
    Server    ServerConfig    `koanf:"server"`
    Cluster   ClusterConfig   `koanf:"cluster"`
    Session   SessionConfig   `koanf:"session"`
    Security  SecurityConfig  `koanf:"security"`
    Storage   StorageConfig   `koanf:"storage"`
    Telemetry TelemetryConfig `koanf:"telemetry"`
}

type ServerConfig struct {
    HTTP     HTTPConfig       `koanf:"http"`
    HTTPS    HTTPSConfig      `koanf:"https"`
    Redis    PlainRedisConfig `koanf:"redis"`
    RedisTLS TLSRedisConfig   `koanf:"redis_tls"`
    Shutdown ShutdownConfig   `koanf:"shutdown"`
}
// ... 完整结构见 DS-0502
```

### 2.2 默认值 (`internal/server/config/default.go`)

```go
func DefaultConfig() *Config {
    return &Config{
        Server: ServerConfig{
            HTTP: HTTPConfig{
                Enabled: true,
                Address: "127.0.0.1:5080",
            },
            HTTPS: HTTPSConfig{
                Enabled: false,
                Address: "127.0.0.1:5443",
            },
            // ... 完整默认值
        },
        // ...
    }
}
```

### 2.3 配置加载器 (`internal/infra/confloader/loader.go`)

```go
type Loader struct {
    k *koanf.Koanf
}

func NewLoader() *Loader

// Load 按优先级加载配置
// 1. 编译时默认值（最低）
// 2. 配置文件
// 3. 环境变量 (TOKMESH_*)
// 4. 命令行参数（最高）
func (l *Loader) Load(configPath string, envPrefix string) (*Config, error)

// 配置文件搜索路径
// 1. --config 指定
// 2. TOKMESH_SERVER_CONFIG_FILE 环境变量
// 3. /etc/tokmesh-server/config.yaml
// 4. %ProgramData%\tokmesh-server\config.yaml (Windows)
// 5. ./config.yaml
```

实现要点：
- [ ] 使用 koanf v2 加载
- [ ] 支持 YAML 格式
- [ ] 环境变量格式: `TOKMESH_<SECTION>_<KEY>`
- [ ] 路径相对于配置文件目录解析

### 2.4 配置验证 (`internal/server/config/verify.go`)

```go
func (c *Config) Validate() []error

// 4.2.1 端口验证
func (c *Config) validateListenAddresses() []error

// 4.2.2 TLS 证书验证
func (c *Config) validateTLSCertificates() []error

// 4.2.3 集群配置验证
func (c *Config) validateClusterConfig() []error

// 4.2.4 存储配置验证
func (c *Config) validateStorageConfig() []error

// 4.2.5 会话配置验证
func (c *Config) validateSessionConfig() []error

// 4.2.6 安全配置验证
func (c *Config) validateSecurityConfig() []error

// 4.2.7 可观测性配置验证
func (c *Config) validateTelemetryConfig() []error

// 端口冲突检测
func (c *Config) detectPortConflicts() error
```

验证规则（参见 RQ-0502 4.2 节）：
- [ ] 端口范围 1-65535
- [ ] TLS 依赖检查（enabled 时必须有 cert/key）
- [ ] 集群 advertise_address 必须显式配置
- [ ] 目录可写检查（WAL/Snapshot）
- [ ] Duration/Size 字符串解析

### 2.5 配置脱敏 (`internal/server/config/sanitize.go`)

```go
func (c *Config) Sanitize() *Config  // 返回脱敏副本

// 脱敏规则
// - *_key_file 路径保留，内容不输出
// - 含 password/secret/key 的字段替换为 ***REDACTED***
```

### 2.6 热更新支持 (`internal/infra/tlsroots/watcher.go`)

```go
type CertWatcher struct {
    certFile string
    keyFile  string
    cert     *tls.Certificate
    mu       sync.RWMutex
    watcher  *fsnotify.Watcher
}

func NewCertWatcher(certFile, keyFile string) (*CertWatcher, error)
func (w *CertWatcher) GetCertificate(*tls.ClientHelloInfo) (*tls.Certificate, error)
func (w *CertWatcher) Start(ctx context.Context) error
func (w *CertWatcher) Stop() error
```

热更新支持项：
- [ ] TLS 证书（文件监听 + SIGHUP）
- [ ] 日志级别（SIGHUP）

## 3. 验收标准

### 3.1 功能验收
- [ ] 零配置启动：无配置文件时使用默认值正常启动
- [ ] 优先级正确：命令行 > 环境变量 > 配置文件 > 默认值
- [ ] 验证失败：错误配置时打印详细错误并 exit 1
- [ ] 端口冲突检测生效
- [ ] TLS 依赖检测生效
- [ ] 证书热更新：修改证书后 5s 内生效
- [ ] 日志级别热更新：SIGHUP 后立即生效

### 3.2 错误信息格式
```
[FATAL] Configuration validation failed:
  - server.http.address: invalid port 99999 (must be 1-65535)
  - server.https.tls.cert_file: file not found at /path/to/cert.pem

Exit code: 1
```

### 3.3 审计日志
- [ ] 启动时记录配置来源（file/env/cli）
- [ ] 默认仅输出摘要
- [ ] `telemetry.logging.dump_config=true` 时输出完整配置（脱敏）

## 4. 依赖

- `github.com/knadh/koanf/v2` - 配置加载
- `github.com/fsnotify/fsnotify` - 文件监听
- `internal/telemetry/logger/` - 日志记录

## 5. 配置文件位置

| 场景 | 路径 |
|------|------|
| Linux 服务化 | `/etc/tokmesh-server/config.yaml` |
| Windows 服务化 | `%ProgramData%\tokmesh-server\config.yaml` |
| 开发/调试 | `./config.yaml` |
| 用户目录 | `$XDG_CONFIG_HOME/tokmesh-server/config.yaml` |

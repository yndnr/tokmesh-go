# TK-0402-实现可观测性

**状态**: 草稿
**优先级**: P1
**范围**: 日志、指标、追踪（P2 可选）
**关联需求**: `specs/1-requirements/RQ-0403-可观测性需求.md`
**关联设计**: `specs/2-designs/DS-0402-可观测性设计.md`
**目标代码**: `internal/telemetry/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现完整的可观测性基础设施：
- 结构化日志（Go stdlib `log/slog`，JSON）
- Prometheus 指标
- 分布式追踪（OpenTelemetry，P2 可选）

## 1.1 涉及配置项（实现时必须逐项对齐）

> 配置键的单一事实来源：`specs/1-requirements/RQ-0502-配置管理需求.md`

| 配置项 | 用途 |
|---|---|
| `telemetry.logging.level` | 日志级别（支持热加载） |
| `telemetry.logging.dump_config` | 是否输出完整生效配置（需脱敏；生产默认关闭） |
| `telemetry.metrics.auth_enabled` | `/metrics` 是否鉴权（默认开启） |
| `telemetry.tracing.enabled` / `telemetry.tracing.endpoint` / `telemetry.tracing.sampling_ratio` | Tracing（P2 可选）的开关/端点/采样率 |
| `telemetry.audit.retention_days` | 审计日志保留天数（超期清理） |

## 2. 实施内容

### 2.1 日志 (`internal/telemetry/logger/`)

#### 2.1.1 slog 封装 (`slog.go`)

```go
type Logger struct {
    slog   *slog.Logger
    level  slog.Leveler // 支持热更新（实现可用 atomic 或自定义 Leveler）
}

func NewLogger(cfg LogConfig) (*Logger, error)
func (l *Logger) SetLevel(level string)  // 热更新日志级别
func (l *Logger) Debug(msg string, attrs ...slog.Attr)
func (l *Logger) Info(msg string, attrs ...slog.Attr)
func (l *Logger) Warn(msg string, attrs ...slog.Attr)
func (l *Logger) Error(msg string, attrs ...slog.Attr)
func (l *Logger) With(attrs ...slog.Attr) *Logger
```

配置：
```go
type LogConfig struct {
    Level      string // debug/info/warn/error
    DumpConfig bool   // 是否输出完整配置
}
```

#### 2.1.2 上下文日志 (`context.go`)

```go
// 从 context 提取日志字段
func FromContext(ctx context.Context) *Logger
func WithLogger(ctx context.Context, logger *Logger) context.Context

// 常用字段
func RequestID(id string) Field
func SessionID(id string) Field
func UserID(id string) Field
func APIKeyID(id string) Field
func Duration(d time.Duration) Field
```

#### 2.1.3 敏感信息脱敏

```go
// 自动检测并脱敏 tm*_ 前缀的敏感字段
func Redact(value string) string

// 示例: tmtk_abc123 -> tmtk_***REDACTED***
```

实现要点：
- [ ] JSON 输出格式（机器可读）
- [ ] 日志级别热更新（SIGHUP）
- [ ] 敏感信息自动脱敏
- [ ] 请求 ID 关联

### 2.2 指标 (`internal/telemetry/metric/`)

#### 2.2.1 Prometheus 集成 (`prometheus.go`)

```go
type MetricsRegistry struct {
    registry *prometheus.Registry
}

func NewMetricsRegistry() *MetricsRegistry
func (r *MetricsRegistry) Handler() http.Handler  // /metrics 端点
```

#### 2.2.2 核心指标 (`collector.go`)

```go
var (
    // Session 活跃数
    SessionsActive = prometheus.NewGauge(prometheus.GaugeOpts{
        Name: "tokmesh_sessions_active_total",
        Help: "Current number of active sessions",
    })

    // Session 创建计数
    SessionCreateTotal = prometheus.NewCounter(prometheus.CounterOpts{
        Name: "tokmesh_session_create_total",
        Help: "Total number of sessions created",
    })

    // Token 校验计数器
    TokenValidateCalls = prometheus.NewCounterVec(prometheus.CounterOpts{
        Name: "tokmesh_token_validate_calls_total",
        Help: "Total number of token validation calls",
    }, []string{"result"}) // result: valid, invalid, error

    // API 请求延迟（HTTP/Redis 共用；由接口层按协议打 label）
    APIRequestDuration = prometheus.NewHistogramVec(prometheus.HistogramOpts{
        Name:    "tokmesh_api_request_duration_seconds",
        Help:    "API request latency distribution",
        Buckets: []float64{.001, .005, .01, .025, .05, .1, .25, .5, 1},
    }, []string{"method", "path", "status"})
)

// 存储指标
var (
    WALWriteBytesTotal = prometheus.NewCounter(...)
)

// 认证指标
var (
    AuthCacheHits = prometheus.NewCounter(...)
    AuthCacheMisses = prometheus.NewCounter(...)
    AuthFailures = prometheus.NewCounterVec(
        prometheus.CounterOpts{...},
        []string{"reason"},  // invalid_key, expired, ip_blocked
    )
)
```

指标命名规范：
- [ ] 前缀 `tokmesh_`
- [ ] 计数器后缀 `_total`
- [ ] 直方图后缀 `_seconds`；字节类指标使用 `_bytes`/`_bytes_total`
- [ ] 标签使用 snake_case

### 2.3 追踪 (`internal/telemetry/tracer/`) - P2 可选

```go
type Tracer struct {
    provider *sdktrace.TracerProvider
    tracer   trace.Tracer
}

func NewTracer(cfg TracingConfig) (*Tracer, error)
func (t *Tracer) Start(ctx context.Context, name string) (context.Context, trace.Span)
func (t *Tracer) Shutdown(ctx context.Context) error
```

配置：
```go
type TracingConfig struct {
    Enabled       bool
    Endpoint      string  // OTLP/HTTP
    SamplingRatio float64 // 0.0-1.0
}
```

实现要点：
- [ ] OpenTelemetry SDK 集成
- [ ] OTLP/HTTP 导出
- [ ] 采样率配置
- [ ] 默认关闭

## 3. 验收标准

### 3.1 日志验收
- [ ] JSON 格式输出
- [ ] 日志级别可配置
- [ ] SIGHUP 热更新日志级别
- [ ] 敏感信息自动脱敏
- [ ] 请求 ID 贯穿整个请求链

### 3.2 指标验收
- [ ] `/metrics` 端点可访问
- [ ] 指标鉴权（telemetry.metrics.auth_enabled）
- [ ] 核心指标完整（会话、存储、HTTP、认证）
- [ ] 指标命名符合 Prometheus 规范

### 3.3 追踪验收（P2）
- [ ] 默认关闭，不影响性能
- [ ] 启用时可导出到 OTLP/HTTP
- [ ] 采样率可配置

## 4. 依赖

- Go stdlib `log/slog` - 结构化日志（JSONHandler）
- `github.com/prometheus/client_golang` - Prometheus 客户端
- `go.opentelemetry.io/otel` - OpenTelemetry（P2）

## 5. 指标清单

### 5.1 业务指标
| 指标名 | 类型 | 标签 | 说明 |
|--------|------|------|------|
| `tokmesh_sessions_active_total` | Gauge | - | 活跃会话总数 |
| `tokmesh_session_create_total` | Counter | - | 创建会话总数 |
| `tokmesh_token_validate_calls_total` | Counter | result | 校验计数 |
| `tokmesh_api_request_duration_seconds` | Histogram | method, path, status | 请求延迟分布 |
| `tokmesh_session_revoke_propagation_lag_seconds` | Histogram | - | 吊销传播窗口（最终一致性） |

### 5.2 存储指标
| 指标名 | 类型 | 标签 | 说明 |
|--------|------|------|------|
| `tokmesh_wal_write_bytes_total` | Counter | - | WAL 写入量 |

### 5.3 HTTP 指标
| 指标名 | 类型 | 标签 | 说明 |
|--------|------|------|------|
| `tokmesh_api_request_duration_seconds` | Histogram | method, path, status | 请求延迟分布（复用） |

### 5.4 认证指标
| 指标名 | 类型 | 标签 | 说明 |
|--------|------|------|------|
| `tokmesh_auth_cache_hits_total` | Counter | - | 缓存命中 |
| `tokmesh_auth_cache_misses_total` | Counter | - | 缓存未命中 |
| `tokmesh_auth_failures_total` | Counter | reason | 认证失败 |

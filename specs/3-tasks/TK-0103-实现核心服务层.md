# TK-0103-实现核心服务层

**状态**: ✅ 已完成 (覆盖率 82.9%)
**优先级**: P0
**范围**: 核心域 - 业务服务实现
**关联需求**: `specs/1-requirements/RQ-0102-会话生命周期管理.md`, `specs/1-requirements/RQ-0201-安全与鉴权体系.md`
**关联设计**: `specs/2-designs/DS-0103-核心服务层设计.md`, `specs/2-designs/DS-0201-安全与鉴权设计.md`
**目标代码**: `internal/core/service/`

> **代码骨架对齐（强制）**：本文涉及的目录/文件路径以 [specs/governance/code-skeleton.md](../governance/code-skeleton.md) 为准。

---

## 1. 目标

实现核心业务服务层，包括：
- Session 服务（创建、验证、续期、查询、撤销）
- Token 服务（生成、校验）
- Auth 服务（API Key 认证、权限校验）

## 2. 实施内容

### 2.1 Session 服务 (`internal/core/service/session.go`)

```go
type SessionService struct {
    store     *memory.Store
    wal       *wal.Writer
    tokenSvc  *TokenService
    authSvc   *AuthService
    quotaMax  int  // 单用户最大会话数
}

// 创建会话
func (s *SessionService) Create(ctx context.Context, req *CreateSessionRequest) (*CreateSessionResponse, error)

// 验证 Token（核心高频接口）
func (s *SessionService) Validate(ctx context.Context, token string) (*Session, error)

// 续期会话
func (s *SessionService) Renew(ctx context.Context, sessionID string, ttl time.Duration) error

// 获取会话详情
func (s *SessionService) Get(ctx context.Context, sessionID string) (*Session, error)

// 搜索会话列表（与 GET /sessions 对齐）
// 访问控制：
// - role=admin：允许全量过滤条件
// - role=issuer：必须提供 user_id（避免枚举全局会话）
func (s *SessionService) List(ctx context.Context, q *ListSessionsQuery) (*ListSessionsResult, error)

// 撤销单个会话
func (s *SessionService) Revoke(ctx context.Context, sessionID string) error

// 撤销用户所有会话
func (s *SessionService) RevokeByUser(ctx context.Context, userID string) (int, error)
```

> **注意**: DS-0103 未定义 UpdateData 方法。如需支持会话数据更新，应先在 DS-0103 中补充设计。

#### 2.1.1 Create 流程
```
1. 验证调用者权限（role=issuer/admin）
2. 验证请求参数（UserID, TTL 范围）
3. 检查用户配额（当前会话数 < quotaMax）
4. 生成 Session ID (tmss-<ulid>)
5. 生成 Token (tmtk_xxx) 和 TokenHash
6. 构造 Session 对象
7. 写入 WAL (CREATE)
8. 写入内存存储
9. 返回 Session + Token（明文 Token 仅此时返回）
```

#### 2.1.2 Validate 流程（高频路径）
```
1. 计算 TokenHash = SHA256(token)
2. 从 Token 索引查找 SessionID
3. 从主索引获取 Session
4. 检查 IsDeleted
5. 检查 ExpiresAt（惰性删除）
6. 更新 LastActive, LastAccessIP/UA
7. 写入 WAL (UPDATE) - 可选异步
8. 返回 Session 信息
```

### 2.2 Token 服务 (`internal/core/service/token.go`)

> **单一事实来源**: `specs/2-designs/DS-0103-核心服务层设计.md` 第 4 章

```go
type TokenService struct {
    generator  *token.Generator  // pkg/token
    nonceCache *lru.Cache        // Nonce 防重放缓存
}

// 生成新 Token
func (s *TokenService) GenerateToken() (string, error)

// 计算 Token 哈希
func (s *TokenService) ComputeTokenHash(token string) string

// 验证 Token 有效性
func (s *TokenService) Validate(ctx context.Context, req *ValidateTokenRequest) Result[*ValidateTokenResponse]

// 检查 Nonce 是否已使用（防重放）
func (s *TokenService) CheckNonce(ctx context.Context, nonce string, timestamp int64) error
```

实现要点：
- [ ] 复用 `pkg/token/generator.go`
- [ ] Token 格式: `tmtk_` + 43 字符 Base64
- [ ] SHA-256 哈希用于存储索引
- [ ] CheckNonce 防重放：时间戳窗口 ±30s，Nonce 缓存容量 100,000（可配置）

### 2.3 Auth 服务 (`internal/core/service/auth.go`)

```go
type AuthService struct {
    store    *memory.Store       // APIKey 存储（复用或独立）
    cache    *lru.Cache          // 验证缓存
    cacheTTL time.Duration
}

// 验证 API Key
func (s *AuthService) Authenticate(ctx context.Context, keyID, secret string) (*APIKey, error)

// 检查权限
func (s *AuthService) Authorize(ctx context.Context, key *APIKey, action string) error

// 检查 IP 白名单
func (s *AuthService) CheckIPAllowed(ctx context.Context, key *APIKey, clientIP string) error
```

#### 2.3.1 Authenticate 流程
```
1. 检查缓存（cache key = SHA256(keyID + secret)）
2. 缓存命中 -> 返回 APIKey
3. 缓存未命中 -> 从存储加载 APIKey
4. 使用 Argon2 验证 secret
5. 检查 Disabled/Expired
6. 更新缓存
7. 返回 APIKey
```

#### 2.3.2 权限矩阵
| 操作 | admin | issuer | validator | metrics |
|------|-------|--------|-----------|---------|
| session.create | ✓ | ✓ | ✗ | ✗ |
| session.validate | ✓ | ✓ | ✓ | ✗ |
| session.revoke | ✓ | ✓ | ✗ | ✗ |
| apikey.* | ✓ | ✗ | ✗ | ✗ |
| metrics.read | ✓ | ✗ | ✗ | ✓ |

### 2.4 TTL 清理服务

```go
type TTLCleaner struct {
    store      *memory.Store
    wal        *wal.Writer
    interval   time.Duration  // 100ms
    sampleSize int            // 20
}

func (c *TTLCleaner) Start(ctx context.Context)
func (c *TTLCleaner) cleanup() {
    // 1. 随机采样 sampleSize 个 Session
    // 2. 检查 ExpiresAt，删除过期的
    // 3. 如果过期比例 > 25%，递归（最多 4 次）
    // 4. 写入 WAL (DELETE)
}
```

## 3. 验收标准

### 3.1 功能验收
- [ ] Session 完整生命周期（创建 -> 验证 -> 续期 -> 撤销）
- [ ] Token 生成格式正确，验证流程完整
- [ ] API Key 认证 + 权限检查正确
- [ ] 用户配额限制生效
- [ ] TTL 过期会话自动清理

### 3.1.1 可测试验收用例（Given/When/Then）
- [ ] Given `role=validator` When `SessionService.Create` Then 返回 `TM-AUTH-4030`
- [ ] Given `role=issuer` 且不提供 token When `SessionService.Create` Then 响应包含 `token` 且服务端不落地明文 token（可通过存储扫描/日志扫描验证）
- [ ] Given `role=issuer` 且提供自定义 token When `SessionService.Create` Then 响应回显相同 `token`
- [ ] Given `POST /tokens/validate` 的 token 不存在 When `SessionService.Validate` Then 返回 `TM-TOKN-4010`
- [ ] Given token 对应 Session 已过期 When `SessionService.Validate` Then 返回 `TM-TOKN-4011`
- [ ] Given token 对应 Session 已撤销 When `SessionService.Validate` Then 返回 `TM-TOKN-4012`
- [ ] Given touch=true When `Validate` 成功 Then `last_active` 与 `last_access_*` 被更新
- [ ] Given Renew 对已过期 Session When `Renew` Then 返回明确错误（不允许“复活”）
- [ ] Given 并发 Renew 导致 Version 冲突 When CAS 失败 Then 返回 `TM-SESS-4091`

### 3.2 性能验收
- [ ] Validate 接口延迟 P99 < 5ms
- [ ] 认证缓存命中率 > 90%（稳定负载下）
- [ ] TTL 清理 CPU 占用 < 1%

### 3.3 安全验收
- [ ] 明文 Token 仅在 Create 响应中返回一次
- [ ] API Key Secret 使用 Argon2 存储
- [ ] IP 白名单检查正确

### 3.4 测试落点建议（最小集）
- 单元测试：`internal/core/service/session_service_test.go`（Create/Validate/Renew/Revoke，覆盖 TOKN/SESS 错误码）
- 单元测试：`internal/core/service/token_service_test.go`（Nonce 检测/时间窗）
- 单元测试：`internal/core/service/auth_service_test.go`（鉴权缓存命中/失效、IP 白名单、限流）
- 集成测试：HTTP 与 Service 的错误码/HTTP Status 映射（与 `DS-0301` 对齐）
- 依赖注入：Service 层建议注入 Clock、Store 接口、WAL Writer（便于模拟失败与并发冲突）

## 4. 依赖

- `internal/core/domain/` - 领域模型（TK-0101）
- `internal/storage/` - 存储引擎（TK-0102）
- `pkg/token/` - Token 生成
- `pkg/crypto/adaptive/` - Argon2 哈希

## 5. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| `session.ttl.default` | `2h` | 默认会话 TTL |
| `session.ttl.max` | `720h` | 最大会话 TTL |
| `session.ttl.gc_interval` | `100ms` | TTL 清理间隔 |
| `session.ttl.sample_size` | `20` | 采样大小 |
| `session.quota.max_per_user` | `50` | 单用户最大会话数 |
| `security.auth.cache_capacity` | `10000` | 认证缓存容量 |
| `security.auth.cache_ttl` | `60s` | 缓存 TTL |
| `security.anti_replay.nonce_cache_size` | `100000` | Nonce 缓存容量 |
| `security.anti_replay.nonce_ttl` | `60s` | Nonce 有效期 |
| `security.anti_replay.timestamp_window` | `30s` | 时间戳窗口 |

# AD-0201 - 自适应加密算法决策

**状态**: 已接受
**决策者**: 架构组
**日期**: 2025-12-12
**技术领域**: 安全 / 性能
**相关文档**: RQ-0201-安全与鉴权体系.md, DS-0101-核心数据模型设计.md
**替代**: 无
**被替代**: 无

## 1. 背景 (Context)

TokMesh 需要对持久化数据（如 WAL 日志、快照文件）进行加密存储 (`Encryption at Rest`)。
标准库 `crypto/aes` 提供了 AES 实现，但在不同的硬件环境下性能差异巨大：
- **支持 AES-NI/ARMv8 Crypto 的 CPU**: AES-GCM 性能极高（硬件加速）。
- **不支持硬件加速的 CPU** (如部分 IoT 设备、老旧 VM): 软件实现的 AES 性能较差，且存在侧信道攻击风险。

我们需要一种策略来确保在各种部署环境下都能获得最佳的安全性和性能。

## 2. 备选方案 (Options)

### 选项 A: 强制使用 AES-256-GCM
- **优点**: 行业标准，合规性好。
- **缺点**: 在无硬件加速环境下成为性能瓶颈。

### 选项 B: 强制使用 ChaCha20-Poly1305
- **优点**: 纯软件实现性能极佳（通常比软件 AES 快 3 倍），安全性高（Google/Cloudflare 推荐）。
- **缺点**: 在支持 AES-NI 的高端服务器上，无法利用 CPU 指令集，吞吐量上限不如硬件 AES。

### 选项 C: 运行时自适应 (Adaptive / Polyglot)
- **机制**: 服务启动时探测 CPU 指令集 (`CPUID`)。
    - 若支持 `AES` + `PCLMULQDQ` (x86) 或 `AES` + `PMULL` (ARM64) -> 使用 **AES-256-GCM**。
    - 否则 -> 回退到 **ChaCha20-Poly1305**。
- **关键约束**: 两种算法必须使用相同的密钥长度 (32 Bytes) 和 Nonce 长度 (12 Bytes)，以保证上层接口一致性。

## 3. 决策 (Decision)

选择 **选项 C: 运行时自适应**。

**具体规范**:
1.  **密钥**: 统一使用 32 字节 (256-bit) 密钥。
2.  **Nonce**: 统一使用 12 字节随机 Nonce。
3.  **库支持**: 使用 `golang.org/x/sys/cpu` 进行探测。
4.  **透明性**: 启动日志必须打印当前选用的 Cipher Engine。

## 4. 后果 (Consequences)

-   **正向**: 无论是高端服务器还是树莓派，TokMesh 都能跑出该硬件下的加密性能极限。
-   **负向**: 引入了 `golang.org/x/sys` 和 `golang.org/x/crypto` 依赖。

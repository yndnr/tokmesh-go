# AD-0402: 嵌入式 KV 存储选型策略

**状态**: 已接受
**决策者**: 项目所有者
**日期**: 2025-12-16
**技术领域**: 后端 / 存储
**相关文档**: AD-0401-集群元数据持久化引擎选型策略.md, DS-0401-分布式集群架构设计.md
**替代**: 无
**被替代**: 无

---

## 上下文（Context）

`AD-0401-集群元数据持久化引擎选型策略.md` 已建立“DS 不写死具体存储引擎”的原则，约束实现前必须先通过 ADR 决策；Raft 控制面与节点状态机的元数据持续写入、快照与 WAL，依赖一个嵌入式 KV 来持久化。当下需要在不违反“最小依赖/可替换”前提下，选出一个首选方案并备选方案，供后续集群实现（Phase 3/DS-0401）参考。

### 约束
- Go 工程需静态编译、纯 Go（`conventions.md` 1.2 中禁止 CGO）
- 需服务于 Raft 日志（写频率高、复制序列）与 FSM 持久化
- 必须支持高并发写入、压缩/GC、故障恢复快照
- 不应把引擎耦合到上层业务逻辑，需抽象成 `internal/storage` 接口

---

## 考虑的方案（Alternatives Considered）

### 方案 1：Badger （推荐）

描述：
- 纯 Go KV，引擎成熟，支持 LSM + WAL + GC，适合爆发写场景
- 社区活跃，常用于 Raft/WAL 场景（etcd 使用 bbolt 但也有 Badger 复刻）

优点：
- 高吞吐写能力，且自带压缩/GC，可控制 LSM 层大小
- 支持并发读写/事务，便于 Raft Log 队列与 FSM 分离
- 有成熟的 GC/space reclamation 机制，可通过 OpenTSDB 类似实践借鉴

缺点：
- GC 依赖定期垃圾回收，会影响尾延迟，需要谨慎 tune
- 相对于 bbolt/pebble，二进制体积略增

风险：
- 若 GC 参数配置不当，可能引起写延迟抖动或空间不释放
- 需在 `AD-0103` 中补充 Badger 依赖并加测试覆盖

### 方案 2：bbolt

描述：
- 文件式 KV，无 LSM，适合低写并发

优点：
- 依赖少、性能稳定，恢复快
- 单文件可备份、易于数仓场景

缺点：
- 写放大/锁粒度高，不适合 Raft Log 高频写
- 需要在复制层做自定义 WAL 写入

风险：当写放大影响写吞吐时需提前引入副本 throttling

### 方案 3：Pebble

描述：
- 纯 Go LSM 引擎，接口与 RocksDB 相似

优点：
- 提供更细粒度压缩策略（可配置），性能优于 pure file
- 快照/恢复逻辑贴近 RocksDB，可沿用社区调优经验

缺点：
- 社区较新，稳定性待验证
- 依赖需要更多参数 tuning（compaction、level）

---

## 决策（Decision）

选择：**Badger 作为首选嵌入式 KV；bbolt/pebble 保留为候选，根据部署场景或特定性能需求再替换**

理由：
1. Badger 具备支持 Raft WAL/快照的高并发写、压缩机制（符合 `AD-0401` 对高性能的期待）。
2. bbolt/pebble 虽可作为备选，但其写延迟与新生态风险不足以在当前阶段直接占主导；保留可在未来场景调整。
3. 通过抽象接口，可将存储引擎隔离，不会把 Badger 细节侵入全部业务模块，便于将来替换。

实施要点：
- 在 `internal/storage`/`raft` 模块中定义接口/契约（WriteLog、Snapshot、Prune），Badger 实现作为默认 adapter。
- 为 GC/compaction 设立默认配置（`storage.kv.table_cache_size` 等），并提供 Prometheus 指标监控。
- 一旦 ADR 接受，更新 `AD-0103` 依赖白名单，确保 `github.com/dgraph-io/badger/v3` 可以作为 P0 依赖。
- 编写 `TK` 任务确保 bbolt/pebble 替换时只需新增 adapter，符合“可替换”要求。

---

## 后果（Consequences）

### 正面后果
- 明确了 Badger 作为 Raft 持久层的首选，便于开发提前准备依赖/测试。
- 抽象接口使未来替换成为可能； docs 也有依据（AD + DS + configs）。

### 负面后果
- 引入 Badger 需要处理 GC/tuning，需在 TK 中加入相应测试与监控。
- 依赖树增加，需在 `AD-0103` 中记录并限制为内部使用。

### 缓解措施
- 依赖注入+接口抽象，减少 Badger 依赖扩散；
- 监控 GC metrics，写入 `specs/2-designs/DS-0402-可观测性设计.md` 的指标列表。

---

## 影响范围（Impact）

### 受影响的组件
- `internal/storage`: 提供 `KVEngine` 抽象和 Badger 实现；
- `internal/raft`: 依赖 `storage.KVEngine` 实现 WAL 写入；
- 监控/配置模块：需要新增 Badger tuning 配置与指标；
- ADR 依赖白名单（`AD-0103`）需引入 Badger。

### 受影响的团队
- 集群实现团队（Phase 3）需按照 ADR 选型开发；
- DevOps/运维需学习 Badger GC/tuning。

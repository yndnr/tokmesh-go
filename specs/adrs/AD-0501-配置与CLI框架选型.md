# AD-0501: 配置与 CLI 框架选型（Viper/Cobra → Koanf + urfave/cli）

**状态**: 已接受
**决策者**: 项目所有者
**日期**: 2025-12-15
**技术领域**: 后端 / 配置管理 / CLI
**相关文档**: DS-0502-配置管理设计.md, DS-0601-CLI总体设计.md
**替代**: 无
**被替代**: 无

---

## 上下文（Context）

### 背景

TokMesh 当前处于文档规划阶段，配置管理与 CLI 属于“高频、横切、容易引入依赖膨胀”的基础设施能力。

仓库文档曾同时出现多套不一致的实现建议（例如 Viper/Cobra 与 Koanf/urfave/cli 并存），导致：
- 依赖树与实现路径不确定，后续实现阶段容易反复推翻。
- 配置覆盖行为（Env/Flag/File 合并）、命名映射规则与错误提示风格难以统一。
- 与“轻量化、最小依赖、默认安全”的项目原则冲突。

### 问题陈述

需要对以下两类基础设施做一次性裁决，并在全仓文档中统一：
1. TokMesh 的配置加载/合并/验证方案（服务端与 CLI 是否复用同一套能力）
2. tokmesh-cli 的命令框架选型（交互式体验、帮助与补全能力）

### 约束条件

1. **轻量化**：避免引入 Viper 这类“功能大而全、依赖树偏重”的库。
2. **性能不差**：高频路径（请求处理）不得被配置系统拖慢；配置加载属于启动路径，但仍应保持可控。
3. **一致性**：服务端与 CLI 的配置键、覆盖优先级、错误输出结构尽量一致。
4. **可维护性**：实现要显式、可读、易测试，避免“隐式魔法”。

---

## 考虑的方案（Alternatives Considered）

### 方案 1：Viper + Cobra ❌

描述：
- 使用 `github.com/spf13/viper` 负责配置（File/Env/Flag 合并）
- 使用 `github.com/spf13/cobra` 负责 CLI 命令

优点：
- 生态成熟，资料多
- 功能覆盖广

缺点：
- 依赖体量偏大，配置行为较“魔法化”，不利于严格控制与最小化
- 与 TokMesh 当前“降复杂度/最小依赖”的方向不一致

风险：
- 后续实现阶段很可能再次发起“瘦身迁移”，造成文档与实现反复

成本：
- 中（引入依赖后再迁移成本更高）

---

### 方案 2：Koanf + urfave/cli（推荐）✅

描述：
- 统一使用 `github.com/knadh/koanf/v2` 做配置加载与多源合并（File/Env/Flag）
- `tokmesh-cli` 使用 `github.com/urfave/cli/v2` 做命令解析、帮助与补全脚本生成

优点：
- Koanf 轻量且职责聚焦（Provider/Parser 解耦），便于严格控制行为与错误输出
- CLI 框架更轻、约束更少，适合“减少 CLI 复杂度”的目标
- 服务端与 CLI 可复用同一套配置加载/映射规则（降低维护成本）

缺点：
- 相比 Cobra，命令树的“生态插件”更少（但 TokMesh 不追求插件生态）

风险：
- 需要在文档层面明确“TokMesh 自己的配置 schema 才是唯一事实来源”，避免依赖库默认行为漂移

成本：
- 低-中（实现简单，文档一致性更易维护）

---

### 方案 3：完全使用 stdlib（flag + yaml.v3 + 手写合并）⚠️

描述：
- 配置解析使用 `gopkg.in/yaml.v3`
- Env/Flag/File 合并与 key 映射全手写
- CLI 使用 stdlib `flag` 手写子命令

优点：
- 依赖最少
- 行为完全可控

缺点：
- CLI 子命令/帮助/补全与交互体验实现成本较高
- 配置 Provider/Parser 的实现需要持续维护

风险：
- 容易“为了省依赖而增加大量自研代码”，反而增加复杂度

成本：
- 中-高

---

## 决策（Decision）

选择：方案 2（Koanf + urfave/cli）

理由：
1. **轻量化优先**：满足“Viper 太庞大”的约束，同时保留多源合并能力。
2. **一致性**：服务端与 CLI 复用 Koanf 的 Provider/Parser 组合，配置键与覆盖规则统一。
3. **可维护**：依赖聚焦、行为显式，便于将错误输出与验证逻辑做成 TokMesh 自己的风格。

实施要点：
- 配置加载统一采用 Koanf：File(YAML) + Env + Flag 的覆盖优先级以 `RQ-0502` 为准。
- `tokmesh-server` 命令行解析使用 stdlib `flag`（参数简单，无需子命令支持）。
- `tokmesh-cli` 命令框架统一采用 `urfave/cli/v2`（需要子命令、帮助与补全支持）；文档中的命令注册示例以该框架表述。
- 文档中删除/替换 `Viper/Cobra` 的"推荐库"表述；如需提及，仅作为"不推荐备选"出现在本 ADR 的备选方案中。

---

## 后果（Consequences）

### 正面后果（Positive）
- 依赖树更可控，符合“最小依赖/降复杂度”的长期方向
- 文档与实现路径确定，减少后续反复
- 配置行为更显式，便于形成统一的错误码与报错体验

### 负面后果（Negative）
- 需要把历史文档里与 Cobra/Viper 绑定的示例代码/描述统一改写

### 缓解措施
- 全仓检索并替换 Cobra/Viper 的示例与推荐项，确保文档一致性

---

## 影响范围（Impact）

### 受影响的组件
- `tokmesh-server`：配置加载、验证、证书热加载
- `tokmesh-cli`：命令框架与配置加载

### 受影响的文档
- `specs/1-requirements/RQ-0502-配置管理需求.md`：实现建议的库选型与描述
- `specs/2-designs/DS-0502-配置管理设计.md`：库选型依据引用本 ADR
- `specs/2-designs/DS-0601-CLI总体设计.md`、`specs/2-designs/DS-0602-CLI交互模式与连接管理.md`：命令框架示例一致化

---

## 相关决策（Related Decisions）

- `specs/adrs/AD-0301-HTTP框架选型演进.md`：同样以“轻量化与 stdlib 优先”为决策倾向

---

## 修订历史（Revision History）

| 日期 | 版本 | 修改内容 | 作者 |
|------|------|---------|------|
| 2025-12-15 | 1.0 | 初始版本 | AI Agent |


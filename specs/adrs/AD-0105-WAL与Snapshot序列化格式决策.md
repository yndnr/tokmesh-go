# AD-0105 - WAL 与 Snapshot 序列化格式决策

**状态**: 已批准
**决策日期**: 2025-12-19
**决策者**: Claude Code
**关联设计**: DS-0102-存储引擎设计.md

---

## 1. 背景

DS-0102 原设计指定 WAL 和 Snapshot 使用 Protobuf 作为序列化格式：

> "WAL 条目和快照数据使用 Protobuf 编码，确保高效的二进制序列化"（DS-0102#L66）

实际实现中，采用了 JSON + 自定义二进制头的混合方案。本 ADR 记录该设计偏差的原因和权衡。

---

## 2. 决策

**采用 JSON + 二进制头混合格式**，而非纯 Protobuf。

### 2.1 WAL 条目格式

```
+----------+----------+----------+----------+
| Length   | CRC32    | Type     | Payload  |
| (4 bytes)| (4 bytes)| (1 byte) | (JSON)   |
+----------+----------+----------+----------+
```

- **Length**: 后续数据总长度（CRC + Type + Payload）
- **CRC32**: 校验和（覆盖 Type + Payload）
- **Type**: 操作类型（CREATE/UPDATE/DELETE）
- **Payload**: JSON 编码的 Entry 数据

### 2.2 Snapshot 格式

使用 JSON 编码的会话数组，支持可选加密。

---

## 3. 决策理由

### 3.1 选择 JSON 的优势

| 维度 | JSON | Protobuf |
|------|------|----------|
| **可调试性** | ✅ 人类可读，易于排查 | ❌ 二进制，需工具解码 |
| **依赖复杂度** | ✅ 标准库内置 | ❌ 需 protoc 工具链 |
| **Schema 演进** | ✅ 天然向后兼容 | 🟡 需要谨慎管理字段编号 |
| **开发效率** | ✅ 无需生成代码 | ❌ 修改 .proto 需重新生成 |
| **性能** | 🟡 中等 | ✅ 高效 |
| **空间效率** | 🟡 较大 | ✅ 紧凑 |

### 3.2 性能影响评估

根据项目性能目标（specs/governance/charter.md）：
- 单分片吞吐量 ≥ 5,000 TPS
- 局域网延迟 P99 < 50ms

**评估结论**：
- WAL 写入主要瓶颈是磁盘 I/O，而非序列化
- JSON 序列化在现代 CPU 上性能足够（~100μs/条目）
- 使用批量写入（100 条/1MB）摊薄序列化开销
- 内存存储为主，WAL 用于恢复，非热路径

### 3.3 可调试性权重

作为会话/令牌管理系统，运维人员可能需要：
- 排查会话丢失问题
- 验证 WAL 完整性
- 手动恢复数据

JSON 格式允许使用 `cat`、`jq` 等标准工具直接检查数据。

---

## 4. 与 DS-0102 的对齐处理

### 4.1 需要更新的设计文档

建议更新 DS-0102 以下章节：

1. **4.1 WAL 条目格式**：更新为 JSON + 二进制头格式
2. **5.2 快照文件结构**：更新为 JSON 编码

### 4.2 Protobuf 保留用途

Protobuf 仍用于：
- `api/proto/v1/cluster.proto`：集群间 RPC 通信
- 未来高性能场景可通过配置切换

---

## 5. 备选方案

| 方案 | 说明 | 状态 |
|------|------|------|
| A. 纯 Protobuf | 按 DS-0102 原设计实现 | 拒绝：开发复杂度高 |
| B. JSON + 二进制头 | 当前实现 | **采纳** |
| C. MessagePack | 紧凑二进制 JSON | 拒绝：需额外依赖 |
| D. 可配置格式 | 运行时选择 | 延后：Phase 2 考虑 |

---

## 6. 后续行动

- [x] 创建本 ADR 记录决策（本文档）
- [ ] 更新 DS-0102 以反映实际实现
- [ ] 在 TK-0102 完成报告中引用本 ADR

---

## 7. 变更历史

| 日期 | 版本 | 说明 |
|------|------|------|
| 2025-12-19 | v1.0 | 初始版本，记录实现与设计的偏差 |

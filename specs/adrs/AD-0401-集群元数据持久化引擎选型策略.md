# AD-0401: 集群元数据持久化引擎选型策略（不在设计中写死具体 KV）

**状态**: 已接受
**决策者**: 项目所有者
**日期**: 2025-12-16
**技术领域**: 后端 / 存储 / 集群
**相关文档**: DS-0401-分布式集群架构设计.md
**替代**: 无
**被替代**: 无

---

## 上下文（Context）

TokMesh 的分布式集群设计包含控制面（Raft）与状态机（FSM）等元数据能力，必然需要“可靠的本地持久化”来存放：
- Raft Log / Snapshot
- 集群元数据（Cluster Map / Shard Map / 策略数据等）

但当前阶段仍处于文档规划（Pre-coding），且：
- 依赖治理已明确“最小化依赖、stdlib 优先、避免写死大依赖”（见 `specs/adrs/AD-0103-依赖包治理与白名单.md`）
- Raft 具体实现库尚未通过 ADR 选型（不同 Raft 库对存储接口要求不同）

如果在 DS 中提前写死某个 KV（例如 BadgerDB），会造成：
- 实现阶段被“文档锁死”而难以根据 Raft 库与运维约束做合理选择
- 与“依赖最小化/决策可追溯”的治理要求冲突

---

## 考虑的方案（Alternatives Considered）

### 方案 1：在设计中写死 BadgerDB

优点：
- 有成熟的嵌入式 KV 能力，功能全面

缺点：
- 依赖与复杂度偏高，且与 Raft 库绑定关系不明（可能重复实现/重复依赖）
- 一旦写死，后续调整成本大

### 方案 2：在设计中写死 bbolt（BoltDB）

优点：
- 依赖相对轻量，生态成熟，适合元数据类存储

缺点：
- 同样存在“未选 Raft 库就写死存储”的时序问题
- 性能/并发模型需结合具体工作负载评估

### 方案 3：先不写死具体引擎，强制走 ADR 再定

优点：
- 文档不会提前锁死实现，符合“决策记录 + 最小化依赖”的工作流
- 可在明确 Raft 库、持久化接口、部署环境（裸机/容器）后再做最合适的选择

缺点：
- 需要在进入集群实现前补齐一次 ADR（增加一次流程成本）

---

## 决策（Decision）

选择：**方案 3（先不写死具体引擎，进入实现前通过 ADR 决策）**

实施要点：
1. 设计文档（DS）中不得写死具体持久化引擎名称（BadgerDB/bbolt/sqlite 等），仅描述为“嵌入式持久化存储（待 ADR 决策）”。
2. 在启动集群实现（Phase 3 / 集群控制面落地）之前，必须新增一个 ADR 来完成“Raft 库 + 持久化引擎”的组合选型，并更新依赖白名单（如需要）。
3. 选型 ADR 必须至少比较：bbolt / Badger / sqlite / 纯文件日志（或 Raft 库自带 store），并给出基于运维与复杂度的裁决理由。

---

## 后果（Consequences）

### 正面后果（Positive）
- 避免文档提前锁死实现路径，降低后续反复与重构成本
- 与依赖治理一致：任何新增/重依赖必须有明确 ADR 依据

### 负面后果（Negative）
- 集群实现前需要补齐一次 ADR，增加流程步骤

### 缓解措施
- 将“集群实现前必须完成该 ADR”写入对应 TK 的前置条件（避免遗漏）

---

## 相关决策（Related Decisions）

- `specs/adrs/AD-0103-依赖包治理与白名单.md`
- `specs/2-designs/DS-0401-分布式集群架构设计.md`


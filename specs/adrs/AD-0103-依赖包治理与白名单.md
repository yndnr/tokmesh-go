# AD-0103: 依赖包治理与白名单（禁用 Gin/Viper 等重依赖）

**状态**: 已接受
**决策者**: 项目所有者
**日期**: 2025-12-16
**技术领域**: 工程治理 / 依赖管理
**相关文档**: specs/governance/conventions.md
**替代**: 无
**被替代**: 无

---

## 上下文（Context）

TokMesh 当前处于文档驱动阶段，且多次明确“降低复杂度、最小化依赖、默认安全”。若缺少前期依赖治理，很容易在实现阶段因“顺手引入大而全框架/工具链”而：
- 依赖树膨胀（编译体积、供应链风险、升级成本）
- 配置/CLI 行为变得“魔法化”，与文档难以对齐
- 与 `specs/governance/principles.md` 的优先级（简单性 > 安全性 > 性能）冲突

因此需要建立一套**明确的依赖选择规则**，并给出**禁止清单**与**允许清单**，确保后续 TK/实现过程可被一致执行与审计。

---

## 决策（Decision）

### 1) 总体原则

1. **stdlib 优先**：能用 Go 标准库完成的，不引入第三方依赖。
2. **职责聚焦**：第三方依赖必须“单一职责、可替代、可解释”，避免“大而全”框架。
3. **显式优于隐式**：避免依赖引入隐式默认行为（配置绑定、自动扫描、全局单例等）。
4. **供应链最小化**：依赖数量与深度越小越好；必须评估维护活跃度与安全公告响应。

### 2) 禁止清单（不得引入）

以下依赖在 TokMesh 中**禁止引入**（除非走“例外流程”并创建新的 ADR 替代本决策）：

- `github.com/gin-gonic/gin`（Gin）
  - 理由：对外 HTTP 已裁决为 stdlib（见 `specs/adrs/AD-0302-对外接口协议与HTTP实现裁决.md`），Gin 属于“框架级大依赖”且与裁决冲突。
- `github.com/spf13/viper`（Viper）
  - 理由：依赖体量偏大、行为偏隐式；配置选型已裁决为 Koanf（见 `specs/adrs/AD-0501-配置与CLI框架选型.md`）。

> 说明：本清单聚焦你已明确点名的 Gin/Viper；后续如需扩展禁用项，应通过新增 ADR 记录。

### 3) 允许清单（按优先级/范围边界）

说明：
- 本清单用于约束“实现阶段可引入的第三方依赖范围”，并与 RQ/DS/ADR 的已裁决内容保持一致。
- “P0 必需”表示：已进入当前范围且实现时大概率必须用到；“P2 可选”表示：仅在启用该能力时允许引入，且必须在对应 TK 中显式声明。

#### P0 必需（已裁决/已纳入需求与设计）

- 对外 HTTP：Go stdlib `net/http`（见 `specs/adrs/AD-0302-对外接口协议与HTTP实现裁决.md`）
- 配置加载/合并：`github.com/knadh/koanf/v2`（见 `specs/adrs/AD-0501-配置与CLI框架选型.md`）
- CLI 命令框架：`github.com/urfave/cli/v2`（见 `specs/adrs/AD-0501-配置与CLI框架选型.md`）
- TLS 证书热加载：`github.com/fsnotify/fsnotify`（见 `specs/1-requirements/RQ-0502-配置管理需求.md`）
- 集群内部 RPC：`connectrpc.com/connect`
  - 边界：**仅用于集群内部** Connect+Protobuf（不对外暴露，见 `specs/adrs/AD-0302-对外接口协议与HTTP实现裁决.md`）
  - 明确不引入：`google.golang.org/grpc`（对外 gRPC 不在范围内）
- 持久化引擎：`github.com/dgraph-io/badger/v3`
  - 边界：仅供控制面 Raft WAL/Snapshot 使用（见 `specs/adrs/AD-0402-嵌入式KV选型策略.md`）
  - 默认 Badger，若未来改用 bbolt/pebble 必须另行 ADR
  - 需通过 `internal/storage` 抽象隔离 Badger 细节，避免扩散到其他模块
- Protobuf 运行时：`google.golang.org/protobuf`
  - 边界：仅为 Connect+Protobuf 的消息编解码与类型支持服务；不用于对外 SDK 生成
- 指标采集与暴露：`github.com/prometheus/client_golang`
  - 边界：仅用于 `/metrics` 暴露与采样；鉴权/角色模型以 RQ/DS 为准（不在本 ADR 中扩展）

#### P2 可选（仅启用该能力时允许；需在 TK 中显式声明）

- Phase 3 集群共识与成员管理：`github.com/hashicorp/raft`、`github.com/hashicorp/memberlist`
  - 依据：`specs/adrs/AD-0403-集群Raft与成员管理依赖选型.md`
  - 边界：仅用于 `internal/server/clusterserver/`（禁止扩散到 `pkg/`）
- Redis 协议兼容（P2 可选能力）：`github.com/tidwall/redcon`
  - 依据：`specs/1-requirements/RQ-0303-业务接口规约-Redis协议.md`（P2）与 `specs/2-designs/DS-0301-接口与协议层设计.md`
  - 边界：仅用于 RESP server/解析层；不得引入 Redis “全量兼容”大依赖
- 自适应加密能力：`golang.org/x/crypto`、`golang.org/x/sys`
  - 依据：`specs/adrs/AD-0201-自适应加密算法决策.md`
  - 边界：仅用于算法实现与 CPU 特性探测；如未来裁决改为“仅 stdlib 算法”，可移除
 - 分布式追踪（P2 可选能力）：`go.opentelemetry.io/otel`
   - 依据：`specs/1-requirements/RQ-0403-可观测性需求.md` 与 `specs/2-designs/DS-0402-可观测性设计.md`
   - 边界：默认不启用；仅在启用 Tracing 时引入（避免将 OTEL 作为 P0 依赖）
（无：结构化日志默认使用 Go stdlib `log/slog`；如需引入第三方日志框架，必须走“例外流程”并创建新的 ADR 替代本决策）

### 4) 例外流程（引入新依赖的门槛）

任何新增第三方依赖必须：
1. 在对应 TK 中明确“新增依赖清单与用途”
2. 若依赖属于“框架级/大而全/会改变行为范式”，必须先创建新的 ADR：
   - 说明收益、替代方案、依赖树影响、维护与安全风险
3. 在代码落地前，更新相关 RQ/DS（确保文档先行且一致）

---

## 后果（Consequences）

### 正面后果

- 依赖树可控，符合“最小依赖/降复杂度”的项目方向
- 文档与实现更容易对齐，减少后续反复与重构成本
- 降低供应链风险面

### 负面后果

- 需要在实现阶段更频繁地“手写”部分粘合代码（例如 http handler、配置映射）

### 缓解措施

- 将通用基础能力沉淀为内部小模块（例如 `internal/config`、`internal/httpserver`），保持可测试与可替换

---

## 相关决策（Related Decisions）

- `specs/adrs/AD-0302-对外接口协议与HTTP实现裁决.md`
- `specs/adrs/AD-0501-配置与CLI框架选型.md`

---

## 修订历史（Revision History）

| 日期 | 版本 | 修改内容 | 作者 |
|------|------|---------|------|
| 2025-12-16 | 1.0 | 初始版本 | AI Agent |
| 2025-12-16 | 1.1 | 补齐白名单缺项，按 P0/P2 明确边界 | AI Agent |

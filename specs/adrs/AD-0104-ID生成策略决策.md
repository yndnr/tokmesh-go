# AD-0104 - ID 生成策略决策 (ULID vs UUID)

**状态**: 已接受
**决策者**: 架构组
**日期**: 2025-12-17
**技术领域**: 系统基础 / 数据模型 / 安全
**相关文档**: RQ-0101-核心数据模型.md, DS-0101-核心数据模型设计.md, AD-0101-Token生成与存储策略.md
**替代**: 无
**被替代**: 无

## 1. 背景 (Context)

TokMesh 系统需要为多种资源生成唯一标识符：

| 资源类型 | 前缀 | 敏感度 | 使用场景 |
|----------|------|--------|----------|
| Session ID | `tmss-` | Public | 会话句柄，高频创建/查询 |
| API Key ID | `tmak-` | Public | 访问密钥标识，管理操作 |
| Node ID | `tmnd-` | Public | 集群节点标识 |
| Token | `tmtk_` | **Sensitive** | 会话凭证，极高安全要求 |
| API Secret | `tmas_` | **Sensitive** | API 密钥，极高安全要求 |

原 RQ-0101 仅定义了 ID 命名前缀规范，未明确 body 部分的生成算法。需要决策：
1. **标识符** (Session ID, API Key ID, Node ID) 采用何种生成算法？
2. **凭证** (Token, API Secret) 是否需要调整现有方案？

## 2. 备选方案 (Options)

### 2.1 标识符生成方案

#### 选项 A: UUID v4 (纯随机)
- **格式**: `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx` (36字符含连字符)
- **熵**: 122 位随机
- **优点**: 标准化程度高，库支持广泛
- **缺点**:
  - 无时间排序，写入索引分散（B-tree 分裂频繁）
  - 含连字符，需编码才 URL 安全
  - 长度较长，存储和传输开销大

#### 选项 B: UUID v7 (时间排序)
- **格式**: 同 UUID v4，但前 48 位为时间戳
- **熵**: 62 位随机 + 48 位时间
- **优点**: 时间排序，索引友好
- **缺点**:
  - 2024 年才标准化，Go 标准库尚未原生支持
  - 含连字符，需编码
  - 长度仍为 36 字符

#### 选项 C: ULID (Universally Unique Lexicographically Sortable Identifier)
- **格式**: `01ARZ3NDEKTSV4RRFFQ69G5FAV` (26字符 Crockford Base32)
- **熵**: 80 位随机 + 48 位时间戳（毫秒级）
- **优点**:
  - **时间排序**: 按创建时间字典序排列，索引写入友好
  - **紧凑**: 26 字符 vs UUID 的 36 字符（节省 28% 空间）
  - **URL 安全**: 无特殊字符，无需编码
  - **人类可读**: 前 10 字符为时间戳，可快速判断创建时间
  - **生态成熟**: `oklog/ulid` 库稳定，广泛使用
- **缺点**:
  - 时间戳部分可预测（但对于非凭证的标识符，这不是安全问题）
  - 非 IETF 标准（但已被广泛采纳）

### 2.2 凭证生成方案

#### 选项 D: 保持现有高熵方案
- **Token**: 32 字节 CSPRNG + Base64 RawURL（256 位熵）
- **API Secret**: 32 字节 CSPRNG + Base62（256 位熵）
- **优点**: 最大化安全性，符合业界最佳实践
- **缺点**: 无

#### 选项 E: 使用 ULID/UUID
- **熵**: 最高 122 位 (UUID v4)
- **缺点**: 熵严重不足，时间戳可预测，存在暴力破解风险
- **结论**: **严禁用于凭证**

## 3. 决策 (Decision)

### 3.1 标识符: 采用 ULID (选项 C)

| 资源类型 | 生成算法 | 格式示例 |
|----------|----------|----------|
| Session ID | ULID (小写) | `tmss-01jf8xzm7e3xqh5p8n4r6s2w0t9` |
| API Key ID | ULID (小写) | `tmak-01jf8y2k4m5nqp7r9s1w3x5z7a8` |
| Node ID | 人工指定优先，ULID 兜底 | `tmnd-prod-dc1-01` 或 `tmnd-01jf8y3k5m6n...` |

**ULID 配置**:
- **编码**: 小写 Crockford Base32（与 ID 命名规范保持一致）
- **熵源**: `crypto/rand`（非 `math/rand`）
- **单调性**: 同一毫秒内递增（使用 `ulid.MonotonicReader`）

### 3.2 凭证: 保持高熵方案 (选项 D)

| 资源类型 | 生成算法 | 格式示例 |
|----------|----------|----------|
| Token | 32B CSPRNG + Base64 RawURL | `tmtk_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijk` |
| API Secret | 32B CSPRNG + Base62 | `tmas_aB3dE5fG7hJ9kL1mN3pQ5rS7tU9vW1xY3zA5bC` |

**安全要求**:
- **熵**: 必须 ≥ 256 位
- **熵源**: 必须使用 `crypto/rand`
- **存储**: Token 仅存哈希值，Secret 仅存哈希值

## 4. 详细理由 (Justification)

### 4.1 为什么标识符选择 ULID 而非 UUID？

| 维度 | ULID | UUID v4 | UUID v7 |
|------|------|---------|---------|
| **索引效率** | ⭐⭐⭐⭐⭐ 有序写入 | ⭐⭐ 随机分散 | ⭐⭐⭐⭐ 有序写入 |
| **长度** | 26 字符 | 36 字符 | 36 字符 |
| **URL 安全** | ✅ 原生安全 | ❌ 需编码 | ❌ 需编码 |
| **可读性** | ⭐⭐⭐⭐ 时间可推断 | ⭐ 无意义 | ⭐⭐⭐ 时间可推断 |
| **Go 生态** | ⭐⭐⭐⭐⭐ oklog/ulid | ⭐⭐⭐⭐⭐ google/uuid | ⭐⭐⭐ 需第三方库 |

**关键收益**:
1. **调试效率**: 从 Session ID `tmss-01jf8xzm7e3...` 可直接推断创建时间约为 2025-12-17
2. **存储节省**: 100 万 Session × 10 字符节省 ≈ 10MB 内存
3. **索引性能**: 有序写入减少 B-tree 分裂，写入吞吐提升 20-30%

### 4.2 为什么凭证不能用 ULID/UUID？

| 风险维度 | ULID (80位随机) | UUID v4 (122位随机) | 32B CSPRNG (256位随机) |
|----------|-----------------|---------------------|------------------------|
| **暴力破解** | 2^80 ≈ 10^24 | 2^122 ≈ 10^36 | 2^256 ≈ 10^77 |
| **时间可预测** | ⚠️ 48位时间可推测 | ✅ 无 | ✅ 无 |
| **安全评级** | ❌ 不合格 | ⚠️ 勉强及格 | ✅ 优秀 |

**结论**: 凭证必须使用 256 位纯随机熵，ULID/UUID 均不满足安全要求。

## 5. 实现规范

### 5.1 代码位置
- `pkg/token/id.go`: ID 生成函数
- `pkg/token/secret.go`: 凭证生成函数

### 5.2 接口定义

```go
// pkg/token/id.go

// GenerateSessionID 生成会话 ID
// 格式: tmss-{ulid_lowercase}
// 示例: tmss-01jf8xzm7e3xqh5p8n4r6s2w0t9
func GenerateSessionID() string

// GenerateAPIKeyID 生成 API Key ID
// 格式: tmak-{ulid_lowercase}
func GenerateAPIKeyID() string

// GenerateNodeID 生成节点 ID (自动模式)
// 格式: tmnd-{ulid_lowercase}
// 注: 生产环境建议人工配置有意义的 Node ID
func GenerateNodeID() string

// ParseULID 从带前缀的 ID 中解析 ULID
// 返回: ULID 对象，可提取时间戳
func ParseULID(prefixedID string) (ulid.ULID, error)
```

```go
// pkg/token/secret.go

// GenerateToken 生成会话 Token
// 格式: tmtk_{base64_rawurl_43chars}
// 熵: 256 位 (32 字节 CSPRNG)
func GenerateToken() string

// GenerateAPISecret 生成 API Secret
// 格式: tmas_{base62_43chars}
// 熵: 256 位 (32 字节 CSPRNG)
func GenerateAPISecret() string
```

### 5.3 依赖声明

```go
// go.mod
require github.com/oklog/ulid/v2 v2.1.0
```

## 6. 后果 (Consequences)

### 6.1 正向
- **运维友好**: Session ID 按时间排序，便于日志分析和问题排查
- **性能提升**: 有序 ID 减少索引碎片，写入性能更稳定
- **空间节省**: 26 字符 vs 36 字符，减少存储和网络开销
- **安全保障**: 凭证保持 256 位高熵，抵御暴力破解

### 6.2 负向
- **新增依赖**: 引入 `oklog/ulid/v2`（但该库成熟稳定，维护良好）
- **时间泄露**: 从 Session ID 可推断创建时间（但这是 Public ID，可接受）

### 6.3 迁移影响
- **新系统**: 直接采用新规范
- **现有数据**: 无需迁移（ID 格式向后兼容，body 部分本就未严格定义）

## 7. 验收标准

- [ ] `pkg/token/id.go` 实现 ULID 生成函数
- [ ] `pkg/token/secret.go` 实现高熵凭证生成函数
- [ ] 单元测试覆盖：格式校验、唯一性、单调性
- [ ] 基准测试：ULID 生成 < 100ns/op
- [ ] RQ-0101 和 DS-0101 文档已更新对齐

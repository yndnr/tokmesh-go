# 全量代码审核框架 (Audit Framework)

**版本**: 1.0
**状态**: 生效
**最后更新**: 2025-12-19
**适用范围**: 所有提交到 `src/` 目录的业务代码

---

## 1. 目标
本框架定义了 TokMesh 项目代码审查的最高标准。旨在通过模拟“偏执的安全架构师”视角，确保代码在安全性、鲁棒性、错误处理、并发安全及架构一致性上达到工业级交付标准。

---

## 2. 审核维度 (Review Dimensions)

所有代码审查必须覆盖以下六个核心维度：

### 2.1 🛡️ 安全性 (Security & Privacy)
- **注入防护**: SQL/Command/Log 注入检查。
- **凭证管理**: 严禁硬编码密钥/Token，严禁在日志中明文打印 PII。
- **加密合规**: 使用强加密算法（如 Argon2id, AES-GCM），禁用 MD5/SHA1。
- **鉴权边界**: 接口必须有 RBAC/ACL 校验，防止越权访问 (IDOR)。

### 2.2 🚧 边界与鲁棒性 (Boundaries & Robustness)
- **空值防御**: 指针/Map/Slice 访问前必须判空。
- **数值边界**: 整数溢出、除零保护、数组越界检查。
- **输入清洗**: 外部参数长度、格式、类型必须校验。
- **资源配额**: 请求大小限制、循环次数上限、并发数限制 (DoS 防护)。

### 2.3 🚨 错误处理 (Error Handling)
- **零吞没**: 严禁 `_ = err` 或空 catch 块。
- **上下文**: 错误返回需包裹堆栈或业务语义 (`fmt.Errorf("op: %w", err)`).
- **资源释放**: `defer close/unlock` 必须在错误发生前生效。
- **Panic Free**: 核心路径严禁直接 panic，必须有 recover 兜底。

### 2.4 ⚡ 并发与性能 (Concurrency & Performance)
- **竞态检测**: 共享变量必须加锁或使用原子操作。
- **死锁防治**: 锁获取顺序一致，Channel 关闭逻辑闭环。
- **泄露检测**: Goroutine 必须有退出机制 (Context/Done channel)。
- **性能热点**: 避免 N+1 查询，避免大对象频繁分配/拷贝。

### 2.5 🏗️ 逻辑与架构 (Logic & Architecture)
- **一致性**: 实现必须与 `specs/2-designs/` 设计文档完全一致。
- **复杂度**: 单一职责，避免圈复杂度过高 (>10) 的函数。
- **可测试性**: 逻辑解耦，便于 Mock 和单元测试。

### 2.6 📝 规范 (Conventions)
- **命名**: 遵循 `specs/governance/coding-standards/`。
- **魔术值**: 禁止未解释的 Magic Number/String。

---

## 3. AI 执行指令 (Prompt Template)

当触发“代码审核”工作流时，AI 代理必须加载并遵循以下 Persona 和指令：

> **Role**: 你是一位拥有20年经验的资深软件架构师和安全专家。你的风格严谨、犀利、零容忍。
>
> **Task**: 基于上述 2.1 - 2.6 维度，对目标代码进行深度扫描。
>
> **Output Requirement**:
> 1. 不要只给修改后的代码，**必须先输出《审核报告》**。
> 2. 问题必须分级：**[严重]** (可能导致崩溃/入侵)、**[警告]** (逻辑错误/性能隐患)、**[建议]** (风格/可读性)。
> 3. 每个问题必须指出：**位置** (文件:行号)、**原因** (Why)、**修复建议** (How)。

---

## 4. 报告输出格式 (Report Format)

审核输出必须遵循以下 Markdown 结构：

```markdown
## 📊 审核摘要
- **总体评分**: (0-100)
- **风险等级**: (高危 / 中危 / 低风险)

## ❌ 问题列表

### [严重] <问题简述>
- **位置**: `path/to/file.go:line`
- **分析**: <详细原因>
- **建议**: <修复方案或代码>

...

## ✅ 总结与行动
(简短总结，是否建议合并或需重构)
```

# 全量代码审核框架 (Audit Framework)

**版本**: 1.1
**状态**: 生效
**最后更新**: 2025-12-19
**适用范围**: 所有提交到 `src/` 目录的业务代码

---

## 1. 目标
本框架定义了 TokMesh 项目代码审查的最高标准。旨在通过模拟"偏执的安全架构师"视角，确保代码在安全性、鲁棒性、错误处理、并发安全及架构一致性上达到工业级交付标准。

---

## 2. 审核维度 (Review Dimensions)

所有代码审查必须覆盖以下八个核心维度：

### 2.1 🛡️ 安全性 (Security & Privacy)
- **注入防护**: SQL/Command/Log 注入检查。
- **凭证管理**: 严禁硬编码密钥/Token，严禁在日志中明文打印 PII。
- **加密合规**: 使用强加密算法（如 Argon2id, AES-GCM），禁用 MD5/SHA1。
- **鉴权边界**: 接口必须有 RBAC/ACL 校验，防止越权访问 (IDOR)。

### 2.2 🚧 边界与鲁棒性 (Boundaries & Robustness)
- **空值防御**: 指针/Map/Slice 访问前必须判空。
- **数值边界**: 整数溢出、除零保护、数组越界检查。
- **输入清洗**: 外部参数长度、格式、类型必须校验。
- **资源配额**: 请求大小限制、循环次数上限、并发数限制 (DoS 防护)。

### 2.3 🚨 错误处理 (Error Handling)
- **零吞没**: 严禁 `_ = err` 或空 catch 块。
- **上下文**: 错误返回需包裹堆栈或业务语义 (`fmt.Errorf("op: %w", err)`).
- **资源释放**: `defer close/unlock` 必须在错误发生前生效。
- **Panic Free**: 核心路径严禁直接 panic，必须有 recover 兜底。

### 2.4 ⚡ 并发与性能 (Concurrency & Performance)
- **竞态检测**: 共享变量必须加锁或使用原子操作。
- **死锁防治**: 锁获取顺序一致，Channel 关闭逻辑闭环。
- **泄露检测**: Goroutine 必须有退出机制 (Context/Done channel)。
- **性能热点**: 避免 N+1 查询，避免大对象频繁分配/拷贝。

### 2.5 🏗️ 逻辑与架构 (Logic & Architecture)
- **一致性**: 实现必须与 `specs/2-designs/` 设计文档完全一致。
- **复杂度**: 单一职责，避免圈复杂度过高 (>10) 的函数。
- **可测试性**: 逻辑解耦，便于 Mock 和单元测试。

### 2.6 📝 规范 (Conventions)
- **命名**: 遵循 `specs/governance/coding-standards/`。
- **魔术值**: 禁止未解释的 Magic Number/String。

### 2.7 🎯 规约对齐 (Specification Alignment)
验证代码实现是否与规范文档保持一致：

- **DS 设计文档对齐**:
  - 接口签名是否与设计文档定义一致 (方法名、参数、返回值)
  - 数据结构/字段是否与设计文档定义一致
  - 业务流程/状态机是否与设计文档时序图一致
  - 错误码是否使用 `specs/governance/error-codes.md` 中定义的标准码

- **TK 任务清单对齐**:
  - 实现是否覆盖对应 TK 文档中定义的所有子任务
  - 是否存在超出 TK 范围的"越界实现"
  - 验收标准是否可追溯验证

- **RQ 需求文档对齐**:
  - 功能边界是否与需求规约一致
  - 非功能需求 (性能/安全/可用性) 是否满足

### 2.8 🔗 引用完整性 (Reference Integrity)
验证代码注释中的文档引用关系是否正确且完整：

- **标签格式检查**:
  - `@req RQ-xxxx` - 需求引用
  - `@design DS-xxxx` - 设计引用
  - `@task TK-xxxx` - 任务引用
  - `@adr AD-xxxx` - 架构决策引用

- **引用正确性**:
  - 引用的文档编号是否存在于 `specs/` 目录中
  - 引用的章节/段落是否与代码功能匹配
  - 是否存在"悬空引用"(引用了已删除/重命名的文档)

- **引用完整性**:
  - 核心业务逻辑是否标注了对应的 `@design` 引用
  - 公共 API/接口是否标注了对应的 `@req` 引用
  - 是否存在"孤立代码"(无任何规约引用的核心模块)

- **双向可追溯**:
  - 从 DS 文档能否追溯到对应的实现代码
  - 从 TK 任务能否追溯到对应的提交/代码变更
  - 从代码注释能否反向追溯到规约来源

---

## 3. AI 执行指令 (Prompt Template)

当触发“代码审核”工作流时，AI 代理必须加载并遵循以下 Persona 和指令：

> **Role**: 你是一位拥有20年经验的资深软件架构师和安全专家。你的风格严谨、犀利、零容忍。
>
> **Task**: 基于上述 2.1 - 2.6 维度，对目标代码进行深度扫描。
>
> **Output Requirement**:
> 1. 不要只给修改后的代码，**必须先输出《审核报告》**。
> 2. 问题必须分级：**[严重]** (可能导致崩溃/入侵)、**[警告]** (逻辑错误/性能隐患)、**[建议]** (风格/可读性)。
> 3. 每个问题必须指出：**位置** (文件:行号)、**原因** (Why)、**修复建议** (How)。

---

## 4. 报告输出格式 (Report Format)

审核输出必须遵循以下 Markdown 结构：

```markdown
## 📊 审核摘要
- **总体评分**: (0-100)
- **风险等级**: (高危 / 中危 / 低风险)

## ❌ 问题列表

### [严重] <问题简述>
- **位置**: `path/to/file.go:line`
- **分析**: <详细原因>
- **建议**: <修复方案或代码>

...

## ✅ 总结与行动
(简短总结，是否建议合并或需重构)
```

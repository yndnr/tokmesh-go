# 项目宪法 / Project Charter

版本: 1.3
状态: 已批准
更新日期: 2025-12-17
维护者: YNDNR

## 0. 项目信息

### 项目名称
TokMesh

### 主要代码仓库
[https://github.com/yndnr/tokmesh-go](https://github.com/yndnr/tokmesh-go)

## 1. 使命与愿景

### 使命（Mission）
构建 **TokMesh - 高性能分布式会话缓存系统**。作为 SSO、IAM、OAuth、SAML、CAS 等身份认证系统背后的状态基础设施，通过高效的节点协同与共识机制，提供低延迟、高可靠的会话状态管理与令牌校验服务，支撑每秒十万级访问洪峰。

### 愿景（Vision）
- **短期（3-6个月）**: 完成单节点核心功能（内存存储、WAL、API Key、双协议接口），发布 MVP 版本，支持每秒 10k+ 令牌校验。
- **中期（6-12个月）**: 实现分布式集群功能（节点发现、共识同步、弹性伸缩），支持每秒 100k+ 令牌校验，完善运维与部署体验（HTTP/HTTPS + `tokmesh-cli`）。
- **长期（1-2年）**: 成为身份认证领域的标准会话/令牌缓存基础设施，支撑百万级在线会话，建立开发者生态。

## 2. 核心定位

### 2.1 专用性定位
TokMesh 专注于**会话状态管理与令牌校验**这一垂直领域，而非通用缓存或身份提供商 (IdP)。它是身份认证系统背后的"状态中枢"和"令牌验证引擎"，而非面向最终用户的认证服务本身。

### 2.2 目标用户与场景
主要用户：
- SSO (单点登录) 系统架构师
- IAM (身份与访问管理) 平台开发者
- OAuth / SAML / CAS 服务提供商
- 企业级统一登录平台团队

典型场景：
- 高并发令牌校验（API 网关、微服务鉴权）
- 分布式会话状态共享（多节点 Web 应用）
- 会话生命周期管理（TTL 过期、主动撤销）
- 异常会话监控与精准掐断

### 2.3 与上下游系统的协作关系
- **上游系统**: 身份认证系统（SSO/IAM/OAuth/SAML）通过 HTTP/HTTPS API 调用 TokMesh 进行会话管理和令牌校验。
- **本项目**: 负责会话/令牌的存储、校验、过期管理、备份还原和集群同步。
- **下游系统**: 操作系统文件系统（WAL 持久化）、监控系统（Prometheus）、日志聚合平台。

## 3. 核心目标

### 3.1 性能目标
- **令牌校验吞吐量**: 单节点 ≥ 10,000 TPS，集群 ≥ 100,000 TPS
- **校验延迟**: P99 < 10ms (局域网内)
- **会话查询延迟**: P99 < 5ms (内存读取)
- **启动时间**: 节点冷启动 < 5s
- **内存占用**: 单节点默认配置 < 512MB

### 3.2 功能目标
- **会话管理**: 创建、查询、更新、删除会话，支持 TTL 自动过期
- **令牌管理**: 令牌签发、校验、撤销
- **双协议接口**: OpenAPI (HTTP/REST) + Redis 兼容协议
- **权限体系**: API Key 管理，支持 user/admin 角色细粒度权限
- **持久化**: WAL (预写日志) + 数据加密 + 备份还原
- **集群功能**: 基于 Raft/Gossip 的混合共识，节点动态加入与退出

### 3.3 安全目标
- **通信加密**: 所有节点间通信强制采用 TLS (AES-GCM / ChaCha20-Poly1305)
- **数据加密**: WAL 日志和备份数据强制加密存储
- **访问控制**: 基于 API Key 的鉴权体系，支持细粒度权限
- **审计日志**: 记录所有敏感操作（会话创建/撤销、权限变更）
- **安全默认**: 默认仅本地回环明文可用；对外暴露必须 TLS + 鉴权
- **防护能力**: 防御重放攻击、暴力破解、时序攻击

### 3.4 可用性目标
- **SLA**: **99.9%** (在分布式集群模式下，单月停机 < 43 分钟)
- **RTO (恢复时间目标)**: < 30s
- **RPO (数据丢失目标)**: < 1s (通过 WAL 保证，异步复制模式下)
- **故障转移**: 集群节点故障自动摘除，< 10s 完成流量切换

## 4. 非目标（What We Are NOT）

明确项目**不是什么**，避免功能蔓延：

### 4.1 不是 [完整的身份提供商 (IdP)]
- ❌ 不提供用户注册、登录、密码管理等面向最终用户的认证功能。
- ❌ 不负责 LDAP/AD 集成、多因素认证 (MFA)、社交登录等 IdP 核心功能。
- ✅ 只负责为这些 IdP 系统提供会话/令牌的存储与校验服务。

### 4.2 不是 [通用缓存系统]
- ❌ 不提供类似 Redis 的完整数据结构（List、Set、Sorted Set、HyperLogLog 等）。
- ❌ 不替代 Redis、Memcached 在通用缓存场景的全部功能。
- ✅ 只专注于会话（Session）和令牌（Token）这一垂直领域，通过 Redis 兼容协议仅实现会话管理相关指令。

### 4.3 不负责 [业务UI]
- ❌ 不提供面向最终用户的图形界面（只提供运维管理 Dashboard）。
- ❌ 不处理业务层的具体逻辑（如用户权限判定、资源授权）。

## 5. 核心约束

### 5.1 架构约束
1. **语言**: 后端核心组件主要使用 Go (性能与生态平衡)，部分加密模块可使用 Rust。
2. **存储策略**: 以**内存**作为核心高速缓存介质，使用 **WAL (预写日志)** 落盘保证数据不丢失。嵌入式 KV 存储 (如 BadgerDB) 可选用于特定场景。
3. **协议支持**: 必须同时支持两种协议：
   - OpenAPI (HTTP/REST) - 通用性、管理接口
   - Redis 兼容协议 - 高性能、兼容性
4. **节点通信**: 集群节点间通信必须基于标准 TCP/QUIC 协议，强制 TLS 加密。

### 5.2 性能约束
1. 单节点内存占用 < 512MB (默认配置下)，适配中低端服务器。
2. 镜像体积 < 100MB，支持容器化快速部署。
3. 令牌校验延迟 P99 < 10ms，满足高并发 API 网关场景。

### 5.3 安全约束
1. 严禁在日志中打印敏感数据 (会话内容、令牌明文、API Key、用户 PII)。
2. 默认仅本地回环明文可用；对外暴露必须 TLS + 鉴权（API Key）。
3. WAL 日志和备份数据必须加密存储。
4. 必须提供审计日志功能，记录所有敏感操作。

## 6. 治理模型

### 6.1 决策机制
- 架构决策：通过ADR（Architecture Decision Record）记录
- 功能需求：通过R系列文档评审
- 设计方案：通过D系列文档评审

### 6.2 文档优先
- 所有功能必须先有 `specs/` 文档。
- 文档是实施的依据，代码是文档的实现。

### 6.3 测试跟随开发
- 单元测试与代码同时编写。
- 测试覆盖率：核心模块 ≥ 80%，整体 ≥ 80%。
- 必须包含集成测试与压力测试。

## 7. 权衡与取舍

### 7.1 [一致性] vs. [可用性] (CAP)
- 权衡：在网络分区发生时。
- 取舍：优先保证 **一致性 (CP)**。
- 理由：作为身份认证系统的状态基础设施，会话/令牌数据错乱（如已撤销的令牌仍然有效）会导致严重的安全问题，比服务短暂不可用后果更严重。

### 7.2 [吞吐量] vs. [延迟]
- 权衡：批量处理可以提高吞吐量，但会增加单请求延迟。
- 取舍：在满足吞吐量目标 (100k TPS) 的前提下，优先保证 **低延迟 (P99 < 10ms)**。
- 理由：令牌校验通常在 API 请求的关键路径上，延迟直接影响用户体验。

### 7.3 [内存占用] vs. [性能]
- 权衡：将所有会话数据保存在内存中可以获得极致性能，但会占用大量内存。
- 取舍：优先保证 **低延迟高性能**，接受合理的内存占用（单节点默认 < 512MB）。
- 理由：服务器内存成本相对较低，且会话数据具有明确的 TTL，内存占用可控。通过 WAL 保证数据持久化，重启后可快速恢复。

## 8. 成功标准

### 8.1 技术指标
- 核心测试套件 100% 通过，测试覆盖率 ≥ 80%。
- 单节点达到 10k+ TPS，集群达到 100k+ TPS。
- 令牌校验延迟 P99 < 10ms。
- 7x24 小时稳定运行，无内存泄漏。

### 8.2 用户反馈
- 开发者文档清晰度评分 > 4/5。
- 至少 3 个生产环境应用案例（SSO/IAM 系统）。
- 社区贡献者人数 > 10 人。

### 8.3 生态建设
- 提供 Windows Service 和 Linux systemd 部署包。
- 提供完整的运维工具 (tokmesh-cli) 和管理 Dashboard。

## 9. 路标（Roadmap）

本项目开发分为 4 个阶段，遵循渐进式交付原则。

### Phase 1: 单节点核心功能（3-4个月）
**目标**: 发布可用的单节点 MVP 版本，具备核心存储与基础鉴权能力。

- **核心功能**:
  - 内存存储引擎 (Concurrent Map) + WAL 预写日志持久化。
  - 完整的会话/令牌生命周期管理 (CRUD, TTL)。
  - 基础 API Key 鉴权 (本地验证缓存)。
- **接口实现**:
  - OpenAPI (HTTP/REST) 接口。
  - Redis 兼容协议接口。
- **交付产物**:
  - `tokmesh-server` (Standalone 模式)。

### Phase 2: 安全加固与可观测性（2-3个月）
**目标**: 达到生产级安全标准与运维可观测性。

- **安全功能**:
  - TLS 加密通信 + **证书热加载 (Hot Reload)**。
  - API Key 增强 (Argon2 参数调优、过期时间、长期 Key 警告)。
  - 本地 socket 管理接口 (UDS/Named Pipe)。
- **可观测性**:
  - Prometheus Metrics (含业务与性能指标)。
  - Tracing（P2 可选；默认关闭）。
  - 结构化日志 (JSON)。
- **运维功能**:
  - 数据快照与还原 (Backup/Restore)。
  - `tokmesh-cli` 管理工具完整版。

### Phase 3: 分布式集群架构（4-6个月）
**目标**: 实现去中心化高可用集群，支持 100k+ TPS。

- **混合架构**:
  - 控制面: **Raft** 共识 (元数据、Key、拓扑)。
  - 数据面: **一致性哈希** (Session 分片)。
  - 监测面: **Gossip** (故障检测)。
- **集群特性**:
  - 节点自动发现 (Seeds + Bootstrap Expect)。
  - 动态 Rebalance (流控 + TTL 优化)。
  - 脑裂防护 (Cluster ID 校验)。
  - 偶数节点风险告警。
- **高可用**:
  - 数据异步复制 (Async Replication, RF=2)。

### Phase 4: 生态完善与协议兼容（3-4个月）
**目标**: 完善开发者生态，支持遗留系统迁移。

- **协议支持**:
  - **Redis 兼容协议** (支持 `SET`, `TM.CREATE`, TLS 强制)。
- **可视化**:
  - 运维管理 Dashboard (Web UI)。
- **文档**:
  - 最佳实践指南、性能调优指南。

---
签署：TokMesh 架构委员会
日期：2025-12-17
---

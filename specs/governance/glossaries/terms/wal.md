# WAL (Write-Ahead Log)

## 解释
WAL (Write-Ahead Log)，即“预写式日志”，是一种广泛应用于数据库系统和分布式系统中的数据持久化和崩溃恢复机制。它确保了任何数据修改操作在真正写入数据文件之前，其变更日志已被可靠地记录到持久化的日志文件中。

## TokMesh 中的应用
在 TokMesh 中，WAL 机制用于多个核心场景，以确保数据持久性、一致性和高性能：
1.  **Session 数据持久化**: 所有对 Session 数据的写操作（创建、更新、删除）都必须先写入 WAL。这保证了即使在意外断电或系统崩溃时，Session 数据的变更也不会丢失，可以在重启时通过重放 WAL 日志进行恢复。
2.  **Raft 日志**: 在集群模式下，Raft 共识算法的日志（包括元数据变更、节点拓扑更新等）也采用类似 WAL 的方式进行持久化，确保 Raft 状态机的安全复制。
3.  **性能优化**: WAL 将随机的内存数据写入转化为顺序的磁盘写入，显著提升了写操作的吞吐量和延迟。

## 工作原理
1.  **先写日志**: 任何数据修改（插入、更新、删除）操作都不会直接修改内存中的主数据结构或磁盘文件，而是首先将这些操作记录到 WAL 文件中。
2.  **日志先行**: 只有当 WAL 条目被安全地写入磁盘后，对应的数据库修改操作才会被视为已提交。
3.  **异步写入**: 内存数据或实际数据文件的修改（将 WAL 中的数据应用到主数据文件中）可以在后台异步进行，这被称为“检查点”（Checkpointing）或“快照”（Snapshotting）。

## 示例
### TokMesh 恢复流程
1.  TokMesh 节点启动。
2.  加载最新的 Session 数据快照 (Snapshot)。
3.  从最新快照点开始，顺序回放 WAL 日志中所有未应用到快照的条目。
4.  将 Session 数据恢复到故障发生前的最新状态。
5.  TokMesh 节点进入正常运行状态。

### 与嵌入式持久化存储的关系
根据 `specs/2-designs/DS-0401-分布式集群架构设计.md` 与 `specs/adrs/AD-0401-集群元数据持久化引擎选型策略.md`，TokMesh 的 Raft 控制面需要对 Raft 日志与状态机进行本地持久化，但当前阶段不在设计中写死具体 KV 引擎；而 Session 数据面的 WAL 则是 TokMesh 自身实现或定制的。

# 架构原则 / Architecture Principles

版本: 1.1
状态: 已定稿（Final）
更新日期: 2025-12-10
维护者: YNDNR

## 概述

本文档定义 TokMesh 项目的架构指导原则。所有需求、设计和实施都必须遵循这些原则。

优先级排序：**简单性** > **安全性** > **性能** > **可扩展性**

## 1. 简单性原则 (Simplicity)

### 1.1 KISS (Keep It Simple, Stupid)
- **说明**: 避免过度设计。如果一个功能可以用简单的逻辑实现，就不要引入复杂的模式。代码的可读性和可维护性优于炫技。
- **实践**: 优先选择标准库，减少不必要的第三方依赖。

### 1.2 显式优于隐式
- **说明**: 所有的配置、依赖注入和控制流都应当是显式的。
- **实践**: 避免使用过多的“魔法”代码或复杂的反射机制，让代码逻辑一目了然。

## 2. 安全性原则 (Security)

### 2.1 默认安全 (Secure by Default)
- **说明**: 系统开箱即用时必须处于最安全的状态，而不是最开放的状态。
- **实践**: 默认开启 TLS，默认拒绝所有未授权访问，默认关闭调试接口。

### 2.2 零信任 (Zero Trust)
- **说明**: 不信任网络内部的任何节点或服务。
- **实践**: 即使在局域网内，节点间通信也必须进行身份验证和加密。

## 3. 性能原则 (Performance)

### 3.1 零拷贝 (Zero Copy)
- **说明**: 在处理网络数据包和文件 I/O 时，尽量减少数据在用户态和内核态之间的拷贝。
- **实践**: 使用 `sendfile`、`splice` 等系统调用，优化 Buffer 管理。

### 3.2 异步非阻塞
- **说明**: 核心 I/O 路径必须是非阻塞的，避免单个慢请求拖垮整个节点。
- **实践**: 基于 Go Runtime 的协程调度或 Rust 的 Async/Await 模型。

## 4. 可靠性原则 (Reliability)

### 4.1 快速失败 (Fail Fast)
- **说明**: 当系统遇到无法恢复的错误时，应立即停止当前操作并报错，而不是尝试掩盖错误。
- **实践**: 参数校验不通过直接返回 400，启动时配置错误直接 Panic 退出。

### 4.2 无状态设计 (Stateless)
- **说明**: 业务逻辑层应尽量无状态，状态下沉到存储层（内存 + WAL / Raft）。
- **实践**: API Server 节点应可随时扩容缩容，不存储 Session 信息。

## 5. 可观测性原则 (Observability)

### 5.1 指标驱动 (Metrics Driven)
- **说明**: 系统必须暴露关键运行指标 (Prometheus 格式)。
- **实践**: 每一个关键的 RPC 调用、数据库操作都必须有 Latency 和 Counter 埋点。

### 5.2 结构化日志
- **说明**: 日志必须是机器可读的 (JSON)。
- **实践**: 严禁使用 `fmt.Println`，必须使用结构化日志（优先使用 Go stdlib `log/slog` 的 JSONHandler）。

## 原则冲突时的权衡

当多个原则冲突时，按以下优先级权衡：

1. **安全性 > 性能**：
   - 例如：虽然加密会消耗 CPU 且增加延迟，但绝不能为了性能而传输明文数据。

2. **简单性 > 性能**：
   - 例如：如果一个极度优化的算法导致代码极其晦涩难懂且容易出错，应优先选择简单易懂的算法，除非性能瓶颈已被 Profiling 证实。

## 原则演进

- 本文档随项目发展演进
- 修改需要架构委员会评审
- 重大变更通过 ADR 记录

---
签署：[架构委员会]
日期：2025-12-10
---

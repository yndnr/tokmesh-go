# 想法: 核心安全体系

状态: 已批准

## 原始想法

TokMesh 作为身份认证的基础设施，必须具备防御高级网络攻击的能力，并在不可信网络环境中保证数据安全。

### 核心防御机制

1.  **防重放攻击 (Anti-Replay)**:
    *   **时间戳窗口**: 校验请求的时间戳（例如 +/- 30秒），超出窗口直接拒绝。
    *   **Nonce 机制**: 对于关键写操作（如 Session 创建/销毁），要求携带唯一的 Nonce，防止请求被录制重放。

2.  **防旧/过期令牌重用**:
    *   **严格的 TTL 校验**: 内存中自动淘汰过期数据。
    *   **黑名单 (Revocation List)**: 针对“未过期但已主动注销”的 Token，必须维护一个全局同步的黑名单（Bloom Filter 或 BitMap 优化）。
    *   **宽限期 (Grace Period)**: 在 Token 轮转（Rotation）场景下，允许旧 Token 在极短时间内（如 5秒）继续有效，以防止并发请求或网络延迟导致的业务误伤。

3.  **mTLS (双向 TLS)**:
    *   **集群内部**: 节点间通信（Raft/Gossip）强制启用 mTLS，确保只有持有有效证书的节点才能加入集群。
    *   **客户端连接**: 对于高安全等级的业务系统（如核心网关），支持开启 mTLS 认证。

4.  **访问控制 (ACL)**:
    *   **IP 白名单**: 支持为特定的 API Key 绑定 IP 白名单，限制调用来源。
    *   **管理端口保护**: 管理端口（Admin API）默认只监听 localhost 或内网 IP，并支持严格的 IP 过滤。

5.  **不可信网络设计 (Zero Trust)**:
    *   假设运行环境（包括内网）是不可信的。
    *   **全链路加密**: 所有数据传输（包括内网节点间）必须加密 (AES-GCM/ChaCha20)。
    *   **无隐式信任**: 没有任何“免鉴权”的内部接口，所有请求必须经过 API Key 或 mTLS 验证。

### 高级防御与合规

6.  **敏感数据保护**:
    *   **内存安全**: 关键密钥（如 API Key Secret）在内存中应加密存储或使用专门的安全容器，防止 Core Dump 泄露。
    *   **日志脱敏**: 强制执行日志脱敏策略，严禁打印 Token 明文、用户 PII 信息。

7.  **速率限制与防爆破**:
    *   **失败封禁**: 针对 Token 校验失败（如无效签名）的高频 IP，实施自动的临时封禁。
    *   **API Quota**: 对每个 API Key 实施 QPS 配额限制，防止单点流量突增影响集群稳定性。

8.  **密钥管理 (KMS)**:
    *   **静态加密**: 落盘数据（WAL/Snapshot）必须使用 Master Key 加密。
    *   **轮转机制**: 支持 Master Key 和 API Key 的定期轮转 (Rotation)。支持对接外部 KMS。

9.  **供应链安全**:
    *   **制品签名**: 所有发布的二进制文件和 Docker 镜像必须经过数字签名 (Cosign/GPG)。
    *   **SBOM**: 提供软件物料清单，透明化依赖关系，便于漏洞扫描。

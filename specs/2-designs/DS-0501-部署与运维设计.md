# DS-0501 - éƒ¨ç½²ä¸è¿ç»´è®¾è®¡

**çŠ¶æ€**: è‰ç¨¿
**ä¼˜å…ˆçº§**: P1
**æ¥æº**: RQ-0501-éƒ¨ç½²ä¸äº¤ä»˜éœ€æ±‚.md, RQ-0502-é…ç½®ç®¡ç†éœ€æ±‚.md
**ä½œè€…**: yndnr
**åˆ›å»ºæ—¥æœŸ**: 2025-12-12
**æœ€åæ›´æ–°**: 2025-12-17

## 1. æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è®¾è®¡ TokMesh çš„éƒ¨ç½²æ¶æ„ã€äº¤ä»˜ç‰©è§„èŒƒå’Œé…ç½®ç®¡ç†æœºåˆ¶ã€‚è®¾è®¡ç›®æ ‡æ˜¯æ”¯æŒå¤šç§éƒ¨ç½²æ¨¡å¼ï¼ˆå•æœºã€é›†ç¾¤ã€å®¹å™¨åŒ–ï¼‰ï¼Œæä¾›çµæ´»çš„é…ç½®ç®¡ç†èƒ½åŠ›ï¼Œå¹¶ç¡®ä¿è¿ç»´ä¾¿æ·æ€§ã€‚

## 2. äº¤ä»˜ç‰©è§„èŒƒ

### 2.1 æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `tokmesh-server` | äºŒè¿›åˆ¶ | æ ¸å¿ƒæœåŠ¡è¿›ç¨‹ |
| `tokmesh-cli` | äºŒè¿›åˆ¶ | CLI ç®¡ç†å·¥å…·ï¼ˆå‘½ä»¤å…¥å£ä½äº `src/cmd/tokmesh-cli`ï¼‰ |
| `config.yaml` | é…ç½®æ–‡ä»¶ | é»˜è®¤é…ç½®æ¨¡æ¿ |

### 2.2 å¹³å°æ”¯æŒçŸ©é˜µ

| å¹³å° | æ¶æ„ | åŒ…æ ¼å¼ | æœåŠ¡ç®¡ç† |
|------|------|--------|----------|
| Linux | amd64, arm64 | tar.gz, deb, rpm | systemd |
| Windows | amd64 | zip, msi | Windows Service |
| macOS | amd64, arm64 | tar.gz | launchd |
| Container | amd64, arm64 | Docker Image | - |

### 2.3 ç›®å½•ç»“æ„

#### 2.3.1 Linux (FHS æ ‡å‡†)

```
/usr/local/bin/
â”œâ”€â”€ tokmesh-server          # ä¸»æœåŠ¡
â””â”€â”€ tokmesh-cli              # CLI å·¥å…·

/etc/tokmesh-server/
â”œâ”€â”€ config.yaml             # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ certs/                  # TLS è¯ä¹¦ç›®å½•
â”‚   â”œâ”€â”€ server.crt
â”‚   â”œâ”€â”€ server.key
â”‚   â””â”€â”€ ca.crt
â””â”€â”€ config.d/               # é…ç½®ç‰‡æ®µç›®å½• (å¯é€‰)

/var/lib/tokmesh-server/
â”œâ”€â”€ data/                   # ä¸šåŠ¡æ•°æ®
â”‚   â”œâ”€â”€ wal/                # WAL æ—¥å¿—
â”‚   â””â”€â”€ snapshots/          # å¿«ç…§æ–‡ä»¶
â””â”€â”€ raft/                   # Raft çŠ¶æ€

/var/log/tokmesh-server/
â””â”€â”€ (å¯é€‰)                   # é»˜è®¤ä¸åˆ›å»ºï¼›TokMesh é»˜è®¤è¾“å‡º stdoutï¼Œå¦‚éœ€è½ç›˜ç”±éƒ¨ç½²ä¾§é‡‡é›†ï¼ˆjournald/agentï¼‰å†³å®šæ˜¯å¦å†™å…¥è¯¥ç›®å½•

/var/run/tokmesh-server/
â””â”€â”€ tokmesh-server.sock     # ç´§æ€¥ç®¡ç† Socketï¼ˆUDSï¼‰
```

#### 2.3.2 Windows

```
%ProgramFiles%\TokMesh\
â”œâ”€â”€ bin\
â”‚   â”œâ”€â”€ tokmesh-server.exe
â”‚   â””â”€â”€ tokmesh-cli.exe

%ProgramData%\tokmesh-server\
â”œâ”€â”€ config.yaml
â”œâ”€â”€ certs\
â”œâ”€â”€ data\
â””â”€â”€ logs\   (å¯é€‰ï¼›é»˜è®¤å»ºè®® stdout)
```

## 3. æœåŠ¡ç®¡ç†

### 3.1 Linux (systemd)

```ini
# /etc/systemd/system/tokmesh-server.service
[Unit]
Description=TokMesh Server (Session/Token Cache Service)
After=network.target

[Service]
Type=simple
User=tokmesh
Group=tokmesh
ExecStart=/usr/local/bin/tokmesh-server --config /etc/tokmesh-server/config.yaml
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5
LimitNOFILE=65535
RuntimeDirectory=tokmesh-server
RuntimeDirectoryMode=0750

# å®‰å…¨åŠ å›º
NoNewPrivileges=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/var/lib/tokmesh-server /var/run/tokmesh-server

[Install]
WantedBy=multi-user.target
```

#### 3.1.1 é»˜è®¤ç”¨æˆ·ä¸ç›®å½•æƒé™ï¼ˆLinuxï¼‰

å®‰è£…åŒ…åº”åˆ›å»ºç³»ç»Ÿç”¨æˆ·/ç»„ `tokmesh`ï¼ˆæ— ç™»å½•èƒ½åŠ›ï¼‰ï¼Œå¹¶è®¾ç½®ç›®å½•æœ€å°æƒé™ï¼š
- ç”¨æˆ·ï¼š`tokmesh`ï¼ˆsystem userï¼‰ï¼Œshell ä¸º `/usr/sbin/nologin`ï¼ˆæˆ–ç­‰æ•ˆ no-login é…ç½®ï¼‰
- é…ç½®ç›®å½•ï¼š`/etc/tokmesh-server/` å»ºè®® `root:tokmesh`ï¼Œ`0750`ï¼›`config.yaml` å»ºè®® `root:tokmesh`ï¼Œ`0640`
- æ•°æ®ç›®å½•ï¼š`/var/lib/tokmesh-server/` å»ºè®® `tokmesh:tokmesh`ï¼Œ`0750`
- è¿è¡Œç›®å½•ï¼š`/var/run/tokmesh-server/`ï¼ˆæˆ– `/run/tokmesh-server/`ï¼‰å»ºè®® `tokmesh:tokmesh`ï¼Œ`0750`ï¼›Socket ä¸º `/var/run/tokmesh-server/tokmesh-server.sock`
  - è¯´æ˜ï¼šæ¨èåœ¨ systemd unit ä¸­é…ç½® `RuntimeDirectory=tokmesh-server`ï¼Œç”± systemd è‡ªåŠ¨åˆ›å»º `/run/tokmesh-server/`ï¼ˆé€šå¸¸ `/var/run` ä¼šæŒ‡å‘ `/run`ï¼‰ã€‚

ç¤ºä¾‹ï¼ˆä»…è¯´æ˜æ„å›¾ï¼‰ï¼š
```bash
useradd --system --no-create-home --home-dir /var/lib/tokmesh-server --shell /usr/sbin/nologin tokmesh
install -d -o root   -g tokmesh -m 0750 /etc/tokmesh-server
install -d -o tokmesh -g tokmesh -m 0750 /var/lib/tokmesh-server /var/run/tokmesh-server
chmod 0640 /etc/tokmesh-server/config.yaml
```

### 3.2 Windows Service

```go
// Windows Service å®ç°
func (s *TokMeshService) Execute(args []string, r <-chan svc.ChangeRequest, changes chan<- svc.Status) (bool, uint32) {
    changes <- svc.Status{State: svc.StartPending}

    // å¯åŠ¨æœåŠ¡
    go s.server.Start()

    changes <- svc.Status{State: svc.Running, Accepts: svc.AcceptStop | svc.AcceptShutdown}

    for c := range r {
        switch c.Cmd {
        case svc.Stop, svc.Shutdown:
            changes <- svc.Status{State: svc.StopPending}
            s.server.Shutdown()
            return false, 0
        }
    }
    return false, 0
}
```

#### 3.2.1 æœåŠ¡è´¦å·ä¸ç›®å½•æƒé™ï¼ˆWindowsï¼‰

æ¨èç­–ç•¥ï¼š
- ä¸åˆ›å»ºè‡ªå®šä¹‰æœ¬åœ°ç”¨æˆ· `tokmesh`ï¼ˆè¿ç»´æˆæœ¬è¾ƒé«˜ï¼‰ã€‚
- ä½¿ç”¨ Windows æœåŠ¡ SIDï¼ˆä¾‹å¦‚ `NT SERVICE\\TokMeshServer`ï¼‰æˆ–å—é™å†…ç½®è´¦å·ï¼ˆå¦‚ `LocalService`ï¼‰ï¼Œå¹¶å¯¹é…ç½®/æ•°æ®ç›®å½•è®¾ç½® ACLï¼š
  - é…ç½®ï¼š`%ProgramData%\\tokmesh-server\\config.yaml`ï¼ˆä»…ç®¡ç†å‘˜ä¸æœåŠ¡è´¦å·å¯è¯»ï¼‰
  - è¯ä¹¦ï¼š`%ProgramData%\\tokmesh-server\\certs\\`ï¼ˆç§é’¥ä»…æœåŠ¡è´¦å·å¯è¯»ï¼‰
  - æ•°æ®ï¼š`%ProgramData%\\tokmesh-server\\data\\`ï¼ˆä»…æœåŠ¡è´¦å·å¯å†™ï¼‰

### 3.3 å®¹å™¨åŒ–éƒ¨ç½²

è¯´æ˜ï¼šå®¹å™¨ç¯å¢ƒå»ºè®®ä»…é€šè¿‡ stdout è¾“å‡ºæ—¥å¿—ï¼Œç”±å®¹å™¨è¿è¡Œæ—¶/é‡‡é›†ä¾§ç»Ÿä¸€æ”¶é›†ä¸è½¬å‘ï¼ˆTokMesh ä¸å†…ç½®ä¸»åŠ¨ push æ—¥å¿—ï¼‰ã€‚

#### 3.3.1 Dockerfile

```dockerfile
FROM golang:1.22-alpine AS builder
WORKDIR /app
COPY ./src ./src
WORKDIR /app/src
RUN CGO_ENABLED=0 go build -o tokmesh-server ./cmd/tokmesh-server
RUN CGO_ENABLED=0 go build -o tokmesh-cli    ./cmd/tokmesh-cli

FROM alpine:3.19
RUN apk --no-cache add ca-certificates tzdata
COPY --from=builder /app/src/tokmesh-server /usr/local/bin/
COPY --from=builder /app/src/tokmesh-cli    /usr/local/bin/
# æ³¨æ„ï¼šç¤ºä¾‹ä½¿ç”¨ â€œserver/minimalâ€ profileï¼›å¦‚éœ€å¯ç”¨ HTTPS/é›†ç¾¤ç­‰ï¼Œè¯·æŒ‰éœ€æ›¿æ¢ä¸ºå¯¹åº” profile é…ç½®æ–‡ä»¶ã€‚
COPY configs/server/minimal/config.yaml /etc/tokmesh-server/config.yaml

EXPOSE 5080 5443 5343
# è¯´æ˜ï¼šRedis å…¼å®¹ç«¯å£ï¼ˆ6379/6380ï¼‰ä¸º P2 å¯é€‰èƒ½åŠ›ï¼Œé»˜è®¤ç¦ç”¨ï¼›ä»…åœ¨å¯ç”¨è¯¥èƒ½åŠ›æ—¶å†å¯¹å¤–æš´éœ²ç«¯å£ã€‚
VOLUME ["/var/lib/tokmesh-server"]

ENTRYPOINT ["tokmesh-server"]
CMD ["--config", "/etc/tokmesh-server/config.yaml"]
```

#### 3.3.2 Kubernetes Deployment

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tokmesh
spec:
  serviceName: tokmesh
  replicas: 3
  selector:
    matchLabels:
      app: tokmesh
  template:
    metadata:
      labels:
        app: tokmesh
    spec:
      containers:
        - name: tokmesh
          image: tokmesh/tokmesh-server:latest
          ports:
            - containerPort: 5080
              name: http
            - containerPort: 5343
              name: cluster
          env:
            - name: TOKMESH_SERVER_HTTP_ADDRESS
              value: "0.0.0.0:5080"
            - name: TOKMESH_CLUSTER_ENABLED
              value: "true"
            - name: TOKMESH_CLUSTER_NODE_ID
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: TOKMESH_CLUSTER_LISTEN_ADDRESS
              value: "0.0.0.0:5343"
            - name: TOKMESH_CLUSTER_ADVERTISE_ADDRESS
              value: "$(POD_IP):5343"
            - name: TOKMESH_CLUSTER_DISCOVERY_SEEDS
              value: "tokmesh-0.tokmesh:5343,tokmesh-1.tokmesh:5343,tokmesh-2.tokmesh:5343"
          volumeMounts:
            - name: data
              mountPath: /var/lib/tokmesh-server
            - name: config
              mountPath: /etc/tokmesh-server
          livenessProbe:
            httpGet:
              path: /health
              port: 5080
            initialDelaySeconds: 10
          readinessProbe:
            httpGet:
              path: /ready
              port: 5080
            initialDelaySeconds: 5
      volumes:
        - name: config
          configMap:
            name: tokmesh-config
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

### 3.4 ç«¯å£çŸ©é˜µ

TokMesh é»˜è®¤å¯¹å¤–æœåŠ¡ç«¯å£åŠç”¨é€”å¦‚ä¸‹ï¼ˆå« TLS ç«¯å£ä¸å†…éƒ¨é€šä¿¡ç«¯å£ï¼‰ï¼š

| ç«¯å£ | è§’è‰² | åè®® / è·¯å¾„ | æ¨èæš´éœ²èŒƒå›´ | è¯´æ˜ |
|------|------|-------------|--------------|------|
| 5080 | ä¸šåŠ¡/ç®¡ç† HTTP | HTTP `/sessions`, `/sessions/{session_id}`, `/tokens/validate`, `/admin/v1/*`, `/metrics`, `/health`, `/ready` | å†…ç½‘ / æœ¬æœº | æ˜æ–‡ç«¯å£ï¼Œé»˜è®¤ä»…å›ç¯ç›‘å¬ï¼›é€‚åˆå†…ç½‘æˆ–åœ¨ä¸Šæ¸¸ç»ˆæ­¢ TLS çš„åœºæ™¯ |
| 5443 | ä¸šåŠ¡/ç®¡ç† HTTPS | HTTPS `/sessions`, `/sessions/{session_id}`, `/tokens/validate`, `/admin/v1/*`, `/metrics`, `/health`, `/ready` | å…¬ç½‘ / å†…ç½‘ | TLS ç«¯å£ï¼Œé»˜è®¤ä»…å›ç¯ç›‘å¬ï¼›å¦‚å¯¹å¤–æš´éœ²å¿…é¡»æ˜¾å¼é…ç½®å¹¶è½å®é˜²ç«å¢™/TLS/API Key |
| 6379 | Redis å…¼å®¹ | RESP | å†…ç½‘ | Redis åè®®å…¼å®¹ç«¯å£ï¼Œä¸å»ºè®®ç›´æ¥æš´éœ²å…¬ç½‘ï¼Œå¯é€‰å¯ç”¨ TLS |
| 6380 | Redis å…¼å®¹ï¼ˆTLSï¼‰ | RESP over TLS | å†…ç½‘ | ç”Ÿäº§ç¯å¢ƒ Redis åè®®ç«¯å£ï¼ˆTLSï¼‰ |
| 5343 | é›†ç¾¤å†…éƒ¨é€šä¿¡ | Connect+Protobuf / Raft / Gossip | ä»…é›†ç¾¤å†…ç½‘ | èŠ‚ç‚¹é—´é€šä¿¡ç«¯å£ï¼Œé»˜è®¤ä»…æœ¬åœ°ï¼›å¯ç”¨é›†ç¾¤æ—¶éœ€æ˜¾å¼é…ç½®ä¸ºå†…ç½‘åœ°å€å¹¶å¯ç”¨ mTLSï¼ˆä¸å¯¹å¤–æš´éœ²ï¼‰ |

## 4. é…ç½®ç®¡ç†

è¯¦ç»†çš„é…ç½®åŠ è½½æœºåˆ¶ã€æ–‡ä»¶ç»“æ„éªŒè¯è§„åˆ™åŠçƒ­åŠ è½½è®¾è®¡ï¼Œè¯·å‚é˜…ä¸“é—¨çš„è®¾è®¡æ–‡æ¡£ï¼š

ğŸ‘‰ **[DS-0502-é…ç½®ç®¡ç†è®¾è®¡.md](./DS-0502-é…ç½®ç®¡ç†è®¾è®¡.md)**

è¯¥æ–‡æ¡£æ¶µç›–äº†ï¼š
- åŸºäº Koanf çš„é…ç½®åŠ è½½ä¸ä¼˜å…ˆçº§å¤„ç† (**CLI > Env > File > Default**ï¼›ä»¥ `specs/1-requirements/RQ-0502-é…ç½®ç®¡ç†éœ€æ±‚.md` ä¸ºå”¯ä¸€äº‹å®æ¥æº)
- å®Œæ•´çš„é…ç½®ç»“æ„å®šä¹‰
- å¯åŠ¨æ—¶é…ç½®éªŒè¯é€»è¾‘
- TLS è¯ä¹¦çƒ­åŠ è½½æœºåˆ¶



## 5. å¥åº·æ£€æŸ¥

### 5.1 ç«¯ç‚¹å®šä¹‰

| ç«¯ç‚¹ | ç”¨é€” | è¿”å› |
|------|------|------|
| `/health` | å­˜æ´»æ£€æŸ¥ (Liveness) | è¿›ç¨‹å­˜æ´»å³è¿”å› 200 |
| `/ready` | å°±ç»ªæ£€æŸ¥ (Readiness) | æœåŠ¡å°±ç»ªè¿”å› 200ï¼›æœªå°±ç»ªè¿”å› 503 |

### 5.2 å°±ç»ªæ¡ä»¶

```go
func (s *Server) IsReady() bool {
    return s.walReady &&           // WAL åˆå§‹åŒ–å®Œæˆ
           s.raftReady &&          // Raft åŠ å…¥é›†ç¾¤
           s.indexReady &&         // ç´¢å¼•é‡å»ºå®Œæˆ
           !s.shuttingDown         // æœªåœ¨å…³é—­ä¸­
}
```

## 6. ä¼˜é›…å…³é—­

### 6.1 å…³é—­æµç¨‹

```mermaid
sequenceDiagram
    participant Signal as SIGTERM
    participant Server as TokMesh Server
    participant LB as Load Balancer
    participant Raft as Raft Group

    Signal->>Server: æ”¶åˆ°å…³é—­ä¿¡å·
    Server->>Server: æ ‡è®° shuttingDown = true
    Server->>LB: /ready è¿”å› 503
    Note over LB: æ‘˜é™¤èŠ‚ç‚¹

    Server->>Server: ç­‰å¾…é£è¡Œè¯·æ±‚å®Œæˆ (30s)
    Server->>Raft: é€šçŸ¥é€€å‡ºé›†ç¾¤
    Raft-->>Server: æ•°æ®è¿ç§»å®Œæˆ

    Server->>Server: å…³é—­ç›‘å¬ç«¯å£
    Server->>Server: åˆ·æ–° WAL
    Server->>Server: é€€å‡º
```

### 6.2 è¶…æ—¶é…ç½®

| é˜¶æ®µ | è¶…æ—¶ | é…ç½®é¡¹ |
|------|------|--------|
| è¯·æ±‚æ’ç©º | 30s | `server.shutdown.grace_period` |
| é›†ç¾¤é€€å‡º | 60s | `cluster.shutdown.timeout` |
| æ€»è¶…æ—¶ | 120s | `server.shutdown.timeout` |

## 7. éªŒæ”¶æ ‡å‡† (Acceptance Criteria)

### 7.1 éƒ¨ç½²
- [ ] Linux åŒ…å®‰è£…åæœåŠ¡è‡ªåŠ¨æ³¨å†Œ
- [ ] Windows æœåŠ¡å¯é€šè¿‡ services.msc ç®¡ç†
- [ ] Docker é•œåƒå¤§å° < 100MB
- [ ] K8s StatefulSet éƒ¨ç½² 3 èŠ‚ç‚¹é›†ç¾¤æˆåŠŸ

### 7.2 é…ç½®
- [ ] ç¯å¢ƒå˜é‡è¦†ç›–é…ç½®æ–‡ä»¶
- [ ] é…ç½®éªŒè¯å¤±è´¥æ—¶æ‹’ç»å¯åŠ¨
- [ ] çƒ­åŠ è½½æ—¥å¿—çº§åˆ«ç”Ÿæ•ˆ
- [ ] é…ç½®å˜æ›´è®°å½•å®¡è®¡æ—¥å¿—

### 7.3 æœåŠ¡ç®¡ç†
- [ ] systemctl reload è§¦å‘çƒ­åŠ è½½
- [ ] ä¼˜é›…å…³é—­ä¸ä¸¢å¤±æ•°æ®
- [ ] å¥åº·æ£€æŸ¥æ­£ç¡®åæ˜ æœåŠ¡çŠ¶æ€

---

## é™„å½• A: ä»£ç éª¨æ¶

> **å®Œæ•´ä»£ç ç›®å½•ç»“æ„å·²ç‹¬ç«‹ä¸ºè§„èŒƒæ–‡æ¡£ï¼Œè¯¦è§ï¼š**
>
> ğŸ‘‰ **[specs/governance/code-skeleton.md](../governance/code-skeleton.md)**
>
> è¯¥æ–‡æ¡£æ˜¯ä»£ç ç»„ç»‡çš„**å•ä¸€äº‹å®æ¥æº (Single Source of Truth)**ï¼ŒåŒ…å«ï¼š
> - å®Œæ•´ç›®å½•ç»“æ„æ ‘
> - ä¾èµ–è¾¹ç•Œè§„åˆ™
> - æ¨¡å—èŒè´£è¯´æ˜
> - è®¾è®¡å†³ç­–è®°å½•
> - æ–‡ä»¶æ¸…å•ç»Ÿè®¡

---

## å˜æ›´å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´è¯´æ˜ | ä½œè€… |
|------|------|----------|------|
| 2025-12-17 | v1.3 | ä»£ç éª¨æ¶é‡æ„ï¼šstorage æå‡ä¸ºç‹¬ç«‹é¡¶çº§ç›®å½•ï¼Œcli/cmdâ†’cli/commandï¼Œservice æ–‡ä»¶å»é™¤ _svc åç¼€ | yndnr |
| 2025-12-17 | v1.2 | ä»£ç éª¨æ¶å®¡æŸ¥ä¿®è®¢ï¼šrpcserverâ†’clusterserver, config å½’å±å„è¿›ç¨‹ç›®å½•, gracefulâ†’shutdown | yndnr |
| 2025-12-16 | v1.1 | æ–°å¢é™„å½• A å®Œæ•´ä»£ç éª¨æ¶ï¼Œç»Ÿä¸€é¡¹ç›®ä»£ç ç»“æ„å®šä¹‰ | yndnr |
| 2025-12-12 | v1.0 | åˆå§‹ç‰ˆæœ¬ | yndnr |

# RQ-0102-会话生命周期管理

**状态**: 已批准
**优先级**: P0
**来源**: CP-0101-核心愿景与架构.md, AD-0101-Token生成与存储策略.md
**依赖**: [RQ-0101-核心数据模型](./RQ-0101-核心数据模型.md)
**最后更新**: 2025-12-18

## 1. 概述

本文档定义 TokMesh 会话的生命周期管理逻辑，包括创建、校验、续期、吊销和自动淘汰五个核心流程。

> **前置依赖**: Session 数据结构和约束条件请参见 [RQ-0101-核心数据模型](./RQ-0101-核心数据模型.md)。

---

## 2. 创建 (Create)

### 2.1 输入参数

| 参数 | 必填 | 说明 |
|------|------|------|
| `user_id` | ✅ | 关联的用户标识 |
| `device_id` | ❌ | 设备唯一标识 |
| `data` | ❌ | 扩展 KV 数据 |
| `ttl_seconds` | ❌ | 会话有效期（秒），默认使用系统配置 |
| `token` | ❌ | 自定义 Token（不提供则由服务端生成） |

### 2.2 处理逻辑

```
1. Token 处理
   ├── 客户端未提供 Token
   │   └── 服务端生成: 32字节 CSPRNG → Base64 RawURL → 添加 tmtk_ 前缀
   └── 客户端提供 Token
       └── 校验格式后直接使用

2. 计算 TokenHash = `tmth_` + Hex(SHA-256(Token))

3. 配额检查
   └── 查询该 user_id 当前会话数，超限则拒绝

4. 生成 SessionID
   ├── 格式: `tmss-` + 26 字符小写 ULID（总长 31；见 `RQ-0101-核心数据模型.md` 第 2 节）
   └── 冲突重试: 最多 3 次（极小概率）

5. 持久化
   └── 写入 WAL + 更新内存索引
```

### 2.3 输出

| 字段 | 说明 |
|------|------|
| `session_id` | 新创建的会话 ID |
| `token` | Token 明文（**仅在服务端生成时返回，且仅此一次**） |
| `expires_at` | 过期时间戳 |

---

## 3. 校验 (Validate)

### 3.1 输入参数

| 参数 | 必填 | 说明 |
|------|------|------|
| `token` | ✅ | Token 明文 |
| `touch` | ❌ | 是否更新 `last_active`，默认 true |

### 3.2 处理逻辑

```
1. 计算 TokenHash = `tmth_` + Hex(SHA-256(Token))（总长 69；见 `RQ-0101-核心数据模型.md` 第 2 节）

2. 通过 TokenHash 索引查找 SessionID

3. 检查会话状态
   ├── 未找到对应会话 → 返回 TM-TOKN-4010
   ├── 已过期 → 返回 TM-TOKN-4011
   └── 已被吊销/删除 → 返回 TM-TOKN-4012

4. 更新访问信息（如 touch=true）
   ├── last_active = 当前时间
   ├── last_access_ip = 请求 IP
   └── last_access_ua = 请求 UA

5. 返回 Session 数据
```

### 3.3 输出

| 字段 | 说明 |
|------|------|
| `valid` | 校验结果 (true/false) |
| `session` | 完整的 Session 对象（valid=true 时） |
| `error` | 错误信息（valid=false 时） |

---

## 4. 续期 (Renew)

### 4.1 输入参数

| 参数 | 必填 | 说明 |
|------|------|------|
| `session_id` | ✅ | 会话 ID |
| `ttl_seconds` | ✅ | 新的有效期（相对于当前时间） |

### 4.2 安全性控制

- **核心原则**: `ip_address` 和 `user_agent`（创建时信息）字段**不可变**，确保审计溯源能力
- **更新范围**: Renew **仅**更新 `expires_at` 和 `last_active` 字段
- **IP/UA 不可变**: Renew **不接受** IP/UA 更新参数，防止审计轨迹被篡改
- **访问信息更新**: 如需更新 `last_access_ip` 和 `last_access_ua`，应通过 Validate 接口实现

### 4.3 处理逻辑

```
1. 查找 Session
   └── 不存在或已过期 → 返回错误

2. 计算新过期时间
   └── new_expires_at = now() + ttl_seconds

3. 更新字段
   ├── expires_at = new_expires_at
   └── last_active = now()

4. 持久化变更
```

### 4.4 输出

| 字段 | 说明 |
|------|------|
| `new_expires_at` | 新的过期时间戳 |

---

## 5. 吊销 (Revoke)

### 5.1 吊销模式

| 模式 | 一致性 | 延迟 | 适用场景 |
|------|--------|------|----------|
| **模式 A** (默认) | 最终一致性 | 低 | 普通登出、超时清理 |
| **模式 B** (sync=true) | 强一致性 | 高 | 高风险场景（盗号封禁） |

### 5.2 模式 A: 最终一致性

- 立即返回成功
- 通过 Gossip 协议异步传播删除事件
- 其他节点在数秒内完成同步

#### 5.2.1 传播窗口与验收口径（必须明确）

为避免“默认最终一致”变成不可控的安全风险窗口，TokMesh 必须提供可观测、可验收的传播窗口指标：

- **传播窗口定义**：在一次吊销操作发生后，集群内所有节点都将该 Session 视为“已吊销/不可用”所需的时间。
- **验收目标（默认配置）**：传播窗口 **P99 ≤ 2s**（局域网内、健康集群；不含网络分区/节点故障场景）。
- **可观测性要求**：必须暴露传播窗口相关指标与告警（见 `specs/1-requirements/RQ-0403-可观测性需求.md` 与 `specs/2-designs/DS-0402-可观测性设计.md`）。

### 5.3 模式 B: 强一致性

- 请求节点等待集群中 **N/2+1** 个节点确认删除成功
- 确认完成后才返回 OK
- 代价: 延迟较高，可用性受集群状态影响

### 5.4 批量吊销

- 支持按 `user_id` 吊销该用户所有会话
- 单次操作上限: **1000 个** Session
- 超限返回 `TM-SESS-4002` 并提示分批处理

---

## 6. 自动淘汰 (Expiration)

### 6.1 策略

采用 **惰性删除 + 概率性主动清理** 组合策略（参考 Redis）。

### 6.2 惰性删除

- 访问 Session 时检查 `expires_at`
- 若已过期，视为不存在，返回 `TM-SESS-4041`

### 6.3 主动清理算法

| 参数 | 默认值 | 配置项 |
|------|--------|--------|
| 执行频率 | 100ms | `session.ttl.gc_interval` |
| 采样数量 | 20 个 | `session.ttl.sample_size` |
| 递归阈值 | 25% 过期 | - |
| 最大递归 | 4 次 | - |

**执行流程**:
```
每 100ms:
  1. 从本地分片随机抽取 20 个 Session
  2. 删除所有已过期的 Session
  3. 如果过期比例 > 25%:
     └── 立即再次采样（最多递归 4 次）
```

> **设计依据**: 参见 DS-0101-核心数据模型设计.md 第 5.1.1 节 TTL 主动清理算法详细说明。

---

## 7. 验收标准 (Acceptance Criteria)

### 7.1 创建流程
- [ ] 不传 Token 时，响应包含服务端生成的 `token` 字段
- [ ] 传入自定义 Token 时，响应回显一致
- [ ] Token 存储为 SHA-256 哈希值，非明文

### 7.2 校验流程
- [ ] 有效 Token 返回完整 Session 数据
- [ ] 无效 Token 返回 `TM-TOKN-4010`
- [ ] 过期 Token 返回 `TM-TOKN-4011`
- [ ] `touch=true` 时 `last_active` 和 `last_access_*` 被更新

### 7.3 续期流程
- [ ] 续期后 `expires_at` 正确更新
- [ ] `ip_address` 和 `user_agent` 保持不变
- [ ] 对已过期 Session 续期返回错误

### 7.4 吊销流程
- [ ] 吊销后 Session 不可访问
- [ ] 重复吊销同一 Session 返回成功（幂等）
- [ ] 强一致性模式等待多数节点确认
- [ ] 最终一致性模式下，传播窗口 P99 ≤ 2s（默认配置、健康集群、局域网）

### 7.5 自动淘汰
- [ ] 创建 TTL=1s 的会话，1.5s 后校验返回过期错误
- [ ] 批量插入 1 万条短 TTL 数据，5s 后 Key 总数大幅下降

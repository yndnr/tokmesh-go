# RQ-0201-安全与鉴权体系

**状态**: 已批准
**优先级**: P0
**来源**: CP-0201-APIKey鉴权体系.md, CP-0202-核心安全体系.md
**最后更新**: 2025-12-18

## 1. API Key 管理体系

### 1.1 数据模型
| 字段 | 说明 |
| :--- | :--- |
| `key_id` | 唯一标识 (Public) |
| `key_secret_hash` | **密钥哈希** (Private)。使用 **Argon2id** 算法存储。 |
| `role` | `admin` / `issuer` / `validator` / `metrics`（见 1.1.1） |
| `allowedlist` | IP 允许名单（IP/CIDR 列表）。示例：`["192.168.1.10","192.168.1.0/24","2001:db8::1","2001:db8::/64"]`（单个 IP 等价于 `/32` 或 `/128`） |
| `rate_limit` | QPS 限制 (e.g., 1000/s) |
| `expires_at` | **绝对过期时间** (Unix MS)。到期后自动失效。 |
| `status` | `active`, `disabled` |

### 1.1.1 角色定义与职责边界

> 说明：这里的 `role` 指 **TokMesh API Key 的权限角色**，与业务系统自身的用户角色/组织角色无关。

| 角色 | 典型主体 | 允许能力（最小集合） |
|------|----------|----------------------|
| `metrics` | Prometheus/监控抓取器 | `GET /metrics`（可选允许 `GET /health`、`GET /ready`，这些端点也可保持无鉴权） |
| `validator` | 网关/资源服务/业务应用 | 仅令牌校验与只读查询（例如 `POST /tokens/validate`） |
| `issuer` | SSO/会话管理服务 | 会话/令牌写操作（创建/续期/吊销/批量吊销），并可包含 `validator` 的校验能力 |
| `admin` | IAM 平台/运维平台/管理员 | 系统管理全权限（Key 管理、配置、集群、备份恢复、审计等），不建议用于业务侧高频调用 |

### 1.2 密码学原语
- **Hash 算法**: **Argon2id** (v1.3)。
    - **参数**: 内存 **16MB**, 迭代 **2次**, 并行度 2。
    - **配置**: 可通过 `security.auth.argon2` 下的 `memory`（单位 KB）, `iterations`, `parallelism` 参数进行调优。
    - *变更说明*: 降低参数以平衡安全性与验证性能。对于 32字节高熵随机 Secret，此参数已足够安全。
- **Salt**: 16 字节随机盐，与 Hash 结果编码存储在一起 (PHC 格式)。

### 1.3 管理功能
- **创建 Key**: 
    - Secret 使用 32 字节 CSPRNG 随机数生成 (Base62 编码)。
    - 返回给客户端明文 Secret **一次**。
- **Key 轮转 (Rotation)**: 
    - 支持生成新 Secret，旧 Secret 进入 **宽限期 (Grace Period)**。
    - 宽限期时长: 默认 **1 小时** (可通过 `security.auth.rotation_grace` 配置，Duration 格式如 `"1h"`)。
    - 宽限期内，新旧 Secret 均可用。
- **长期 Key 策略**:
    - 系统支持设置较长有效期的 API Key。
    - **安全提示**: 若创建或更新 Key 时设置的有效期超过 **1 年**，管理接口必须返回明确的安全警告 (Security Warning)，提示管理员关注定期轮转的必要性。

### 1.4 验证缓存 (Validation Cache)
为满足高吞吐量需求，避免对每个请求执行昂贵的 Argon2 运算，必须引入缓存层。
- **机制**: 本地内存 LRU 缓存。
- **Key**: `Hash(key_id + secret_string)` (或类似的快速哈希)。
- **Value**: 验证结果 (True/False) + 关联的 Key Metadata (Role, ACL 等)。
- **TTL**: **60 秒** (可配置)。
- **失效**: 当 Key 被禁用、删除或修改权限时，应通过 Pub/Sub 机制通知集群清理缓存。

### 1.5 本地紧急管理接口 (Local Emergency Management Interface)
为应对 API Key 全部丢失/过期/禁用的极端情况，TokMesh 必须提供一个安全的本地紧急管理通道。
- **目的**: 允许本地 `tokmesh-cli` 在不依赖 API Key 的情况下，对系统进行紧急配置、恢复或生成新的 API Key。
- **机制**:
    - **Linux/macOS**: 监听一个 **Unix Domain Socket (UDS)**，例如 `/var/run/tokmesh-server/tokmesh-server.sock`（由 `tokmesh-server` 创建，`tokmesh-cli` 连接）。
    - **Windows**: 监听一个 **Named Pipe**（由 `tokmesh-server` 创建，`tokmesh-cli` 连接），例如 `\\.\pipe\tokmesh-server`。
- **访问权限**:
    - **最高管理权限**: 通过此接口发出的命令将默认获得 Admin 角色权限。
    - **无需 API Key**: 不执行 API Key 鉴权。
- **安全控制**: 
    - 完全依赖**操作系统文件权限**进行访问控制。
    - UDS 文件或 Named Pipe 必须设置为**仅限 TokMesh 运行用户**及其指定管理组可读写（例如 `chmod 0660 /var/run/tokmesh-server/tokmesh-server.sock`）。
- **禁止网络暴露**: 此接口**严禁**通过 TCP 或任何网络协议暴露。

## 2. 接口鉴权逻辑
- 校验步骤:
    1.  **格式检查**: 检查 Key ID 和 Secret 格式。
    2.  **缓存查询**: 检查本地验证缓存。如命中且有效，跳过后续的 **Secret 验证**（Argon2）步骤。
    3.  **Key 状态检查**: 
        - 检查 Key 是否存在且 `status == active`。
        - 检查 `expires_at` 是否已过期。
    4.  **来源 IP 判定（信任边界）**: 计算本次请求的 `client_ip`，用于 allowlist/审计/限流的一致口径。
        - 默认：仅按直连 TCP 源 IP 判定（不信任 `Forwarded` / `X-Forwarded-For` / `X-Real-IP`）。
        - 若显式配置 `security.network.trusted_proxies`（见 `specs/1-requirements/RQ-0502-配置管理需求.md` 7.1.6）：
          - 仅当直连 TCP 源 IP 命中 `trusted_proxies` 时，才允许从上述 Header 解析真实客户端 IP；否则忽略 Header，避免被伪造绕过。
    5.  **IP 允许名单**: 检查来源 IP 是否满足 allowedlist 限制：
        - 全局 `security.auth.allow_list` 与单 Key `allowedlist` 若同时存在，则取交集（必须都命中）。
        - 任意一层为空则表示该层不限制。
    6.  **限流检查**: 检查是否触发 Rate Limit。
    7.  **Secret 验证**:
        - 若缓存未命中: 执行 **Argon2 Verify**。
        - 验证成功: 写入缓存，跳转后续逻辑。
        - 验证失败: 记录审计日志，返回 401。
    8.  **权限校验**: 基于 `role` + 目标端点能力进行授权（例如 `admin` 可访问 `/admin/v1/*`，`metrics` 可访问 `/metrics`，`issuer/validator` 按业务接口能力划分）。

## 3. 核心防御机制

### 3.1 防重放 (Anti-Replay)
- **机制**:
    - 针对 `POST/PUT/DELETE` 等写操作。
    - 客户端需上报 `X-Timestamp` 和 `X-Nonce`。
- **验证逻辑**:
    1.  **时间戳窗口**: `X-Timestamp` 必须在当前时间 **+/- 30 秒** 的窗口内。
    2.  **Nonce 唯一性**:
        - **策略**: **节点本地检测 (Local Detection)**。
        - **存储**: 本地内存缓存 (TTL 60s)。
        - **集群说明**: 不进行跨节点 Nonce 同步（避免广播风暴）。
- **风险与缓解**:
    - *风险*: 攻击者可能将同一请求重放至不同节点。
    - *缓解*: 
        - **幂等性**: `DELETE/PUT` 等操作设计为幂等，重复执行无副作用。
        - **配额兜底**: 对于非幂等的 `POST /sessions`，依赖用户配额 (Max 50) 防止资源耗尽。
    - *部署建议*: 建议在负载均衡层开启 **会话保持 (Sticky Sessions)**，确保同一来源 IP 固定路由至同一节点，从而最大化本地防重放的效果。

### 3.2 限流 (Rate Limiting)
- **算法**: **令牌桶 (Token Bucket)**。
- **粒度**: **Per Key** (即每个 API Key 独立计算)。
- **行为**: 超限返回 `TM-SYS-4290`。

## 4. 数据加密 (Data Encryption)

为防止物理介质被盗或快照泄露导致的数据风险，所有持久化数据必须加密存储。

### 4.1 加密范围
- **WAL 日志**: 包含所有写操作记录。
- **Raft 日志**: 包含集群元数据变更记录。
- **快照文件**: 包含全量 Session 数据。

### 4.2 加密算法自适应 (Adaptive Cryptography)
- **目标**: 在保障安全的前提下，最大化利用硬件能力，避免加密成为性能瓶颈。
- **策略**: 运行时探测 CPU 指令集。
    - **优先**: 若 CPU 支持 AES 硬件加速 (AES-NI + PCLMULQDQ / ARMv8 Crypto)，**必须**使用 **AES-256-GCM**。
    - **回退**: 若不支持硬件加速，**必须**自动切换为 **ChaCha20-Poly1305**（软件高性能实现）。
- **约束**: 无论使用何种算法，必须统一使用 **32 字节 (256-bit) 密钥** 和 **12 字节 Nonce**，确保上层接口一致。

## 5. 风险缓解建议

### 5.1 吊销延迟风险缓解
- **业务二次校验**: 建议业务系统在执行极度敏感操作（如大额转账、修改关键权限）时，除了校验 Token 有效性外，还可以选择：
    -   强制回源查询 SSO/IAM 数据库，获取最新的用户权限状态。
    -   要求用户进行 MFA（多因素认证）或二次确认。
- **目的**: 规避因吊销指令在分布式集群中传播延迟（1-2秒）可能带来的极低概率风险窗口。

## 6. 验收标准 (Acceptance Criteria)

1.  **数据安全性 (Data Security)**:
    - [ ] **Secret 存储格式**: 通过 Admin API 或直接查看存储，验证 API Key 的 `secret` 字段是否为 Argon2id 格式的哈希串（如 `$argon2id$v=19$m=65536...`），确保未存储明文。
    - [ ] **防重放机制**: 拦截并重放一个合法的写请求（如 `CreateSession`），如果超过 30s 时间窗口或 Nonce 已被记录，服务端应拒绝并返回错误。
2.  **访问控制 (Access Control)**:
    - [ ] **IP 白名单拦截**: 配置 Key A 仅允许 `192.168.1.0/24`。从 `10.0.0.1` 发起请求应被拒绝 (403 Forbidden)。
    - [ ] **IP 白名单放行**: 配置 Key A 仅允许 `192.168.1.0/24`。从 `192.168.1.5` 发起请求应成功。
    - [ ] **速率限制 (Rate Limit)**: 配置 Key B 限制为 10 QPS。以 20 QPS 的速度发送请求，确认部分请求被拒绝并返回 `TM-SYS-4290`，同时 Header 中包含 `Retry-After`。
3.  **密钥轮转 (Key Rotation)**:
    - [ ] **新旧共存**: 触发 Key 轮转生成新 Secret。立即验证：使用旧 Secret 和 新 Secret 均能成功调用 API。
    - [ ] **过期失效**: 手动修改（或模拟等待）使旧 Secret 超出宽限期（1h），再次使用旧 Secret 调用 API 应被拒绝 (401 Unauthorized)。
    - [ ] **有效期检查**: 创建一个 `expires_at` 为过去时间的 Key，使用它调用 API 应被拒绝 (401/403)。

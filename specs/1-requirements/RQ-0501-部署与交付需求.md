# RQ-0501-部署与交付需求

**状态**: 已批准
**优先级**: P1
**来源**: CP-0501-交付形态与部署支持.md
**最后更新**: 2025-12-17

## 1. 概述
本文档定义 TokMesh 服务的交付物形式以及在不同环境下的部署支持需求。

## 2. 交付物形态

### 2.1 二进制包
- **Linux/Windows** (amd64/arm64)。
- **静态链接**，无外部依赖。

### 2.2 容器镜像
- **基础镜像**: Distroless 或 Alpine。
- **体积限制**: 解压后大小 **< 100MB**。
- **配置**: 支持 `ENV` 覆盖 `config.yaml`。

### 2.3 配置管理
- **文件格式**: 首选 **YAML** (e.g., `config.yaml`)。
- **优先级**: 配置读取优先级以 `specs/1-requirements/RQ-0502-配置管理需求.md` 为准（**命令行参数 > 环境变量 > 配置文件 > 编译时默认值**）。
- **动态加载**: 
    - **通用配置**: 不支持热加载，变更需重启服务。
    - **TLS 证书**: **支持热加载**。系统应通过监听文件变更事件 (Inotify) 或 `SIGHUP` 信号，在不中断服务的情况下重新加载 `cert_file` 和 `key_file`，以支持证书自动轮转。
- **敏感配置**: 敏感信息 (如数据库密码、API Secret) 建议通过环境变量注入，避免硬编码或明文存储在配置文件中。

#### 2.3.1 配置结构参考

完整的配置文件结构、验证规则和默认值定义请参见：
**[RQ-0502-配置管理需求](./RQ-0502-配置管理需求.md)**

**配置分组概览**:
| 配置分组 | 说明 |
|----------|------|
| `server.*` | 服务端口配置 (HTTP/Redis) |
| `cluster.*` | 集群配置 (单机/分布式) |
| `session.*` | 会话 TTL 和配额 |
| `security.*` | TLS 和鉴权配置 |
| `storage.*` | WAL 和快照配置 |
| `telemetry.*` | 可观测性配置 |

## 3. 部署模式 (Deployment Modes)

### 3.1 单节点 (Standalone)
- **配置**: `cluster.enabled=false`，且 `cluster.discovery.seeds=[]`。
- **适用**: 开发、测试、小规模应用。
- **特性**: 无数据分片，无 Gossip 开销。

### 3.2 分布式集群 (Cluster)
- **配置**: `cluster.enabled=true`，且 `cluster.discovery.seeds` 填写种子节点地址列表。
- **适用**: 生产环境。
- **特性**: 自动开启一致性哈希分片、Gossip 发现、数据再平衡。
- **最小规模**: 生产环境建议 **3 节点** 起。

## 4. 验收标准 (Acceptance Criteria)

1.  **镜像体积**:
    - [ ] `docker images` 查看构建出的镜像，SIZE 列应小于 100MB。
2.  **配置注入**:
    - [ ] 使用 `ENV TOKMESH_SERVER_HTTP_ADDRESS=0.0.0.0:9999` 启动容器，服务应监听 9999 端口。
3.  **部署验证**:
    - [ ] 单节点模式下启动（`cluster.enabled=false`），日志不应出现“尝试加入集群/连接 seeds”等提示或错误。

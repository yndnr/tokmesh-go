# RQ-0403-可观测性需求

**状态**: 已批准
**优先级**: P0（Metrics/Logging），P2（Tracing 可选）
**来源**: CP-0402-系统可观测性.md
**最后更新**: 2025-12-18

## 1. 概述
本文档定义 TokMesh 服务必须具备的生产级可观测性需求：P0 包含监控指标、结构化日志与告警；分布式追踪为 P2 可选能力（默认不启用）。 

### 1.1 端口与端点

可观测性端点与管理 API 共用端口（默认 `5080`/`5443`），简化部署配置。详见 RQ-0304-管理接口规约.md。

| 端点 | 用途 | 鉴权 |
|------|------|------|
| `/metrics` | Prometheus 指标抓取 | 可配置（默认需要鉴权；如需无鉴权抓取必须显式配置 `telemetry.metrics.auth_enabled=false` 且确保仅内网可达） |
| `/health` | 存活探针 (Liveness) | 无 |
| `/ready` | 就绪探针 (Readiness) | 无 |

## 2. 分布式追踪 (Distributed Tracing)
本能力为 **P2 可选**（默认不启用、不引入 OpenTelemetry 依赖）。

若启用：
- **标准**: 支持 **OpenTelemetry Tracing**。
- **协议**: 使用 **OTLP (OpenTelemetry Protocol)**。
- **Exporter**: 支持 HTTP Exporter（gRPC Exporter 作为后续可选扩展）。
- **采集范围**:
  - 所有 Inbound HTTP 请求。
  - 所有 Outbound 集群内部请求（如节点间通信）。
  - 关键内部操作（如 Session 创建、Token 校验）。
- **Context 传递**: 正确传播 `traceparent`, `tracestate` 等 Trace Context。

## 3. 指标 (Metrics)

### 3.1 Prometheus 集成
- 端点: `GET /metrics`（管理/业务端口复用：默认 5080/5443）
- 前缀: `tokmesh_`
- 鉴权: 可配置，默认需要鉴权（减少信息暴露面）；仅 `role=metrics`（或 `role=admin`）可抓取。若确实需要无鉴权抓取，必须显式配置 `telemetry.metrics.auth_enabled=false` 且确保仅内网可达
  - 推荐（Prometheus 兼容）：`Authorization: Bearer <api_key>`
  - 兼容（CLI/调试）：`X-API-Key: <api_key>`
- 其中 `<api_key>` 的实际格式为 `<key_id>:<key_secret>`（例如 `<key_id>:<key_secret>`）

### 3.2 关键指标列表

#### 3.2.0 标签与基数约束（必须遵循）
为避免 Prometheus 指标出现高基数导致内存/存储爆炸，TokMesh 必须遵循：
- **禁止**将 `session_id`、`token`、`token_hash`、`user_id`、`api_key` 等高基数字段作为 label。
- HTTP 指标的 `path/route` 类 label 必须使用**路由模板**（例如 `/sessions/{session_id}`），不得使用实际路径（例如 `/sessions/tmss-...`）。

#### 3.2.1 核心业务
- `tokmesh_sessions_active_total`: 当前活跃会话总数。
- `tokmesh_token_validate_calls_total{result="valid|invalid|error"}`: 校验计数。
- `tokmesh_session_create_total`: 创建计数。
- `tokmesh_api_request_duration_seconds_bucket`: 延迟分布。

#### 3.2.2 集群健康
- `tokmesh_cluster_nodes_total{status="active|down"}`: **集群节点数**。
- `tokmesh_cluster_nodes_parity`: 节点奇偶性 (0=odd, 1=even)。
- `tokmesh_gossip_propagation_lag_seconds`: **Gossip 传播延迟估算**。
- `tokmesh_shard_keys_count{node_id}`: **分片数据分布** (用于检测倾斜)。
- `tokmesh_replication_lag_seconds`: 副本复制延迟 (Histogram/Gauge)，Label: `from_node`, `to_node`。
- `tokmesh_session_revoke_propagation_lag_seconds`: **会话吊销传播窗口** (Histogram)。用于衡量最终一致性吊销模式下，从“吊销提交”到“全节点可见不可用”的延迟分布。

#### 3.2.3 资源与存储
- `tokmesh_cpu_usage_ratio`: CPU。
- `tokmesh_mem_usage_bytes`: 内存。
- `tokmesh_wal_write_bytes_total`: WAL 写入量。

## 4. 日志 (Logging)
- **格式**: JSON Lines.
- **级别**: DEBUG/INFO/WARN/ERROR.

## 5. 告警规则 (Alerting Rules)

### 5.1 P0 (Critical) - 立即介入
- **WAL 写入失败**: `wal_fsync_failed_total` 计数器持续增长 (提示数据持久化可能存在问题)。
- **集群脑裂**: 集群节点间无法达成多数派 (Quorum lost)。
- **API Key 验证失败率**: 超过阈值 (e.g., 5% in 5min)。
- **存储空间不足**: 磁盘剩余空间低于 10%。

### 5.2 P1 (Warning) - 需关注
- **高延迟**: Token 校验 P99 > 100ms (持续 5m)。
- **资源告急**: 内存/CPU 使用率 > 85% (持续 5m)。
- **数据倾斜**: 节点间 Key 数量差异 > 30%。

## 6. 验收标准 (Acceptance Criteria)

1.  **指标暴露**:
    - [ ] 访问管理/业务端口 `/metrics` 能获取到上述所有指标。
    - [ ] 默认配置下 `/metrics` **需要鉴权**：未提供 API Key 必须被拒绝；提供 `role=metrics`（或 `role=admin`）Key 必须允许。
    - [ ] 显式配置 `telemetry.metrics.auth_enabled=false` 后，`/metrics` 可无鉴权访问（仅限内网/本机场景）。
2.  **健康检查**:
    - [ ] `/health` 返回 200 表示进程存活。
    - [ ] `/ready` 在存储和集群就绪后返回 200。
3.  **告警触发**:
    - [ ] 模拟停掉一个节点，`tokmesh_cluster_nodes_total` 指标应变化。
    - [ ] 模拟 API 报错，5xx 错误率指标应上升。

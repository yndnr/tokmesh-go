# RQ-0101-核心数据模型

**状态**: 已批准
**优先级**: P0
**来源**: CP-0101-核心愿景与架构.md, AD-0101-Token生成与存储策略.md, AD-0104-ID生成策略决策.md

## 1. 概述

本文档定义 TokMesh 服务的核心数据模型，包括 ID 命名规范、Session 实体结构和约束条件。这是所有上层接口和业务逻辑的基础。

> **相关文档**: 会话的生命周期管理（创建/校验/续期/吊销/过期）请参见 [RQ-0102-会话生命周期管理](./RQ-0102-会话生命周期管理.md)。

---

## 2. ID 命名规范 (ID Conventions)

为了提升系统的可识别性与安全性，所有由 TokMesh 生成的 ID 必须遵循以下格式：

**格式**: `tm<type><separator><body_string>`

- **前缀**: 固定为 `tm`。
- **Type**: **2位字母代码**，表示资源类型。
- **Separator (敏感度标记)**:
    - `-` (连字符): **Public (公开)**。可在日志、API 响应中安全展示。
    - `_` (下划线): **Sensitive (敏感)**。**严禁**在日志中打印明文，必须脱敏处理。
- **Body 生成算法** (详见 [AD-0104-ID生成策略决策](../adrs/AD-0104-ID生成策略决策.md)):
    - **标识符 (Identifier)**: 采用 **ULID** (小写 Crockford Base32)，26 字符，时间排序，便于索引和调试。
    - **凭证 (Credential)**: 采用 **32 字节 CSPRNG** (256 位熵)，确保最高安全性：
      - Token：Base64 RawURL 编码（43 字符）
      - API Secret：Base62 编码（约 43 字符）

### 2.1 类型代码表

| 资源类型 | 代码 | 分隔符 | 完整前缀 | Body 算法 | 总长度 | 说明 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **Session ID** | `ss` | `-` | `tmss-` | ULID (小写) | 31 字符 | 会话句柄，可公开引用 |
| **API Key ID** | `ak` | `-` | `tmak-` | ULID (小写) | 31 字符 | API Key 的公开标识 |
| **Node ID** | `nd` | `-` | `tmnd-` | 人工指定 / ULID | 可变 | 集群节点 ID，建议有意义命名 |
| **Token** | `tk` | `_` | `tmtk_` | 32B CSPRNG Base64 | 48 字符 | **极度敏感**，仅创建时返回一次 |
| **API Secret** | `as` | `_` | `tmas_` | 32B CSPRNG Base62 | ~48 字符 | **极度敏感**，仅创建时返回一次 |
| **Token Hash** | `th` | `_` | `tmth_` | SHA-256 Hex | 69 字符 | Token 哈希值，内部索引使用 |

### 2.2 大小写与归一化（强制，避免歧义）

为避免不同组件/Agent 在“是否改写大小写”上的口径不一致导致数据不匹配，本项目对大小写采用硬性约束：

1. **ULID 类标识符（Public）**：`tmss-`、`tmak-`、自动生成的 `tmnd-`
   - **规范输出**：必须为**全小写**（前缀与 body 均小写）。
   - **输入处理**：允许用户输入全大写/混合，但服务端/CLI 在解析时必须先做 `ToLower()` 归一化，再进行格式校验与后续比较/存储。

2. **十六进制哈希（Sensitive/内部）**：`tmth_`（TokenHash）
   - **规范输出**：必须为**全小写**（hex 小写）。
   - **输入处理**：允许输入全大写/混合，但解析时必须先 `ToLower()` 归一化，再校验/比较/存储。

3. **凭证字符串（Sensitive）**：`tmtk_`（Token）、`tmas_`（API Secret）
   - **大小写敏感**：大小写属于凭证内容的一部分。
   - **禁止改写**：实现层**禁止**对其做任何大小写转换（`ToLower/ToUpper`）；任何“统一大小写”都会改变值本身，导致校验与安全语义错误。

**示例**:
- Session ID: `tmss-01jf8xzm7e3xqh5p8n4r6s2w0t9`
- API Key ID: `tmak-01jf8y2k4m5nqp7r9s1w3x5z7a8`
- Node ID: `tmnd-prod-dc1-node01` (人工) 或 `tmnd-01jf8y3k5m6nqp8r0s2w4x6z8b9` (自动)
- Token: `tmtk_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijk`

---

## 3. 数据模型 (Data Models)

### 3.1 会话 (Session)

代表用户在某个设备或上下文中的登录状态。

| 字段名 | 类型 | 必填 | 说明 | 索引/约束 |
| :--- | :--- | :--- | :--- | :--- |
| `id` | string | **System** | 格式 `tmss-xxx`。 | 主键 |
| `user_id` | string | **Client** | 关联的用户 ID。 | 二级索引 |
| `token_hash` | string | **System** | **AD-0101-Token生成与存储策略.md**: 存储 `SHA-256(Token)` 的值，不存明文。 | 唯一索引 (用于校验) |
| `ip_address` | string | System | **创建时**的 IP 地址（不可变）。 | |
| `user_agent` | string | Client | **创建时**的 User-Agent（不可变）。 | |
| `last_access_ip` | string | System | **最后访问时**的 IP 地址。 | |
| `last_access_ua` | string | Client | **最后访问时**的 User-Agent。 | |
| `device_id` | string | Client | 设备唯一标识。 | 二级索引 |
| `created_by` | string | System | 创建此会话的 API Key ID。 | 二级索引 |
| `created_at` | int64 | System | 创建时间戳 (Unix MS)。 | 二级索引 |
| `expires_at` | int64 | System | 绝对过期时间戳。 | TTL 索引 |
| `last_active` | int64 | System | 最后访问时间。 | 二级索引 |
| `data` | map | Client | 扩展 KV 数据。 | |
| `version` | uint64 | **Internal** | 版本号，用于乐观锁。 | |
| `shard_id` | uint32 | **Internal** | 所属分片 ID，内部使用。 | |
| `ttl` | int64 | **Internal** | 缓存 TTL，内部使用。 | |
| `is_deleted` | bool | **Internal** | 逻辑删除标记，内部使用。 | |

### 3.2 Token 生成规则

- **算法**: 32 字节 CSPRNG 随机数
- **编码**: Base64 RawURL 编码 (A-Z, a-z, 0-9, -, _)
- **格式**: `tmtk_<43字符编码>`，**总长 48 字符**
- **存储**: 仅存储 `SHA-256(Token)` 哈希值，明文不落地

---

## 4. 约束条件 (Constraints)

为了保障系统稳定性，实施以下硬性限制：

### 4.1 字段长度限制

| 字段 | 最大长度 | 超限处理 |
|------|----------|----------|
| `user_id` | 128 chars | 拒绝请求 |
| `device_id` | 128 chars | 拒绝请求 |
| `user_agent` | 512 chars | 截断 |
| `last_access_ua` | 512 chars | 截断 |
| `data` 单个 Key | 64 chars | 拒绝请求 |
| `data` 单个 Value | 1024 chars | 拒绝请求 |
| `data` 总大小 | 4KB (序列化后) | 拒绝请求 |

### 4.2 配额限制 (Quotas)

| 配额项 | 默认值 | 一致性模型 |
|--------|--------|------------|
| **单用户最大会话数** | 50 个 | 单节点强一致 / 分布式最终一致 |
| **系统总容量** | 500 万 Session/节点 | - |

**分布式模式说明**:
- 为保证高性能，创建会话时不进行跨节点全局加锁计数
- 极端并发下用户会话数可能短暂突破限制（如达到 55/50）
- 系统通过 Gossip 同步和 Rebalancer 清理，在数秒至数分钟内收敛

---

## 5. 验收标准 (Acceptance Criteria)

### 5.1 ID 格式验证
- [ ] Session ID 格式为 `tmss-` + 26 字符小写 ULID，总长 31 字符
- [ ] API Key ID 格式为 `tmak-` + 26 字符小写 ULID，总长 31 字符
- [ ] Token 格式为 `tmtk_` + 43 字符 Base64 RawURL，总长 48 字符
- [ ] API Secret 格式为 `tmas_` + 约 43 字符 Base62
- [ ] ULID 满足时间排序特性（同一毫秒内单调递增）
- [ ] 日志中敏感 ID（含 `_` 分隔符）自动脱敏

### 5.2 数据模型验证
- [ ] Session 结构包含全部 17 个字段（13 个业务字段 + 4 个内部字段）
- [ ] `token_hash` 存储的是 SHA-256 哈希值，非明文

### 5.3 约束验证
- [ ] `data` 超过 4KB 返回 `TM-SESS-4001` 错误
- [ ] 单用户创建第 51 个会话触发配额限制
- [ ] 并发创建相同 Token 仅一个成功，其余返回冲突错误

# RQ-0304-管理接口规约

**状态**: 已批准
**优先级**: P1
**来源**: CP-0502-运维管理体系.md
**最后更新**: 2025-12-18

## 1. 概述
本文档定义 TokMesh 的**管理接口 (Admin API)**。这套接口主要供 CLI 工具 (`tokmesh-cli`) 和运维 Dashboard 使用，具有最高的权限等级。

## 2. 基础规范
- **管理端口**: 与业务端口复用，默认 `5080` (明文) / `5443` (TLS)。
- **Base URL**: `/admin/v1`
- **鉴权**: 必须使用 `role=admin` 的 API Key。
- **网络限制**: 默认仅绑定在 Localhost（回环地址）；如需对外暴露必须显式配置监听地址，并承担对应安全边界（防火墙/TLS/API Key/审计）。
- **HTTP 方法白名单**: 对外管理接口仅使用 `GET` / `POST`（避免中间设备剥离 `PATCH/DELETE` 导致运维动作不可达）

### 2.1 端点鉴权策略

管理端口上的端点按安全级别分层：

| 端点 | 鉴权要求 | 说明 |
|------|----------|------|
| `/admin/v1/*` | Admin API Key | 管理操作，需 admin 角色 |
| `/metrics` | 可配置 | Prometheus 抓取，默认**需要鉴权**（减少信息暴露面）；允许 `role=metrics`（或 `role=admin`）。推荐 `Authorization: Bearer <api_key>`；兼容 `X-API-Key: <api_key>`。如需无鉴权抓取必须显式关闭并确保仅内网可达。 |
| `/health` | 无鉴权 | 存活探针 (Liveness) |
| `/ready` | 无鉴权 | 就绪探针 (Readiness) |

> 说明：`<api_key>` 的实际格式为 `<key_id>:<key_secret>`（例如 `<key_id>:<key_secret>`）。两种 Header 携带的是同一串值，仅封装方式不同。

## 3. 接口列表

### 3.1 系统状态 (System Status)

#### 获取状态摘要
- **GET** `/admin/v1/status/summary`
- **Response**: 
    ```json
    {
      "code": "OK",
      "message": "Success",
      "request_id": "req-123456789",
      "timestamp": 1702400000000,
      "data": {
        "uptime_seconds": 3600,
        "total_sessions": 120500,
        "memory_usage_mb": 256,
        "current_qps": 1500,
        "cluster_state": "healthy"
      }
    }
    ```

#### 触发垃圾回收 (Manual GC)
- **POST** `/admin/v1/gc/trigger`
- **Response**:
  ```json
  {
    "code": "OK",
    "message": "Success",
    "request_id": "req-123456789",
    "timestamp": 1702400000000,
    "data": { "cleaned_count": 50, "duration_ms": 12 }
  }
  ```

### 3.2 API Key 管理 (Key Management)

#### 创建 Key
- **POST** `/admin/v1/keys`
- **Body**: `{ role: "metrics"|"validator"|"issuer"|"admin", description: "...", allowedlist: ["..."], rate_limit: 1000, expires_at: 1735689600000 }`
- **Response**: 
    ```json
    {
      "code": "OK",
      "message": "Success",
      "request_id": "req-123456789",
      "timestamp": 1702400000000,
      "data": {
        "key_id": "tmak-...",
        "key_secret": "tmas_...",
        "warning": "Security Warning: This key is valid for more than 1 year. Please consider a shorter rotation cycle." // 仅在长期Key时出现
      }
    }
    ```
    - **注意**: Secret 仅在创建时返回一次，之后不再可查询。
    - **allowedlist 组合规则**: 单 Key 的 `allowedlist` 与全局 `security.auth.allow_list` 同时存在时取交集（必须都命中才允许）。

#### 列出 Keys
- **GET** `/admin/v1/keys`
- **Query**: `page`, `size`
- **Response**: Key 列表 (不含 Secret)

#### 吊销/禁用 Key
- **POST** `/admin/v1/keys/{key_id}/status`
- **Body**: `{ status: "disabled" }`

#### 轮转 Secret
- **POST** `/admin/v1/keys/{key_id}/rotate`
- **Response**:
  ```json
  {
    "code": "OK",
    "message": "Success",
    "request_id": "req-123456789",
    "timestamp": 1702400000000,
    "data": { "new_key_secret": "tmas_..." }
  }
  ```

### 3.3 备份与恢复 (Backup & Restore)

#### 创建快照（生成 Snapshot 资源）
- **POST** `/admin/v1/backups/snapshots`
- **Response**: `data` 内返回 `{ snapshot_id, size, path, created_at }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

#### 列出快照
- **GET** `/admin/v1/backups/snapshots`
- **Query**: `page`, `size`
- **Response**: `data` 内返回 `{ items: [...], total_items: N }`

#### 下载备份
- **GET** `/admin/v1/backups/snapshots/{snapshot_id}/file`
- **Response**: 二进制流

#### 执行还原（创建 Restore Job 资源）
- **POST** `/admin/v1/backups/restores`
- **Body**: (以下两种方式选其一)
    1.  `{ snapshot_id: "snap-abc" }`（优先，生产推荐）：基于服务端已有快照触发还原任务
    2.  `multipart/form-data` 上传备份文件 (`.bak`)（调试/小规模场景）：服务端接收后写入临时文件并触发还原任务
        - **大小限制**: 默认 **100MB**；由 `server.http.max_body_size` 配置控制（见 `specs/1-requirements/RQ-0502-配置管理需求.md` 7.1.1）
        - **校验**: 必须包含有效的文件头签名 (Magic Bytes)
- **Response**: `data` 内返回 `{ status: "restoring", job_id: "..." }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

**运行期行为约束（避免语义漂移）**:
- 还原任务执行期间，服务必须进入“维护态”：
  - `/ready` 返回非就绪（例如 503），提示正在还原
  - 业务写操作必须拒绝并返回 `TM-ADMIN-5031`（服务不可用）
- 上传文件超限必须返回 `TM-ADMIN-4130`（HTTP 413），并提示改用 `{snapshot_id}` 方式还原

### 3.4 审计 (Audit)

#### 查询审计日志
- **GET** `/admin/v1/audit/logs`
- **Query**: `start_time`, `end_time`, `operator_id`, `page`
- **Response**: `data` 内返回 `{ logs: [...] }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

### 3.5 集群管理 (Cluster Management)

#### 查看节点列表
- **GET** `/admin/v1/cluster/nodes`
- **Response**: `[{ node_id, address, status, role, version }]`

#### 移除节点 (Force Leave)
- **POST** `/admin/v1/cluster/nodes/{node_id}/remove`

#### 节点重置 (Factory Reset)
- **POST** `/admin/v1/cluster/reset`
- **Body**: `{ force: true }`
- **描述**: **危险操作**。强制清空节点的 Cluster ID、Raft Log 和所有业务数据，使其恢复到未初始化状态。常用于脑裂后的节点回收或重新加入集群。
- **Response**: `{ status: "reset_initiated", message: "Node will restart..." }`

### 3.6 系统配置 (System Config)
*支持运行时热更新的配置*

- **GET** `/admin/v1/config`
- **POST** `/admin/v1/config/apply`
- **Body**: `{ telemetry: { logging: { level: "debug" } } }`

#### 配置验证（供 CLI/CI 使用）
- **POST** `/admin/v1/config/validate`
- **Body**: `{ config_yaml: "..." }`（或直接上传 YAML 文本；实现细节见 DS-0502）
- **Response**: `data` 内返回 `{ valid: true/false, errors: [...] }`（errors 内的 `code` 使用 `TM-CFG-*`，见 `specs/governance/error-codes.md`；响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

#### 触发热加载（仅支持热加载项）
- **POST** `/admin/v1/config/reload`
- **Response**: `data` 内返回 `{ updated: [...], ignored: [...] }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

### 3.7 备份/还原任务状态查询 (Backup/Restore Job Status)

#### 查询还原任务状态（按 job_id）
- **GET** `/admin/v1/backups/restores/{job_id}`
- **Response**: `data` 内返回 `{ status: "IDLE/RUNNING/FAILED", progress: 0-100, message: "...", snapshot_id: "...", started_at: ..., finished_at: ... }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

### 3.8 WAL 日志管理 (WAL Management)

#### 查看 WAL 日志
- **GET** `/admin/v1/wal/logs`
- **Query**:
    - `offset`: 开始位置（字节）。
    - `limit`: 读取长度（字节）。
    - `follow`: 是否持续跟踪新写入。
- **Response**: WAL 日志内容 (二进制流)。

#### 查看 WAL 状态
- **GET** `/admin/v1/wal/status`
- **Response**: `data` 内返回 `{ segments: 3, bytes: 123456789, last_offset: 987654 }`（响应 envelope 见 `specs/1-requirements/RQ-0301-业务接口规约-OpenAPI.md` 第 3 节）

### 3.9 可观测性端点 (Observability Endpoints)

> 注：这些端点与管理 API 共用端口（默认 5080/5443），但可配置独立的鉴权策略。详见 RQ-0403-可观测性需求.md。

#### 健康检查 (Health Check)
- **GET** `/health`
- **鉴权**: 无
- **Response**:
    ```json
    {
      "code": "OK",
      "message": "Success",
      "request_id": "req-123456789",
      "timestamp": 1702400000000,
      "data": { "status": "healthy" }
    }
    ```
- **说明**: 用于 K8s Liveness Probe，仅检查进程存活。

#### 就绪检查 (Readiness Check)
- **GET** `/ready`
- **鉴权**: 无
- **Response**:
    ```json
    {
      "code": "OK",
      "message": "Success",
      "request_id": "req-123456789",
      "timestamp": 1702400000000,
      "data": {
        "status": "ready",
        "checks": {
          "storage": "ok",
          "cluster": "ok"
        }
      }
    }
    ```
- **说明**: 用于 K8s Readiness Probe，检查服务是否可接受流量。

#### Prometheus 指标 (Metrics)
- **GET** `/metrics`
- **鉴权**: 可配置（默认需要鉴权；如需无鉴权抓取必须显式关闭并确保仅内网可达）
- **Response**: Prometheus 文本格式
- **说明**: 详细指标列表见 RQ-0403-可观测性需求.md。

## 4. 验收标准 (Acceptance Criteria)

1.  **鉴权**: 使用非 `role=admin` 的 Key 访问 `/admin/v1/*` 必须返回 403。
2.  **备份恢复**:
    - [ ] 上传非法的 `.txt` 文件作为备份还原，应被拒绝。
3.  **系统状态**:
    - [ ] `/status/summary` 返回的数据应与 Prometheus 指标一致。
4.  **可观测性端点**:
    - [ ] `/health` 无需鉴权即可访问，返回 200。
    - [ ] `/ready` 在服务就绪后返回 200，未就绪返回 503。
    - [ ] `/metrics` 默认需要鉴权：未提供 API Key 必须被拒绝；提供 `role=metrics`（或 `role=admin`）Key 必须允许。
    - [ ] 显式配置 `telemetry.metrics.auth_enabled=false` 后，`/metrics` 可无鉴权访问（仅限内网/本机场景）。

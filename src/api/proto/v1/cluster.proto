// Package v1 defines the cluster RPC protocol for TokMesh.
//
// This protocol is used for internal cluster communication only,
// using Connect + Protobuf over mTLS.

syntax = "proto3";

package tokmesh.cluster.v1;

option go_package = "github.com/yndnr/tokmesh-go/api/proto/v1;clusterv1";

// ClusterService defines the internal cluster control-plane RPC.
//
// This service MUST NOT be exposed externally.
// @design DS-0401
// @req RQ-0401
service ClusterService {
  // Join adds the node to the cluster.
  rpc Join(JoinRequest) returns (JoinResponse);

  // GetShardMap returns the current shard map snapshot.
  rpc GetShardMap(GetShardMapRequest) returns (GetShardMapResponse);

  // TransferShard streams shard migration data (rebalance).
  rpc TransferShard(stream TransferShardRequest) returns (TransferShardResponse);

  // Ping checks if a node is alive.
  rpc Ping(PingRequest) returns (PingResponse);
}

message JoinRequest {
  // NodeId is the unique node identifier.
  string node_id = 1;

  // AdvertiseAddress is the node endpoint reachable by peers (ip:port).
  string advertise_address = 2;

  // ClusterId is used to prevent accidental cross-cluster joins.
  string cluster_id = 3;
}

message JoinResponse {
  bool accepted = 1;
  string leader_node_id = 2;
  string leader_addr = 3;
  repeated Member members = 4;
  ShardMap shard_map = 5;
}

message GetShardMapRequest {
  string node_id = 1;
}

message GetShardMapResponse {
  ShardMap shard_map = 1;
  uint64 version = 2;
}

message TransferShardRequest {
  uint32 shard_id = 1;
  string session_id = 2;
  bytes session_data = 3;
}

message TransferShardResponse {
  bool success = 1;
  uint64 transferred_items = 2;
}

// PingRequest pings a node for health check.
message PingRequest {
  string node_id = 1;
  int64 timestamp = 2;
}

// PingResponse responds to ping.
message PingResponse {
  string node_id = 1;
  int64 timestamp = 2;
  bool is_leader = 3;
}

// Member represents a cluster member node.
message Member {
  string node_id = 1;
  string addr = 2;
  string state = 3;
  bool is_leader = 4;
}

// ShardMap represents the shard assignment mapping.
message ShardMap {
  map<uint32, string> shards = 1;
  map<uint32, ReplicaSet> replicas = 2;
  uint64 version = 3;
}

// ReplicaSet contains replica node IDs for a shard.
message ReplicaSet {
  repeated string node_ids = 1;
}
